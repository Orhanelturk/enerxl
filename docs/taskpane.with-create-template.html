<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EnerXL</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;background:#f8fafc;color:#0f172a;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .hint{position:fixed;bottom:10px;left:12px;font-size:12px;opacity:.6}
  </style>
  <!-- Office.js (CDN) -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
  <div>EnerXL task pane is loaded.</div>
  <div class="hint">Tip: Press Ctrl+Alt+R to hard-refresh the pane during development.</div>
  <script>
    // Dev hard-refresh (safe in prod; only runs on key combo)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === 'r') {
        const u = new URL(window.location.href);
        u.searchParams.set('v', Date.now());
        window.location.replace(u.toString());
      }
    });

    // Utility: ArrayBuffer -> Base64
    function arrayBufferToBase64(buffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const chunk = 0x8000;
      for (let i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    async function createSolarTemplate(event) {
      try {
        // Fetch the template workbook from your GitHub Pages site
        const templateUrl = "https://orhanelturk.github.io/enerxl/Book1.xlsx?v=2025.10.31-003";
        const resp = await fetch(templateUrl, { cache: "no-store" });
        if (!resp.ok) throw new Error("Failed to fetch template: " + resp.status);
        const buf = await resp.arrayBuffer();
        const base64 = arrayBufferToBase64(buf);

        await Excel.run(async (context) => {
          // Insert the 'System Summary' sheet from the template at the end
          context.workbook.insertWorksheetsFromBase64(base64, {
            sheetNamesToInsert: ["System Summary"],
            positionType: Excel.WorksheetPositionType.end
          });
          await context.sync();

          // Rename & activate
          const ws = context.workbook.worksheets.getItem("System Summary");
          ws.name = "Solar Template";
          ws.activate();
          await context.sync();
        });
      } catch (err) {
        console.error(err);
        // Optionally show a simple message in the pane
        const div = document.createElement('div');
        div.style.cssText = "position:fixed;top:10px;right:10px;background:#fee2e2;color:#991b1b;padding:8px 10px;border-radius:8px;";
        div.textContent = "Create Template failed: " + (err && err.message ? err.message : err);
        document.body.appendChild(div);
      } finally {
        // Always complete the event so ribbon unfreezes
        try { event.completed(); } catch(e) {}
      }
    }

    // Office entry point: associate command function
    Office.onReady(() => {
      if (Office.context.host) {
        Office.actions.associate("createSolarTemplate", createSolarTemplate);
      }
    });
  </script>
</body>
</html>
