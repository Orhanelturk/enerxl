<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EnerXL</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    html,body{height:100%;margin:0}
    body{display:grid;place-items:center;background:#f8fafc;color:#0f172a;
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .hint{opacity:.6;font-size:12px;margin-top:6px;text-align:center}
  </style>
</head>
<body>
  <div>
    <div id="msg">hello</div>
    <div id="hint" class="hint">checking updates…</div>
  </div>

  <script>
    (function(){
      const KEY = 'enerxl_build_version';
      const qs  = new URLSearchParams(location.search);
      const cur = qs.get('v') || '';
      const setHint = t => document.getElementById('hint').textContent = t;

      async function getBuild() {
        const r = await fetch('version.json?t=' + Date.now(), { cache: 'no-store' });
        if (!r.ok) throw new Error('version.json ' + r.status);
        const j = await r.json();
        return (j && j.build) ? String(j.build) : '';
      }

      async function ensureLatest(trigger) {
        try {
          const build = await getBuild();
          if (build && build !== cur) {
            localStorage.setItem(KEY, build);
            const u = new URL(location.href);
            u.searchParams.set('v', build);
            setHint('updating…');
            location.replace(u.toString()); // cache bust
            return;
          }
          setHint(trigger ? `up to date (${build||'n/a'})` : 'ready');
        } catch {
          setHint('offline / cannot check version');
        }
      }

      ensureLatest(false);
      setInterval(() => ensureLatest(true), 20000);
      window.addEventListener('focus', () => ensureLatest(true));
    })();
  </script>
</body>
</html>
