<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EnerXL</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <style>
    html,body{height:100%;margin:0}
    body{
      display:grid;place-items:center;
      background:#f8fafc;color:#0f172a;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial
    }
    .wrap{text-align:center}
    .hint{opacity:.6;font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="msg">hello</div>
    <div id="hint" class="hint">checking updates…</div>
  </div>

  <script>
    // ===== Auto-update without changing the manifest =====
    (function(){
      const REPO = "Orhanelturk/enerxl";      // <-- your GitHub repo (owner/name)
      const KEY  = "enerxl_last_sha";         // localStorage key
      const qs   = new URLSearchParams(location.search);
      const curV = qs.get("v") || "";         // current cache-busting tag from URL
      const hint = (t)=>{ document.getElementById("hint").textContent = t; };

      async function latestSHA() {
        // GitHub API (no auth needed up to ~60 req/hr per IP)
        const url = `https://api.github.com/repos/${REPO}/commits/main?cachebust=${Date.now()}`;
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error("GitHub API " + r.status);
        const j = await r.json();
        // handle object or array shapes defensively
        return (j && (j.sha || (Array.isArray(j) && j[0] && j[0].sha))) ? (j.sha || j[0].sha) : "";
      }

      async function fallbackVersion() {
        // Optional fallback if API blocked; serve docs/version.json from Pages
        try {
          const r = await fetch("version.json?t=" + Date.now(), { cache: "no-store" });
          if (!r.ok) return "";
          const j = await r.json();
          return (j && j.build) ? String(j.build) : "";
        } catch { return ""; }
      }

      async function ensureLatest(trigger) {
        try {
          let tag = "";
          try { tag = await latestSHA(); } catch { tag = await fallbackVersion(); }
          tag = (tag || "").toString().slice(0, 12);  // shorten SHA for readability

          if (tag && tag !== curV) {
            localStorage.setItem(KEY, tag);
            const u = new URL(location.href);
            u.searchParams.set("v", tag);
            hint("updating…");
            // Reload with new ?v= tag so Excel fetches fresh content
            location.replace(u.toString());
            return;
          }
          hint(trigger ? `up to date ${tag ? "(" + tag + ")" : ""}` : "ready");
        } catch (e) {
          hint("offline / cannot check version");
        }
      }

      // First check now
      ensureLatest(false);
      // Re-check periodically & when pane regains focus
      const POLL_MS = 20000; // 20s; adjust if you like
      setInterval(()=>ensureLatest(true), POLL_MS);
      window.addEventListener("focus", ()=>ensureLatest(true));
    })();
  </script>
</body>
</html>
