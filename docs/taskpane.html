<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
  html, body {
  margin: 0 !important;
  padding: 0 !important;
  overflow: hidden;
  background: transparent !important;
  height: 100%;
}
  body > div:first-child {
    margin-top: 0 !important;
  }
  #app, #map {
    position: absolute;
    inset: 0;
  }
</style>


<title>EnerXL Map</title>
<style>
  :root{
    --panel:#fff; --panel-border:#e6e8ee; --shadow:0 10px 30px rgba(0,0,0,.12);
    --icon:#2f3a55; --accent:#3a7afe; --accent-ghost:rgba(58,122,254,.12);
    --muted:#7f8aa3; --danger:#ef4444; --danger-sel:#ff7b7b; --select:#ffb703;
    --rowh:30px;
  }
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #app{position:relative;height:100vh;width:100vw;overflow:hidden}
  #map{position:absolute;inset:0}

  /* Utils */
  .hidden{display:none!important}

  /* Left rail */
  .control-pane{
    position:absolute;top:15px;left:15px;width:25px;padding:5px 8px;background:var(--panel);border:1px solid var(--panel-border);
    border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:10px;z-index:30;user-select:none
  }
  .tool-btn{
    width:30px;height:30px;border-radius:10px;border:1px solid #e9ecf3;display:grid;place-items:center;background:#fff;cursor:pointer;
    transition:transform .05s ease,background .15s ease,border-color .15s ease
  }
  .tool-btn:hover{background:#f0f3fb} .tool-btn:active{transform:scale(.98)}
  .tool-btn.is-primary{border-color:transparent;background:var(--accent-ghost)}
  .tool-btn svg{width:20px;height:20px;stroke:var(--icon)}
  .tool-btn.is-primary svg{stroke:var(--accent)}
  .group-sep{height:1px;width:100%;background:var(--panel-border);margin:6px 0}

  /* Search bubble */
  .search-wrap{
    position:absolute;top:15px;left:75px;z-index:26;background:#fff;border:1px solid var(--panel-border);
    border-radius:12px;box-shadow:var(--shadow);padding:6px 10px;align-items:center;gap:8px;min-width:280px;
    display:none; opacity:0; transform:scale(.97); transform-origin:left top; transition:opacity .12s ease, transform .12s ease;
  }
  .search-wrap.open{display:flex; opacity:1; transform:scale(1)}
  .search-wrap input{width:100%;outline:none;border:none;font-size:14px;padding:6px 2px;background:transparent;color:#1e2433}

  /* Drawer (tools) */
  .drawer{
    position:absolute;top:15px;left:75px;width:300px;background:#fff;border:1px solid var(--panel-border);
    border-radius:16px;box-shadow:var(--shadow);z-index:26;display:none;flex-direction:column;overflow:hidden;
    max-height:calc(100vh - 30px);
  }
  .drawer.open{display:flex}
  .drawer .hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--panel-border)}
  .drawer .ttl{font-weight:700;color:#1e2433;font-size:14px}
  .drawer .x{margin-left:auto;border:none;background:transparent;cursor:pointer;width:30px;height:30px;border-radius:8px}
  .bar{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--panel-border)}
  .seg{display:inline-flex;border:1px solid var(--panel-border);border-radius:10px;overflow:hidden}
  .seg button{font-size:13px;padding:7px 12px;border:none;background:#fff;color:#223;cursor:pointer}
  .seg button.active{background:var(--accent-ghost);color:var(--accent)}

  .body{
    padding:12px 12px;
    display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:6px;
    overflow:auto;
    max-height:calc(100vh - 180px);
  }
  .mini-btn{
    width:40px;height:40px;border-radius:12px;border:1px solid var(--panel-border);
    display:grid;place-items:center;background:#fff;cursor:pointer; position:relative;
  }
  .mini-btn svg{width:22px;height:22px;stroke:#2f3a55}
  .mini-btn.active{background:var(--accent-ghost);border-color:#cfe0ff}

  /* Small popovers */
  .popover{
    position:absolute;left:60px;top:0;background:#fff;border:1px solid var(--panel-border);border-radius:10px;
    box-shadow:var(--shadow);padding:8px;z-index:27;min-width:160px
  }
  .row{display:flex;align-items:center;gap:8px;margin:6px 0}
  .row label{font-size:12px;color:#334}
  .row input[type="number"]{width:70px;padding:4px 6px;border:1px solid #e5e7f2;border-radius:6px;font-size:12px}
  .row input[type="range"]{width:140px}
  .menu{display:flex;flex-direction:column;gap:4px}
  .menu button{font-size:12px;text-align:left;padding:6px 8px;border:1px solid #eef2ff;background:#fff;border-radius:8px;cursor:pointer}
  .menu button:hover{background:#f6f8ff}

  /* Summary -> collapse (open/close) */
  .summary{
    --colw: 88px; --hdrh: 32px;
    position:absolute;left:10px;bottom:10px;z-index:27;
    width:550px;background:#fff;border:1px solid var(--panel-border);
    border-radius:14px;box-shadow:var(--shadow);overflow:hidden;
  }
  .summary .sum-hdr{display:flex;align-items:center;gap:8px;padding:6px 8px;border-bottom:1px solid var(--panel-border);font-weight:700;color:#1e2433;background:#fff;font-size:12px;cursor:pointer;user-select:none}
  .summary .sum-hdr .chev{margin-left:auto;transition:transform .2s ease}
  .summary.collapsed .sum-hdr .chev{transform:rotate(180deg)}
  .summary.collapsed .sum-head,
  .summary.collapsed .tbl-wrap,
  .summary.collapsed .sum-foot{display:none}

  .sum-head,.tbl-wrap,.sum-foot{overflow:auto}
  .sum-head::-webkit-scrollbar,.sum-foot::-webkit-scrollbar{display:none}
  .sum-head,.sum-foot{scrollbar-width:none}
  .summary table{border-collapse:collapse;table-layout:fixed;font-size:11px;font-variant-numeric:tabular-nums;width:calc(var(--colw)*6)}
  .summary thead th{position:sticky;top:0;background:#fafbff;z-index:1}
  .summary th,.summary td{padding:6px 8px;border-bottom:1px solid #f0f2f7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .summary tfoot td{font-weight:700;background:#fafbff}
  .summary col.col{width:var(--colw)}
  .summary td.num,.summary th.num{text-align:right}
  .tbl-wrap{max-height:calc(var(--rowh)*5); overflow:auto;}
  .summary tbody tr{height:var(--rowh);}

  /* Name label (textbox) */
  .area-label{
    background:#fff;border:1px solid var(--panel-border);border-radius:8px;padding:2px 6px;
    box-shadow:0 2px 8px rgba(0,0,0,.08);font-size:12px;font-weight:600;color:#1e2433;white-space:nowrap;
    pointer-events:none;
  }

  /* Marquee */
  .marquee{position:absolute;border:1px dashed #1d4ed8;background:rgba(29,78,216,.12);pointer-events:none;z-index:1000}

  body.fs #map{inset:0}

  /* ================= PV LAYOUT SHEET ================= */
  .pv-sheet{
    position:absolute;top:15px;left:75px;
    width:300px;min-width:300px;max-width:300px;
    height:74vh;min-height:420px;max-height:calc(100vh - 30px);
    background:#fff;border:1px solid var(--panel-border);border-radius:16px;box-shadow:var(--shadow);
    display:none;flex-direction:column;z-index:28;resize:both;overflow:hidden;
  }
  .pv-sheet.open{display:flex}
  .pv-sheet .hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--panel-border)}
  .pv-sheet .ttl{font-weight:700;color:#1e2433;font-size:14px}
  .pv-sheet .x{margin-left:auto;border:none;background:transparent;cursor:pointer;width:30px;height:30px;border-radius:8px}
  .pv-sheet .content{flex:1 1 auto;overflow:auto;padding:10px 12px}
  .pv-section{margin:10px 0 16px}
  .pv-section h4{margin:0 0 8px;font-size:13px;color:#1e2433}
  .pv-grid{display:grid;grid-template-columns:1fr;gap:6px}
  .pv-field{display:flex;align-items:center;gap:8px;margin:6px 0}
  .pv-field label{font-size:12px;color:#334;min-width:110px}
  .pv-field input[type="number"], .pv-field input[type="text"], .pv-field select{
    width:100%;padding:6px 8px;border:1px solid #e5e7f2;border-radius:8px;font-size:12px
  }
  .pv-drop{border:1.5px dashed #cbd5e1;padding:10px;border-radius:12px;text-align:center;font-size:12px;color:#475569;background:#f8fafc}
  .pv-preview{border:1px solid var(--panel-border);border-radius:12px;padding:8px}
  .pv-preview canvas{width:100%;height:200px;display:block;background:#fff;border-radius:8px;box-shadow:inset 0 0 0 1px #f1f5f9}
  .pv-zoom{display:flex;align-items:center;gap:6px;margin-top:6px}
  .pv-zoom button{border:1px solid #cfe0ff;background:#fff;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
  .pv-caption{font-size:12px;color:#64748b}
  .pv-actions{display:flex;gap:8px;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid var(--panel-border);background:#fafbff}
  .pv-actions .right{display:flex;gap:8px}
  .btn{border:1px solid #cfe0ff;background:#f5f8ff;border-radius:8px;padding:7px 12px;font-size:12px;cursor:pointer}
  .btn.primary{background:#3a7afe;color:#fff;border-color:#2b6bf3}
  .btn.ghost{background:#fff}

  /* Catalog modal */
  .pv-modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; z-index:40;}
  .pv-modal{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:720px; max-width:95vw; max-height:85vh; background:#fff; border:1px solid var(--panel-border);
    border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;}
  .pv-modal .hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--panel-border)}
  .pv-modal .ttl{font-weight:700;color:#1e2433;font-size:14px}
  .pv-modal .x{margin-left:auto;border:none;background:transparent;cursor:pointer;width:30px;height:30px;border-radius:8px}
  .pv-modal .content{padding:12px; overflow:auto}
  .pv-catalog{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .pv-card{border:1px solid var(--panel-border);border-radius:12px;padding:10px;cursor:pointer;display:flex;gap:10px;align-items:center}
  .pv-card:hover{background:#f8fafc}
  .pv-card .ph{width:56px;height:40px;border-radius:6px;background:linear-gradient(135deg,#e5e7eb,#f3f4f6)}

  .pv-badge{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:6px;background:#eef2ff;color:#1d4ed8;font-size:10px;font-weight:600}
</style>
</head>
<body>
<div id="app">
  <div id="map" role="application" aria-label="Map"></div>

  <!-- Left rail -->
  <div class="control-pane" aria-label="Tools">
    <button class="tool-btn" data-tool="search" title="Search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
    </button>
    <button class="tool-btn" data-tool="tools" title="Tools" aria-label="Tools">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="3"/><path d="M3 10h18"/><path d="M7 7h.01M12 7h.01M17 7h.01"/></svg>
    </button>
    <button class="tool-btn" data-tool="pv" title="PV Layout" aria-label="PV Layout">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="6" width="18" height="10" rx="2"/><path d="M7 16l2 4m6-4l-2 4"/>
        <path d="M7 9h10M7 12h10"/>
      </svg>
    </button>

    <!-- Hidden (kept) -->
    <button class="tool-btn is-primary hidden" data-tool="select" title="Select/Edit" aria-label="Select">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l8 8"/><path d="M4 12V4h8"/><path d="M13 13l7 7"/></svg>
    </button>
    <button class="tool-btn hidden" data-tool="draw" title="Draw" aria-label="Draw">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7l6-3 6 3 0 7-6 3-6-3z"/></svg>
    </button>

    <div class="group-sep hidden"></div>
    <button class="tool-btn hidden" data-tool="export" title="Export" aria-label="Export">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 9l4 4 4-4"/><path d="M20 21H4"/></svg>
    </button>
    <button class="tool-btn hidden" data-tool="settings" title="Settings" aria-label="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a2 2 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09z"/></svg>
    </button>
  </div>

  <!-- Search -->
  <div class="search-wrap" id="search-wrap" aria-expanded="false">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7f8aa3" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>
    </svg>
    <input id="search-input" type="text" placeholder="Search locationâ€¦" aria-label="Search location" />
  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer" role="dialog" aria-modal="false" aria-label="Tools drawer">
    <div class="hdr">
      <div class="ttl">Draw PV Area</div>
      <button class="x" data-close-drawer title="Close" aria-label="Close">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#7f8aa3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <div class="bar">
      <div class="seg" id="seg-category">
        <button data-cat="area" class="active" title="PV Area">PV area</button>
        <button data-cat="constraint" title="Constraint">Constraint</button>
        <button data-cat="object" title="Objects">Objects</button>
      </div>
      <div></div>
    </div>

    <div class="body">
      <!-- Shapes -->
      <button class="mini-btn" id="shape-poly"   title="Polygon"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7l6-3 6 3 0 7-6 3-6-3z"/></svg></button>
      <button class="mini-btn" id="shape-rect"   title="Rectangle"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="6" width="16" height="12" rx="2"/></svg></button>
      <button class="mini-btn" id="shape-circle" title="Circle"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="7"/></svg></button>

      <!-- Existing edit -->
      <button class="mini-btn" id="act-select"    title="Select/Edit"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l8 8"/><path d="M4 12V4h8"/><path d="M13 13l7 7"/></svg></button>
      <button class="mini-btn" id="act-move"      title="Move (toggle)"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/><path d="M8 6l4-4 4 4M8 18l4 4 4-4M6 8l-4 4 4 4M18 8l4 4-4 4"/></svg></button>
      <button class="mini-btn" id="act-marquee"   title="Marquee (toggle)"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="6" width="16" height="12" rx="1"/><path d="M7 6v-2M11 6v-2M15 6v-2"/></svg></button>

      <!-- Selection tools -->
      <button class="mini-btn" id="act-multisel"  title="Multi-select latch"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h8v8H8z"/><path d="M4 10h8v8H4z"/><path d="M12 4h8v8h-8z"/></svg></button>
      <button class="mini-btn" id="act-copy"      title="Copy"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="10" height="10" rx="2"/><rect x="5" y="5" width="10" height="10" rx="2"/></svg></button>
      <button class="mini-btn" id="act-paste"     title="Paste (click to place)"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 4h8l2 2v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V6l2-2z"/><path d="M9 9h6M9 13h6"/></svg></button>
      <button class="mini-btn" id="act-delete"    title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6l1-2h6l1 2"/></svg></button>

      <!-- Rotate / Align / Distribute / Grid -->
      <button class="mini-btn" id="act-rotate" title="Rotate">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg>
      </button>
      <div id="pop-rotate" class="popover" style="display:none">
        <div class="row">
          <label style="width:40px">Deg</label>
          <input id="rotate-range" type="range" min="-180" max="180" step="1" value="0">
          <span id="rotate-deg" style="font-size:12px;color:#334;width:34px;text-align:right">0Â°</span>
        </div>
      </div>

      <button class="mini-btn" id="act-align"  title="Align">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><rect x="7" y="8" width="10" height="6" rx="1"/><path d="M3 18h18"/></svg>
      </button>
      <div id="pop-align" class="popover" style="display:none">
        <div class="menu">
          <button data-align="top">Align Top</button>
          <button data-align="bottom">Align Bottom</button>
          <button data-align="left">Align Left</button>
          <button data-align="right">Align Right</button>
        </div>
      </div>

      <button class="mini-btn" id="act-distribute" title="Distribute">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M3 12h18M3 18h18"/><rect x="7" y="8" width="3" height="8" rx="1"/><rect x="14" y="8" width="3" height="8" rx="1"/></svg>
      </button>
      <div id="pop-distribute" class="popover" style="display:none">
        <div class="menu">
          <button data-distribute="horizontal">Distribute Horizontally</button>
          <button data-distribute="vertical">Distribute Vertically</button>
        </div>
      </div>

      <button class="mini-btn" id="act-grid" title="Draw Grid">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"/><path d="M9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
      </button>
      <div id="pop-grid" class="popover" style="display:none">
        <div class="row"><label>Cols</label><input id="grid-cols" type="number" min="1" value="3"></div>
        <div class="row"><label>Rows</label><input id="grid-rows" type="number" min="1" value="2"></div>
        <div class="row"><label>Space X (m)</label><input id="grid-sx" type="number" min="0" value="5"></div>
        <div class="row"><label>Space Y (m)</label><input id="grid-sy" type="number" min="0" value="5"></div>
        <div class="row" style="justify-content:flex-end">
          <button id="grid-apply" class="btn">Apply</button>
        </div>
      </div>

      <!-- Objects & Setbacks (inputs retained) -->
      <div style="grid-column:1/-1;margin-top:6px;font-weight:700;color:#1e2433">Objects & Setbacks</div>

      <button class="mini-btn" id="act-setback" title="Area Setback">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 20V8l8-5 8 5v12H4z"/><path d="M8 12h8M8 16h8"/>
        </svg>
      </button>
      <div id="pop-setback" class="popover" style="display:none">
        <div class="row"><label>Setback (m)</label><input id="in-setback-boundary" type="number" min="0" value="1"></div>
        <div class="row" style="font-size:12px;color:#667085;line-height:1.2">Simple fill ignores setbacks in this version.</div>
      </div>

      <button class="mini-btn" id="act-roads" title="Roads">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 20L10 4h4l4 16"/><path d="M12 8v2M12 14v2"/>
        </svg>
      </button>
      <div id="pop-roads" class="popover" style="display:none;min-width:220px">
        <div class="row"><label>Width (m)</label><input id="road-width" type="number" min="1" value="4"></div>
        <div class="row"><label>Setback (m)</label><input id="road-setback" type="number" min="0" value="1"></div>
        <div class="row" style="gap:6px;flex-wrap:wrap">
          <button id="road-free"  class="btn" disabled>Free drawing</button>
          <button id="road-perim" class="btn" disabled>Perimeter</button>
        </div>
        <div class="row">
          <label style="min-width:88px">Horizontal #</label>
          <input id="road-h-n" type="number" min="1" value="2" disabled>
          <button id="road-h-apply" class="btn" style="margin-left:auto" disabled>Make</button>
        </div>
        <div class="row">
          <label style="min-width:88px">Vertical #</label>
          <input id="road-v-n" type="number" min="1" value="2" disabled>
          <button id="road-v-apply" class="btn" style="margin-left:auto" disabled>Make</button>
        </div>
        <div class="row" style="font-size:12px;color:#667085;line-height:1.2">Road/object avoidance is not applied in this simple fill.</div>
      </div>

      <button class="mini-btn" id="act-building" title="Building (rectangle)" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <rect x="4" y="4" width="16" height="16" rx="2"/>
          <path d="M8 8h.01M12 8h.01M16 8h.01M8 12h8M8 16h8"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Summary (collapse) -->
  <div id="summary" class="summary" aria-live="polite" aria-expanded="true">
    <div class="sum-hdr" id="sum-toggle">Summary
      <svg class="chev" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#7f8aa3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
    </div>
    <div class="sum-head" id="sum-head">
      <table>
        <colgroup>
          <col class="col"><col class="col"><col class="col"><col class="col"><col class="col"><col class="col">
        </colgroup>
        <thead>
          <tr>
            <th>Area Name</th>
            <th class="num">DC Capacity</th>
            <th class="num">AC Capacity</th>
            <th class="num">Area</th>
            <th class="num">Tilt</th>
            <th class="num">Azimuth</th>
          </tr>
        </thead>
      </table>
    </div>
    <div class="tbl-wrap" id="sum-bodywrap">
      <table>
        <colgroup>
          <col class="col"><col class="col"><col class="col"><col class="col"><col class="col"><col class="col">
        </colgroup>
        <tbody id="sum-body">
          <tr><td colspan="6" class="muted" style="padding:12px 10px">No areas yet</td></tr>
        </tbody>
      </table>
    </div>
    <div class="sum-foot" id="sum-foot">
      <table>
        <colgroup>
          <col class="col"><col class="col"><col class="col"><col class="col"><col class="col"><col class="col">
        </colgroup>
        <tfoot>
          <tr>
            <td>Total</td>
            <td id="tot-dc" class="num">0</td>
            <td id="tot-ac" class="num">0</td>
            <td id="tot-m2" class="num">0</td>
            <td class="num"></td>
            <td class="num"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- ================= PV LAYOUT SHEET CONTENT ================= -->
  <div id="pv-sheet" class="pv-sheet" role="dialog" aria-modal="false" aria-label="PV Layout">
    <div class="hdr">
      <div class="ttl">PV Layout</div>
      <button class="x" id="pv-close" title="Close" aria-label="Close">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#7f8aa3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="content">
      <!-- Section 1 -->
      <div class="pv-section">
        <h4>1) Select PV Module</h4>
        <div class="pv-field">
          <label>Library</label>
          <select id="pv-lib">
            <option value="">â€” Select a module â€”</option>
            <option value="GEN600" selected>Generic 600 Wp â€” 2100Ã—1134 mm</option>
            <option value="GEN550">Generic 550 Wp â€” 2094Ã—1134 mm</option>
            <option value="GEN450">Generic 450 Wp â€” 1960Ã—992 mm</option>
          </select>
        </div>

        <details id="pv-custom" style="margin-top:6px">
          <summary class="pv-caption" style="cursor:pointer">Define custom module</summary>
          <div class="pv-grid" style="margin-top:8px">
            <div class="pv-field"><label>Name</label><input id="md-name" type="text" value="Custom 600 Wp"></div>
            <div class="pv-field"><label>STC Power (Wp)</label><input id="md-pwr" type="number" min="1" value="600"></div>
            <div class="pv-field"><label>Length (mm)</label><input id="md-len" type="number" min="1" value="2100"></div>
            <div class="pv-field"><label>Width (mm)</label><input id="md-wid" type="number" min="1" value="1134"></div>
            <div class="pv-field"><label>Thickness (mm)</label><input id="md-thk" type="number" min="1" value="35"></div>
          </div>
          <div class="pv-field" style="align-items:flex-start;margin-top:6px">
            <label>PAN file</label>
            <div class="pv-drop" style="width:100%">
              Drag & drop *.PAN here or
              <button type="button" class="btn ghost" id="pv-pan-browse">Browse</button>
              <input id="pv-pan-input" type="file" accept=".pan,.PAN" style="display:none">
              <div class="pv-caption" id="pv-pan-name" style="margin-top:6px">No file selected</div>
            </div>
          </div>
        </details>

        <div class="pv-grid" style="margin-top:8px">
          <div class="pv-field" style="grid-column:1/-1">
            <label style="min-width:auto;white-space:nowrap;margin-right:6px">
              <input type="radio" name="pv-target" value="cap"> Desired DC capacity (kWp)
            </label>
            <input id="pv-target-kwp" type="number" min="1" value="1000" style="max-width:140px">
          </div>
          <div class="pv-field" style="grid-column:1/-1">
            <label style="min-width:auto;white-space:nowrap">
              <input type="radio" name="pv-target" value="fill" checked> Fill maximum area
            </label>
          </div>
        </div>
      </div>

      <!-- Section 2 -->
      <div class="pv-section">
        <h4>2) Mounting Structure</h4>
        <div class="pv-field" style="flex-direction:column;align-items:flex-start">
          <div style="display:flex;align-items:center;gap:8px;width:100%">
            <label style="min-width:110px">Structure catalog</label>
            <button type="button" class="btn" id="open-catalog">Open Catalogâ€¦</button>
          </div>
          <div class="pv-caption" id="struct-picked" style="margin-top:6px;width:100%">Ground â€” Fixed Tilt</div>
        </div>

        <div class="pv-grid" style="margin-top:10px">
          <div class="pv-field"><label>Tilt (Â°)</label><input id="tilt" type="number" min="0" max="60" value="10"></div>
          <div class="pv-field"><label>Azimuth (Â°)</label><input id="azimuth" type="number" min="0" max="360" value="180"></div>

          <div>
            <div class="pv-field">
              <label>Module Orientation</label>
              <div class="seg" id="pv-orient" style="border-radius:10px;border:1px solid var(--panel-border);overflow:hidden">
                <button type="button" data-val="portrait" class="active" style="border:none;background:#fff;padding:6px 10px;font-size:12px;cursor:pointer">Portrait</button>
                <button type="button" data-val="landscape" style="border:none;background:#fff;padding:6px 10px;font-size:12px;cursor:pointer">Landscape</button>
              </div>
            </div>

            <!-- Group By -->
            <div class="pv-field">
              <label>Group By</label>
              <div id="pv-group" style="display:flex;align-items:center;gap:12px">
                <label style="min-width:auto;display:inline-flex;align-items:center;gap:6px">
                  <input id="gb-tables" type="checkbox" checked> Tables
                </label>
                <label style="min-width:auto;display:inline-flex;align-items:center;gap:6px">
                  <input id="gb-blocks" type="checkbox" checked> Block
                </label>
              </div>
            </div>

            <div class="pv-field"><label>PV / Table (X)</label><input id="pv-h" type="number" min="1" value="2"></div>
            <div class="pv-field"><label>PV / Table (Y)</label><input id="pv-v" type="number" min="1" value="3"></div>

            <div class="pv-field"><label>Tables / Block (H)</label><input id="tab-per-blk-h" type="number" min="1" value="6"></div>
            <div class="pv-field"><label>Tables / Block (V)</label><input id="tab-per-blk-v" type="number" min="1" value="4"></div>

            <div class="pv-field"><label>Module gap X (m)</label><input id="gap-mod-x" type="number" min="0" step="0.05" value="0.02"></div>
            <div class="pv-field"><label>Module gap Y (m)</label><input id="gap-mod-y" type="number" min="0" step="0.05" value="0.02"></div>
            <div class="pv-field"><label>Table gap X (m)</label><input id="gap-tab-x" type="number" min="0" step="0.1" value="0.5"></div>
            <div class="pv-field"><label>Table gap Y (m)</label><input id="gap-tab-y" type="number" min="0" step="0.1" value="1.5"></div>
            <div class="pv-field"><label>Block gap X (m)</label><input id="gap-blk-x" type="number" min="0" step="0.1" value="3"></div>
            <div class="pv-field"><label>Block gap Y (m)</label><input id="gap-blk-y" type="number" min="0" step="0.1" value="4"></div>
          </div>

          <details id="pv-arrange" style="grid-column:1/-1;margin-top:6px">
            <summary class="pv-caption" style="cursor:pointer">Tables arrangement view</summary>
            <div class="pv-preview" style="margin-top:6px">
              <canvas id="pv-preview" width="300" height="200" aria-label="Layout preview"></canvas>
              <div class="pv-zoom">
                <button type="button" id="pv-zoom-out">âˆ’</button>
                <input type="range" id="pv-zoom" min="0.5" max="20" step="0.05" value="1" style="flex:1">
                <button type="button" id="pv-zoom-in">+</button>
              </div>
              <div class="pv-caption" id="pv-preview-meta" style="margin-top:6px">Table: â€” | Est. kWp/table: â€” | Block: â€” tables</div>
            </div>
          </details>
        </div>
      </div>

      <!-- Section 3 -->
      <div class="pv-section">
        <h4>3) Orientation & Fill</h4>
        <div class="pv-grid">
          <div class="pv-field">
            <label>Align to edge</label>
            <button id="align-edge" class="btn">Pick edge on map</button>
            <span class="pv-caption" id="edge-help" style="margin-left:6px;display:none">Click an area edgeâ€¦</span>
          </div>

          <div class="pv-field"><label>Fill start</label>
            <select id="fill-start">
              <option>East</option><option>West</option><option>North</option><option>South</option><option>Middle</option>
            </select>
          </div>
          <div class="pv-field"><label>Method</label>
            <div class="seg" id="fill-method" style="border-radius:10px;border:1px solid var(--panel-border);overflow:hidden">
              <button type="button" data-val="adaptive" class="active" style="border:none;background:#fff;padding:6px 10px;font-size:12px;cursor:pointer">Adaptive</button>
              <button type="button" data-val="block" style="border:none;background:#fff;padding:6px 10px;font-size:12px;cursor:pointer">Block</button>
            </div>
          </div>
          <div class="pv-field">
            <label>Show modules</label>
            <input id="show-modules" type="checkbox" checked>
            <span class="pv-caption">Simple fill always draws modules.</span>
          </div>
        </div>
      </div>
    </div>

    <div class="pv-actions">
      <div></div>
      <div class="right">
        <button id="pv-lock" class="btn" data-state="locked">Unlock editing</button>
        <button id="pv-build" class="btn primary">Build initial layout</button>
      </div>
    </div>
  </div>

  <!-- Catalog modal -->
  <div id="pv-cat-backdrop" class="pv-modal-backdrop" aria-hidden="true">
    <div class="pv-modal" role="dialog" aria-label="Mounting Structure Catalog">
      <div class="hdr">
        <div class="ttl">Select Mounting Structure</div>
        <button class="x" id="pv-cat-close" title="Close">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#7f8aa3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="content">
        <div class="pv-catalog" id="pv-catalog">
          <div class="pv-card" data-struct="ground-fixed"><div class="ph"></div><div>Ground â€” Fixed Tilt</div></div>
          <div class="pv-card" data-struct="ground-tracker"><div class="ph"></div><div>Ground â€” Single Axis</div></div>
          <div class="pv-card" data-struct="roof-flush"><div class="ph"></div><div>Rooftop â€” Flush</div></div>
          <div class="pv-card" data-struct="roof-triangle"><div class="ph"></div><div>Rooftop â€” Triangle</div></div>
          <div class="pv-card" data-struct="roof-ballasted"><div class="ph"></div><div>Rooftop â€” Ballasted</div></div>
          <div class="pv-card" data-struct="carport"><div class="ph"></div><div>Specialty â€” Carport</div></div>
          <div class="pv-card" data-struct="canopy"><div class="ph"></div><div>Specialty â€” Solar Canopy</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="./drawing.js"></script>

<script>

  Office.onReady(() => {
  const pane = document.body.parentElement;
  if (pane && pane.style) {
    pane.style.marginTop = '0px';
    pane.style.paddingTop = '0px';
    pane.style.background = 'transparent';
  }
});
</script>
<script>






  window.initMap = function(){
    const START = { lat: 38.397550221066616, lng: 34.97863102806574 };
    const map = new google.maps.Map(document.getElementById('map'), {
      center: START, zoom: 17, mapTypeId: 'satellite',
      mapTypeControl: false, fullscreenControl: false, streetViewControl: false, zoomControl: false,gestureHandling: 'greedy',
scrollwheel: true
    });
    window._map = map; window._google = google;



    try {
  const iframe = window.frameElement;
  if (iframe) {
    iframe.setAttribute("allow", "geolocation *; microphone *; camera *; fullscreen *; clipboard-read *; clipboard-write *; display-capture *");
    iframe.style.touchAction = "auto";
    iframe.style.pointerEvents = "auto";
  }
} catch (e) {
  console.warn("iframe permission patch skipped:", e);
}


    const fsWrap=document.createElement('div'); fsWrap.style.margin='10px';
    const fsBtn=document.createElement('button');
    Object.assign(fsBtn.style,{
      width:'40px',height:'40px',borderRadius:'9999px',border:'1px solid #e6e8ee',
      background:'#fff',boxShadow:'0 2px 6px rgba(0,0,0,.2)',display:'grid',placeItems:'center',
      cursor:'pointer',padding:0
    });
    fsBtn.title='Full screen';
    fsBtn.innerHTML=`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#2f3a55" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3H3v6M15 3h6v6M9 21H3v-6M21 15v6h-6"/></svg>`;
    fsBtn.onclick=async()=>{
      const root=document.documentElement;
      if(!document.fullscreenElement&&root.requestFullscreen){try{await root.requestFullscreen();}catch(e){}}
      else if(document.fullscreenElement&&document.exitFullscreen){try{await document.exitFullscreen();}catch(e){}}
      google.maps.event.trigger(map,'resize');
    };
    fsWrap.appendChild(fsBtn);
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(fsWrap);

    const input=document.getElementById('search-input');
    const ac=new google.maps.places.Autocomplete(input,{fields:['geometry','name']});
    ac.bindTo('bounds',map);
    ac.addListener('place_changed',()=>{const p=ac.getPlace(); if(!p.geometry?.location)return; map.panTo(p.geometry.location); map.setZoom(17); new google.maps.Marker({map,position:p.geometry.location});});

    if (typeof window.mountDrawing === 'function') {
      window.mountDrawing({ google, map, document });
    } else {
      console.error('mountDrawing is not available; make sure drawing.js is loaded');
    }
  };
</script>

<script>
(function(){
  const drawer = document.getElementById('drawer');
  const pvBtn = document.querySelector('[data-tool="pv"]');
  const toolsBtn = document.querySelector('[data-tool="tools"]');
  const searchBtn = document.querySelector('[data-tool="search"]');
  const searchWrap = document.getElementById('search-wrap');

  const pvSheet = document.getElementById('pv-sheet');
  const pvClose = document.getElementById('pv-close');
  const panBrowse = document.getElementById('pv-pan-browse');
  const panInput = document.getElementById('pv-pan-input');
  const panName = document.getElementById('pv-pan-name');

  const catBackdrop = document.getElementById('pv-cat-backdrop');
  const catClose = document.getElementById('pv-cat-close');
  const openCatalog = document.getElementById('open-catalog');
  const catGrid = document.getElementById('pv-catalog');
  const structPicked = document.getElementById('struct-picked');

  const pvLib = document.getElementById('pv-lib');
  const mdName = document.getElementById('md-name');
  const mdPwr  = document.getElementById('md-pwr');
  const mdLen  = document.getElementById('md-len');
  const mdWid  = document.getElementById('md-wid');
  const pvH = document.getElementById('pv-h');
  const pvV = document.getElementById('pv-v');
  const tpbH = document.getElementById('tab-per-blk-h');
  const tpbV = document.getElementById('tab-per-blk-v');
  const orientSeg = document.getElementById('pv-orient');

  const gbTables = document.getElementById('gb-tables');
  const gbBlocks = document.getElementById('gb-blocks');

  const gapModX = document.getElementById('gap-mod-x');
  const gapModY = document.getElementById('gap-mod-y');
  const gapTabX = document.getElementById('gap-tab-x');
  const gapTabY = document.getElementById('gap-tab-y');
  const gapBlkX = document.getElementById('gap-blk-x');
  const gapBlkY = document.getElementById('gap-blk-y');
  const tilt = document.getElementById('tilt');
  const azimuth = document.getElementById('azimuth');
  const edgeMode = document.getElementById('edge-mode'); // kept for compatibility
  const fillStart = document.getElementById('fill-start');
  const fillMethod = document.getElementById('fill-method');
  const targetKwp = document.getElementById('pv-target-kwp');
  const showModules = document.getElementById('show-modules');
  const pvBuild = document.getElementById('pv-build');
  const pvLock = document.getElementById('pv-lock');

  const alignEdgeBtn = document.getElementById('align-edge');
  const edgeHelp = document.getElementById('edge-help');

  const canvas = document.getElementById('pv-preview');
  const ctx = canvas.getContext('2d');
  const meta = document.getElementById('pv-preview-meta');
  const zoom = document.getElementById('pv-zoom');
  const zoomIn = document.getElementById('pv-zoom-in');
  const zoomOut = document.getElementById('pv-zoom-out');
  let previewScale = 1;
  let panX = 0, panY = 0;
  let dragging = false, dragStartX = 0, dragStartY = 0;
  const arrangeDetails = document.getElementById('pv-arrange'); // *** single declaration ***

  function updateTargetControls(){
    const mode = document.querySelector('input[name="pv-target"]:checked')?.value;
    if (mode === 'cap'){
      targetKwp.disabled = false;
    } else {
      targetKwp.disabled = true;
    }
  }
  document.querySelectorAll('input[name="pv-target"]').forEach(r=>r.addEventListener('change', updateTargetControls));
  updateTargetControls();

  function closeDrawer(){ drawer?.classList.remove('open'); }
  function closeSearch(){ searchWrap?.classList.remove('open'); searchWrap?.setAttribute('aria-expanded','false'); }

  pvBtn?.addEventListener('click', ()=>{
    const willOpen = !pvSheet.classList.contains('open');
    if (willOpen){ closeDrawer(); closeSearch(); }
    pvSheet.classList.toggle('open');
    if (pvSheet.classList.contains('open')) { setTimeout(fitCanvasToContainer, 50); }
  });
  pvClose?.addEventListener('click', ()=> pvSheet.classList.remove('open'));
  toolsBtn?.addEventListener('click', ()=> pvSheet.classList.remove('open'));
  searchBtn?.addEventListener('click', ()=> pvSheet.classList.remove('open'));

  panBrowse?.addEventListener('click', ()=> panInput?.click());
  panInput?.addEventListener('change', ()=>{ if(panName) panName.textContent = panInput.files?.[0]?.name || 'No file selected'; });

  orientSeg?.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      orientSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      drawPreview();
    });
  });

  const presets = {
    GEN600:{ name:'Generic 600 Wp', pwr:600, len:2100, wid:1134 },
    GEN550:{ name:'Generic 550 Wp', pwr:550, len:2094, wid:1134 },
    GEN450:{ name:'Generic 450 Wp', pwr:450, len:1960, wid:992 },
  };
  pvLib?.addEventListener('change', ()=>{
    const p = presets[pvLib.value];
    if (p){ mdName.value=p.name; mdPwr.value=p.pwr; mdLen.value=p.len; mdWid.value=p.wid; drawPreview(); }
  });

  const structDefaults = {
    'ground-fixed':  { name:'Ground â€” Fixed Tilt', tilt:20, azimuth:180, pvH:2, pvV:3, tabX:0.6, tabY:1.6, blkX:3.0, blkY:4.0, tpbH:6, tpbV:4, orient:'portrait' },
    'ground-tracker':{ name:'Ground â€” Single Axis', tilt:0,  azimuth:180, pvH:2, pvV:2, tabX:0.6, tabY:5.0, blkX:4.0, blkY:8.0, tpbH:8, tpbV:2, orient:'landscape' },
    'roof-flush':    { name:'Rooftop â€” Flush',      tilt:10, azimuth:180, pvH:2, pvV:3, tabX:0.4, tabY:0.6, blkX:1.0, blkY:1.2, tpbH:5, tpbV:3, orient:'portrait' },
    'roof-triangle': { name:'Rooftop â€” Triangle',   tilt:15, azimuth:180, pvH:2, pvV:3, tabX:0.4, tabY:0.8, blkX:1.2, blkY:1.2, tpbH:5, tpbV:3, orient:'portrait' },
    'roof-ballasted':{ name:'Rooftop â€” Ballasted',  tilt:10, azimuth:180, pvH:2, pvV:3, tabX:0.4, tabY:0.7, blkX:1.0, blkY:1.0, tpbH:4, tpbV:3, orient:'portrait' },
    'carport':       { name:'Specialty â€” Carport',  tilt:5,  azimuth:180, pvH:2, pvV:4, tabX:0.7, tabY:3.0, blkX:3.0, blkY:4.0, tpbH:4, tpbV:2, orient:'portrait' },
    'canopy':        { name:'Specialty â€” Solar Canopy', tilt:5, azimuth:180, pvH:2, pvV:3, tabX:0.6, tabY:2.5, blkX:3.0, blkY:3.0, tpbH:3, tpbV:3, orient:'portrait' }
  };
  function openCat(){ if(catBackdrop){ catBackdrop.style.display='block'; catBackdrop.setAttribute('aria-hidden','false'); } }
  function closeCat(){ if(catBackdrop){ catBackdrop.style.display='none'; catBackdrop.setAttribute('aria-hidden','true'); } }
  openCatalog?.addEventListener('click', openCat);
  catClose?.addEventListener('click', closeCat);
  catBackdrop?.addEventListener('click', e=>{ if(e.target===catBackdrop) closeCat(); });
  catGrid?.querySelectorAll('.pv-card').forEach(card=>{
    card.addEventListener('click', ()=>{
      const key = card.getAttribute('data-struct'); const s = structDefaults[key]; if(!s) return;
      if(structPicked) structPicked.textContent = s.name;
      tilt.value = s.tilt; azimuth.value = s.azimuth;
      pvH.value = s.pvH; pvV.value = s.pvV;
      gapTabX.value=s.tabX; gapTabY.value=s.tabY;
      gapBlkX.value=s.blkX; gapBlkY.value=s.blkY;
      tpbH.value=s.tpbH; tpbV.value=s.tpbV;
      orientSeg?.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.val===s.orient));
      drawPreview();
      closeCat();
    });
  });

  function updateGapControls(){
    const useTables = !!(gbTables && gbTables.checked);
    const useBlocks = !!(gbBlocks && gbBlocks.checked);

    // Table gaps follow "Tables"
    if (gapTabX) gapTabX.disabled = !useTables;
    if (gapTabY) gapTabY.disabled = !useTables;

    // PV per table only matters when tables are enabled
    if (pvH) pvH.disabled = !useTables;
    if (pvV) pvV.disabled = !useTables;

    // Block gaps & counts follow "Block"
    if (gapBlkX) gapBlkX.disabled = !useBlocks;
    if (gapBlkY) gapBlkY.disabled = !useBlocks;
    if (tpbH)    tpbH.disabled    = !useBlocks;
    if (tpbV)    tpbV.disabled    = !useBlocks;
  }
  gbTables?.addEventListener('change', ()=>{ updateGapControls(); drawPreview(); });
  gbBlocks?.addEventListener('change', ()=>{ updateGapControls(); drawPreview(); });
  updateGapControls();

  [mdPwr, mdLen, mdWid, pvH, pvV, tpbH, tpbV, gapModX, gapModY, gapTabX, gapTabY, gapBlkX, gapBlkY, tilt, azimuth, gbTables, gbBlocks].forEach(inp=>{
    inp?.addEventListener?.('input', drawPreview);
    inp?.addEventListener?.('change', drawPreview);
  });

  function fitCanvasToContainer(){
    if (!canvas) return;
    const w = canvas.clientWidth || 300;
    const h = canvas.clientHeight || 200;
    if (canvas.width !== w) canvas.width = w;
    if (canvas.height !== h) canvas.height = h;
    drawPreview();
  }
  arrangeDetails?.addEventListener('toggle', ()=>{ if(arrangeDetails.open) { setTimeout(fitCanvasToContainer, 50); } });

  zoom?.addEventListener('input', ()=>{ previewScale=parseFloat(zoom.value); drawPreview(); });
  zoomIn?.addEventListener('click', ()=>{ zoom.value=Math.min(20, (parseFloat(zoom.value)+0.2)).toFixed(2); previewScale=parseFloat(zoom.value); drawPreview(); });
  zoomOut?.addEventListener('click', ()=>{ zoom.value=Math.max(0.5, (parseFloat(zoom.value)-0.2)).toFixed(2); previewScale=parseFloat(zoom.value); drawPreview(); });
  canvas?.addEventListener('wheel', (e)=>{
    e.preventDefault();
    const delta = e.deltaY>0 ? -0.5 : 0.5;
    const old = parseFloat(zoom.value);
    const next = Math.min(20, Math.max(0.5, old + delta));
    zoom.value = next.toFixed(2); previewScale = parseFloat(zoom.value);
    drawPreview();
  }, {passive:false});
  canvas?.addEventListener('mousedown', (e)=>{ dragging=true; dragStartX=e.clientX; dragStartY=e.clientY; });
  window.addEventListener('mousemove', (e)=>{ if(!dragging) return; panX += (e.clientX - dragStartX); panY += (e.clientY - dragStartY); dragStartX=e.clientX; dragStartY=e.clientY; drawPreview(); });
  window.addEventListener('mouseup', ()=>{ dragging=false; });

  function getPreviewCfg(){
  const orient = orientSeg?.querySelector('.active')?.getAttribute('data-val') || 'portrait';
  const H = Math.max(1, Number(pvH.value||1));
  const V = Math.max(1, Number(pvV.value||1));
  const modLenM = Number(mdLen.value||0)/1000;
  const modWidM = Number(mdWid.value||0)/1000;
  const modX = orient==='portrait' ? modWidM : modLenM;
  const modY = orient==='portrait' ? modLenM : modWidM;

  const useTables = !!(gbTables && gbTables.checked);
  const useBlocks = !!(gbBlocks && gbBlocks.checked);

  const cfg = {
    module:{ name: mdName.value||'Module', pwr: Number(mdPwr.value||0), len: modLenM, wid: modWidM, orient, modX, modY },
    table:{ modH: H, modV: V, gapModX: Number(gapModX.value||0), gapModY: Number(gapModY.value||0) },
    block:{ tH: Math.max(1, Number(tpbH.value||1)), tV: Math.max(1, Number(tpbV.value||1)) },
    gaps:{
      tabX: useTables ? Number(gapTabX.value||0) : 0,
      tabY: useTables ? Number(gapTabY.value||0) : 0,
      blkX: useBlocks ? Number(gapBlkX.value||0) : 0,
      blkY: useBlocks ? Number(gapBlkY.value||0) : 0
    },
    orientation:{ tilt: Number(tilt.value||0), azimuth: Number(azimuth.value||0) }
  };

  // ðŸ‘‰ Collapse tables when "Tables" is OFF
  if (!useTables) {
    cfg.table.modH = 1;
    cfg.table.modV = 1;
    cfg.gaps.tabX = Number(gapModX.value||0);
    cfg.gaps.tabY = Number(gapModY.value||0);
    cfg.table.gapModX = 0;
    cfg.table.gapModY = 0;
  }

  // Tilt projection (top-view Y dimension)
  const modXdim = modX;
  const modYdim = modY * Math.cos((cfg.orientation.tilt||0) * Math.PI/180);
  cfg._modXdim = modXdim;
  cfg._modYdim = modYdim;

  // Table footprint
  cfg.table.w = cfg.table.modH * modXdim + (cfg.table.modH - 1) * cfg.table.gapModX;
  cfg.table.h = cfg.table.modV * modYdim + (cfg.table.modV - 1) * cfg.table.gapModY;
  cfg.table.kwp = (cfg.table.modH * cfg.table.modV * cfg.module.pwr) / 1000;

  // ðŸ‘‰ Collapse blocks when "Block" grouping is OFF
  if (!useBlocks) {
    cfg.block.tH = 1;
    cfg.block.tV = 1;
    cfg.gaps.blkX = 0;
    cfg.gaps.blkY = 0;
  }

  // âœ… Always compute block size after final table and gap setup
  cfg.block.w = (cfg.block.tH * cfg.table.w) + ((cfg.block.tH - 1) * cfg.gaps.tabX);
  cfg.block.h = (cfg.block.tV * cfg.table.h) + ((cfg.block.tV - 1) * cfg.gaps.tabY);

  return cfg;
}


  function drawPreview(){
    if (!canvas) return;
    const cfg = getPreviewCfg();
    const useTables = !!(gbTables && gbTables.checked);
    const W = canvas.width, Hc = canvas.height;
    ctx.clearRect(0,0,W,Hc);

    const colsB = 2, rowsB = 2;
    const padPx = 12;

    const contentW = colsB*cfg.block.w + (colsB-1)*cfg.gaps.blkX;
    const contentH = rowsB*cfg.block.h + (rowsB-1)*cfg.gaps.blkY;

    const theta = (cfg.orientation.azimuth||0) * Math.PI/180;
    const cosT = Math.cos(theta), sinT = Math.sin(theta);
    const uvToXY = (u,v)=>({ x: cosT*u + sinT*v, y: -sinT*u + cosT*v });

    const cornersUV = [{u:0,v:0},{u:contentW,v:0},{u:contentW,v:contentH},{u:0,v:contentH}];
    const cornersXY = cornersUV.map(p=>uvToXY(p.u,p.v));
    const minX = Math.min(...cornersXY.map(p=>p.x));
    const maxX = Math.max(...cornersXY.map(p=>p.x));
    const minY = Math.min(...cornersXY.map(p=>p.y));
    const maxY = Math.max(...cornersXY.map(p=>p.y));
    const rotW = maxX - minX, rotH = maxY - minY;

    const scaleBase = Math.min((W - 2*padPx)/rotW, (Hc - 2*padPx)/rotH);
    const scale = Math.max(0.0001, scaleBase * previewScale);

    const offX = (W - rotW*scale)/2 - (minX*scale) + panX;
    const offY = (Hc - rotH*scale)/2 - (minY*scale) + panY;

    function pathRectUV(u0,v0,w,h){
      const p0 = uvToXY(u0,     v0);
      const p1 = uvToXY(u0+w,   v0);
      const p2 = uvToXY(u0+w,   v0+h);
      const p3 = uvToXY(u0,     v0+h);
      ctx.beginPath();
      ctx.moveTo(offX + p0.x*scale, offY + p0.y*scale);
      ctx.lineTo(offX + p1.x*scale, offY + p1.y*scale);
      ctx.lineTo(offX + p2.x*scale, offY + p2.y*scale);
      ctx.lineTo(offX + p3.x*scale, offY + p3.y*scale);
      ctx.closePath();
    }

    ctx.lineWidth = 1;

    const tW = cfg.table.w, tH = cfg.table.h, tGapX = cfg.gaps.tabX, tGapY = cfg.gaps.tabY;

    for (let br=0;br<rowsB;br++){
      for (let bc=0;bc<colsB;bc++){
        const bu = bc*(cfg.block.w + cfg.gaps.blkX);
        const bv = br*(cfg.block.h + cfg.gaps.blkY);

        ctx.strokeStyle = '#9ca3af';
        pathRectUV(bu, bv, cfg.block.w, cfg.block.h);
        ctx.stroke();

        for(let rr=0; rr<cfg.block.tV; rr++){
          for(let cc=0; cc<cfg.block.tH; cc++){
            const tu = bu + cc*(tW + tGapX);
            const tv = bv + rr*(tH + tGapY);

            if (useTables) {
              ctx.fillStyle = '#e2e8f0'; 
              ctx.strokeStyle = '#64748b';
              pathRectUV(tu, tv, tW, tH);
              ctx.fill(); 
              ctx.stroke();
            }

            const mWpx = cfg._modXdim * scale;
            const mHpx = cfg._modYdim * scale;
            if (mWpx > 4 && mHpx > 4){
              for (let mr=0; mr<cfg.table.modV; mr++){
                for (let mc=0; mc<cfg.table.modH; mc++){
                  const mu = tu + mc*(cfg._modXdim + cfg.table.gapModX);
                  const mv = tv + mr*(cfg._modYdim + cfg.table.gapModY);
                  ctx.fillStyle = '#f8fafc';
                  ctx.strokeStyle = '#94a3b8';
                  pathRectUV(mu, mv, cfg._modXdim, cfg._modYdim);
                  ctx.fill(); ctx.stroke();
                }
              }
            }
          }
        }
      }
    }

    meta.textContent = `Table: ${cfg.table.w.toFixed(2)}m Ã— ${cfg.table.h.toFixed(2)}m Â· ${cfg.table.kwp.toFixed(2)} kWp/table Â· Block: ${cfg.block.tH*cfg.block.tV} tables`;
  }
  drawPreview();

  window.__overlayRegistry = window.__overlayRegistry || new Set();
  function patchOverlayRegistry(){
    const g = window._google; if(!g) return;
    ['Polygon','Rectangle','Circle','Polyline'].forEach(klass=>{
      const C = g.maps[klass]; if(!C || C.__patched) return;
      const proto = C.prototype; const orig = proto.setMap;
      proto.setMap = function(map){ try{ window.__overlayRegistry.add(this); }catch(_e){} return orig.apply(this, arguments); };
      C.__patched = true;
    });
  }
  window.addEventListener('load', ()=>setTimeout(patchOverlayRegistry, 0));

  function getOverlaysBy(pred){
    const out=[]; window.__overlayRegistry?.forEach(ov=>{ try{ if(ov.getMap && ov.getMap() && pred(ov)) out.push(ov); }catch(_e){} });
    return out;
  }
  function getAreasSelected(){
    const sel = getOverlaysBy(ov=>ov.__cat==='area' && ov.__selected===true);
    if(sel.length) return sel;
    return [];
  }
  function polygonPathFromOverlay(ov){
  const g = window._google;
  if (!ov) return [];

  // âœ… Polygon
  if (ov.getPath) {
    return ov.getPath().getArray();
  }

  // âœ… Rectangle
  if (ov.getBounds && ov.__type === g.maps.drawing.OverlayType.RECTANGLE) {
    const b = ov.getBounds(), ne = b.getNorthEast(), sw = b.getSouthWest();
    const nw = new g.maps.LatLng(ne.lat(), sw.lng());
    const se = new g.maps.LatLng(sw.lat(), ne.lng());
    return [nw, ne, se, sw, nw];
  }

  // âœ… Circle (generate smooth circular path)
  if (ov.getCenter && ov.getRadius && ov.__type === g.maps.drawing.OverlayType.CIRCLE) {
    const c = ov.getCenter(), r = ov.getRadius();
    const pts = [];
    const N = 64; // smoother circle resolution
    for (let i = 0; i < N; i++) {
      pts.push(g.maps.geometry.spherical.computeOffset(c, r, i * (360 / N)));
    }
    pts.push(pts[0]); // close the loop
    return pts;
  }

  // Fallback (no geometry)
  return [];
}


  function makeLocal(origin){
    const g=window._google;
    return {
      toXY(p){
        const d = g.maps.geometry.spherical.computeDistanceBetween(origin, p);
        const h = g.maps.geometry.spherical.computeHeading(origin, p) * Math.PI/180;
        return { x: d*Math.sin(h), y: d*Math.cos(h) };
      },
      fromXY(x,y){
        const d = Math.hypot(x,y);
        const h = Math.atan2(x,y) * 180/Math.PI;
        return g.maps.geometry.spherical.computeOffset(origin, d, h);
      }
    };
  }
  function centroid(path){
    const g=window._google;
    let lat=0,lng=0; const n=path.length;
    path.forEach(p=>{ lat+=p.lat(); lng+=p.lng(); });
    return new g.maps.LatLng(lat/n, lng/n);
  }
  function contains(poly, latLng){ return window._google.maps.geometry.poly.containsLocation(latLng, poly); }

  function findNearestEdge(areas, latLng){
    const g=window._google;
    let best={dist2:Infinity, angle:0};
    areas.forEach(ov=>{
      const path = polygonPathFromOverlay(ov);
      if (!path.length) return;
      const org = centroid(path);
      const prj = makeLocal(org);
      const P = prj.toXY(latLng);
      const pts = path.map(p=>prj.toXY(p));
      const n = pts.length;
      for (let i=0;i<n;i++){
        const a=pts[i], b=pts[(i+1)%n];
        const vx=b.x-a.x, vy=b.y-a.y;
        const wx=P.x-a.x, wy=P.y-a.y;
        const denom = vx*vx+vy*vy || 1;
        let t=(wx*vx+wy*vy)/denom; if(t<0)t=0; if(t>1)t=1;
        const qx=a.x+t*vx, qy=a.y+t*vy;
        const dx=P.x-qx, dy=P.y-qy;
        const d2=dx*dx+dy*dy;
        if (d2<best.dist2){
          const heading = Math.atan2(vx, vy)*180/Math.PI;
          best={dist2:d2, angle:(heading+360)%360, edgeIndex:i, ov};
        }
      }
    });
    return best;
  }

  let edgePickListener=null;
  alignEdgeBtn?.addEventListener('click', ()=>{
    const g=window._google, map=window._map;
    if(!g||!map){ alert('Map not ready'); return; }
    const areas = getAreasSelected();
    if(!areas.length){ alert('Select a PV Area first.'); return; }
    if(edgePickListener){ g.maps.event.removeListener(edgePickListener); edgePickListener=null; }
    alignEdgeBtn.textContent = 'Click an edge on mapâ€¦';
    edgeHelp.style.display='inline';
    map.setOptions({ draggableCursor:'crosshair' });
    edgePickListener = g.maps.event.addListener(map, 'click', (e)=>{
      const pick = findNearestEdge(areas, e.latLng);
      const az = Math.round((pick.angle+360)%360);
      azimuth.value = az;
      drawPreview();
      g.maps.event.removeListener(edgePickListener); edgePickListener=null;
      map.setOptions({ draggableCursor:null });
      edgeHelp.style.display='none';
      alignEdgeBtn.textContent = 'Pick edge on map';
    });
  });

  let layoutOverlays = [];
  function clearLayoutForAreas(areas){
    const toRemove = new Set(areas);
    layoutOverlays = layoutOverlays.filter(ov=>{
      const kill = toRemove.has(ov.__parentArea);
      if (kill){ try{ ov.setMap(null); }catch(_e){} }
      return !kill;
    });
  }

  pvLock?.addEventListener('click', ()=>{
    if (pvLock.dataset.state==='unlocked'){
      pvLock.dataset.state='locked'; pvLock.textContent='Unlock editing';
      layoutOverlays.forEach(ov=>{ try{ ov.setEditable(false); ov.setDraggable(false);}catch(_e){} });
    }else{
      pvLock.dataset.state='unlocked'; pvLock.textContent='Lock editing';
      layoutOverlays.forEach(ov=>{ try{ ov.setEditable(true); ov.setDraggable(true);}catch(_e){} });
    }
  });

  pvBuild?.addEventListener('click', buildSimpleFill);



// === Inset helpers (LL = LatLng space) ===
function avgHeading(h1, h2){
  const r1 = h1*Math.PI/180, r2 = h2*Math.PI/180;
  const x = Math.cos(r1)+Math.cos(r2), y = Math.sin(r1)+Math.sin(r2);
  return Math.atan2(y, x) * 180/Math.PI;
}
function signedAreaApproxLL(path){
  // planar-ish orientation test over lat/lng (good enough for inner/outer normal)
  let a = 0, n = path.length;
  for (let i=0;i<n;i++){
    const p = path[i], q = path[(i+1)%n];
    a += (q.lng() - p.lng()) * (q.lat() + p.lat());
  }
  return -a; // ccw positive
}
function insetPolygonLL(pathLL, distMeters){
  const g = window._google;
  if (!g || !pathLL || pathLL.length < 3) return null;

  // ensure open (no duplicate last = first)
  const closed = pathLL[0].equals(pathLL[pathLL.length-1]) ? pathLL.slice(0,-1) : pathLL.slice();
  if (closed.length < 3) return null;

  // inward = left normal when polygon is CCW
  const ccw = signedAreaApproxLL(closed) > 0;
  const N = closed.length;
  const out = [];
  for (let i=0; i<N; i++){
    const prev = closed[(i-1+N)%N], curr = closed[i], next = closed[(i+1)%N];
    const hPrev = g.maps.geometry.spherical.computeHeading(prev, curr);
    const hNext = g.maps.geometry.spherical.computeHeading(curr, next);
    const hAvg  = avgHeading(hPrev, hNext);
    const normal = ccw ? (hAvg - 90) : (hAvg + 90);
    out.push(g.maps.geometry.spherical.computeOffset(curr, distMeters, normal));
  }
  return out; // polygon rings are implicitly closed by Google Maps
}


  
  function buildSimpleFill(){
  const g = window._google, map = window._map;
  if (!g || !map) { alert('Map not ready'); return; }

  const areas = getAreasSelected();
  if (!areas.length) { alert('Select a PV Area first.'); return; }

  clearLayoutForAreas(areas);

  const cfg = getPreviewCfg();
    const userSetback = parseFloat(document.getElementById('in-setback-boundary')?.value || '1');

  const MOD_W = cfg._modXdim;
  const MOD_H = cfg._modYdim;
  const MOD_GX = cfg.table.gapModX;
  const MOD_GY = cfg.table.gapModY;

  const TAB_W = cfg.table.w;
  const TAB_H = cfg.table.h;
  const TAB_GX = cfg.gaps.tabX;
  const TAB_GY = cfg.gaps.tabY;

  const BLK_W = cfg.block.w;
  const BLK_H = cfg.block.h;
  const BLK_GX = cfg.gaps.blkX;
  const BLK_GY = cfg.gaps.blkY;

  const TABLE_MOD_H = cfg.table.modH;
  const TABLE_MOD_V = cfg.table.modV;
  const BLOCK_TAB_H = cfg.block.tH;
  const BLOCK_TAB_V = cfg.block.tV;

  const STYLE = { 
    strokeColor: '#1e3a8a', 
    strokeOpacity: 0.7, 
    strokeWeight: 0.6, 
    fillColor: '#3a7afe', 
    fillOpacity: 0.9,
    zIndex: 1000
  };
  const MAX_MODULES = 50000;
  let total = 0, hitCap = false;

  const theta = (cfg.orientation.azimuth || 0) * Math.PI / 180;
  const cosT = Math.cos(theta), sinT = Math.sin(theta);
  const uvToXY = (u, v) => ({ x: cosT * u + sinT * v, y: -sinT * u + cosT * v });
  const xyToUV = (x, y) => ({ u: cosT * x - sinT * y, v: sinT * x + cosT * y });

  // === Helper: safely treat edge points as inside ===
  function safeContain(poly, latLng, tolerance = 0.02) { // 2 cm inward offset
    if (contains(poly, latLng)) return true;
    const center = centroid(poly.getPath().getArray());
    const heading = g.maps.geometry.spherical.computeHeading(latLng, center);
    const inward = g.maps.geometry.spherical.computeOffset(latLng, tolerance, heading);
    return contains(poly, inward);
  }

  // === Helper: check overlap with any constraint/object ===
  function intersectsAnyBlocker(cornersLL, blockers){
    for (const blocker of blockers){
      for (const pt of cornersLL){ if (safeContain(blocker, pt)) return true; }
      const blockerCenter = centroid(blocker.getPath().getArray());
      const testPoly = new g.maps.Polygon({ paths: cornersLL });
      if (safeContain(testPoly, blockerCenter)) return true;
    }
    return false;
  }

  areas.forEach(ovArea => {
    if (hitCap) return;

  // 1) Get original boundary
  let path = polygonPathFromOverlay(ovArea);
  if (!path.length) return;

  // 2) Inset by user setback (meters) if provided
  const setback = Math.max(0, userSetback || 0);
  if (setback > 0) {
    const inset = insetPolygonLL(path, setback);
    // If the area is too small for this setback, skip placing inside it
    if (!inset || inset.length < 3) return;
    path = inset;
  }


    const polyArea = new g.maps.Polygon({ paths: path });
    const origin = centroid(path);
    const proj = makeLocal(origin);
    const xy = path.map(p => proj.toXY(p));




    
    const uvPoly = xy.map(p => xyToUV(p.x, p.y));

    const minU = Math.min(...uvPoly.map(p => p.u));
    const maxU = Math.max(...uvPoly.map(p => p.u));
    const minV = Math.min(...uvPoly.map(p => p.v));
    const maxV = Math.max(...uvPoly.map(p => p.v));

    const startU = minU;
    const startV = minV;

    const allOverlays = window.__overlayRegistry ? Array.from(window.__overlayRegistry) : [];
    const blockers = allOverlays
      .filter(ov => (ov.__cat === 'constraint' || ov.__cat === 'object') && ov.getMap())
      .map(ov => new g.maps.Polygon({ paths: polygonPathFromOverlay(ov) }));

    const useBlocks = (cfg.block.tH > 1 || cfg.block.tV > 1);
    const STEP_W = useBlocks ? (BLK_W + BLK_GX) : (TAB_W + TAB_GX);
    const STEP_H = useBlocks ? (BLK_H + BLK_GY) : (TAB_H + TAB_GY);
    const TOL = 0.01;

    const nRows = Math.floor((maxV - minV + TOL) / STEP_H);
    const nCols = Math.floor((maxU - minU + TOL) / STEP_W);

    for (let r = 0; r < nRows; r++) {
      const bv = Math.min(startV + r * STEP_H, maxV - (useBlocks ? BLK_H : TAB_H));
      if (hitCap) break;
      for (let c = 0; c < nCols; c++) {
        const bu = Math.min(startU + c * STEP_W, maxU - (useBlocks ? BLK_W : TAB_W));
        if (hitCap) break;

        // --- Clamp final row/column flush to edges ---
        const buClamped = Math.min(bu, maxU - (useBlocks ? BLK_W : TAB_W) + 0.001);
        const bvClamped = Math.min(bv, maxV - (useBlocks ? BLK_H : TAB_H) + 0.001);

        // --- CHECK FULL BLOCK INSIDE AREA ---
        const blockCornersUV = [
          { u: buClamped, v: bvClamped },
          { u: buClamped + (useBlocks ? BLK_W : TAB_W), v: bvClamped },
          { u: buClamped + (useBlocks ? BLK_W : TAB_W), v: bvClamped + (useBlocks ? BLK_H : TAB_H) },
          { u: buClamped, v: bvClamped + (useBlocks ? BLK_H : TAB_H) }
        ];
        const blockCornersLL = blockCornersUV.map(p => {
          const xyP = uvToXY(p.u, p.v);
          return proj.fromXY(xyP.x, xyP.y);
        });
        if (!blockCornersLL.every(pt => safeContain(polyArea, pt))) continue;
        if (intersectsAnyBlocker(blockCornersLL, blockers)) continue;

        for (let tr = 0; tr < BLOCK_TAB_V; tr++) {
          const tabV = bvClamped + tr * (TAB_H + TAB_GY);
          for (let tc = 0; tc < BLOCK_TAB_H; tc++) {
            const tabU = buClamped + tc * (TAB_W + TAB_GX);
            const tableCornersUV = [
              { u: tabU, v: tabV },
              { u: tabU + TAB_W, v: tabV },
              { u: tabU + TAB_W, v: tabV + TAB_H },
              { u: tabU, v: tabV + TAB_H }
            ];
            const tableCornersLL = tableCornersUV.map(p => {
              const xyP = uvToXY(p.u, p.v);
              return proj.fromXY(xyP.x, xyP.y);
            });
            if (!tableCornersLL.every(pt => safeContain(polyArea, pt))) continue;
            if (intersectsAnyBlocker(tableCornersLL, blockers)) continue;

            for (let mr = 0; mr < TABLE_MOD_V; mr++) {
              const baseV = tabV + mr * (MOD_H + MOD_GY);
              for (let mc = 0; mc < TABLE_MOD_H; mc++) {
                const baseU = tabU + mc * (MOD_W + MOD_GX);
                const rectUV = [
                  { u: baseU, v: baseV },
                  { u: baseU + MOD_W, v: baseV },
                  { u: baseU + MOD_W, v: baseV + MOD_H },
                  { u: baseU, v: baseV + MOD_H }
                ];
                const rLL = rectUV.map(p => {
                  const xyP = uvToXY(p.u, p.v);
                  return proj.fromXY(xyP.x, xyP.y);
                });
                if (!rLL.every(pt => safeContain(polyArea, pt))) continue;
                if (intersectsAnyBlocker(rLL, blockers)) continue;

                const poly = new g.maps.Polygon(Object.assign({
                  map,
                  paths: rLL,
                  clickable: true,
                  draggable: (pvLock.dataset.state !== 'locked'),
                  editable: (pvLock.dataset.state !== 'locked')
                }, STYLE));
                poly.__areaName = ovArea.__name || 'Area';
                poly.__kwp = (cfg.module.pwr || 0) / 1000;
                poly.__parentArea = ovArea;
                layoutOverlays.push(poly);

                total++;
                if (total >= MAX_MODULES) {
                  console.warn('Module cap reached:', MAX_MODULES);
                  alert(`Module cap (${MAX_MODULES}) reached.`);
                  hitCap = true;
                  break;
                }
              }
              if (hitCap) break;
            }
            if (hitCap) break;
          }
          if (hitCap) break;
        }
      }
    }
  });

  console.log(`âœ… Layout done: ${total} modules placed.`);
}







  const summaryEl = document.getElementById('summary');
  const sumToggle = document.getElementById('sum-toggle');
  function setSummary(open){
    summaryEl.classList.toggle('collapsed', !open);
    summaryEl.setAttribute('aria-expanded', String(open));
  }
  setSummary(false);
  sumToggle?.addEventListener('click', ()=>{
    const willOpen = summaryEl.classList.contains('collapsed');
    setSummary(willOpen);
  });

  fitCanvasToContainer();

})();
</script>

<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS8L-j2sIfptPCLDUIMP3314KPrKq4394&libraries=places,drawing,geometry&callback=initMap"></script>
</body>
</html>
