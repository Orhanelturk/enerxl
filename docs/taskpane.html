<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>EnerXL Map</title>
<style>
  :root{
    --panel:#fff; --panel-border:#e6e8ee; --shadow:0 6px 20px rgba(0,0,0,.12);
    --icon:#2f3a55; --accent:#3a7afe; --accent-ghost:rgba(58,122,254,.12);
  }
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #app{position:relative;height:100vh;width:100vw;overflow:hidden}

  #map{position:absolute;inset:0}

  .control-pane{
    position:absolute;top:12px;left:10px;
    width:42px;padding:6px 5px;box-sizing:border-box;background:var(--panel);
    border:1px solid var(--panel-border);border-radius:14px;box-shadow:var(--shadow);
    display:flex;flex-direction:column;align-items:center;gap:6px;z-index:30;user-select:none
  }
  .group-sep{height:1px;width:100%;background:var(--panel-border);margin:6px 0}

  .tool-btn{
    width:28px;height:28px;border-radius:8px;border:1px solid #e9ecf3;display:grid;place-items:center;background:#fff;cursor:pointer;
    transition:transform .05s ease,background .15s ease,border-color .15s ease
  }
  .tool-btn:hover{background:#f0f3fb} .tool-btn:active{transform:scale(.98)}
  .tool-btn.is-primary{border-color:transparent;background:var(--accent-ghost)}
  .tool-btn svg{width:16px;height:16px;stroke:var(--icon)}
  .tool-btn.is-primary svg{stroke:var(--accent)}

  /* Search bubble (toggles open) */
  .search-wrap{
    position:absolute;top:12px;left:70px;z-index:25;background:#fff;border:1px solid var(--panel-border);
    border-radius:12px;box-shadow:var(--shadow);padding:6px 10px;align-items:center;gap:8px;min-width:260px;
    display:none; transform-origin:left top; opacity:0; transform:scale(.97); transition:opacity .12s ease, transform .12s ease;
  }
  .search-wrap.open{ display:flex; opacity:1; transform:scale(1) }
  .search-wrap input{width:100%;outline:none;border:none;font-size:14px;padding:6px 2px;background:transparent;color:#1e2433}

  .chip{position:absolute;bottom:70px;left:70px;z-index:25;background:#fff;border:1px solid var(--panel-border);
        border-radius:999px;padding:8px 12px;font-size:12px;color:#263248;box-shadow:var(--shadow)}

  body.fs #map{inset:0}
</style>
</head>
<body>
<div id="app">
  <div id="map" role="application" aria-label="Map"></div>

  <!-- Left tools -->
  <div class="control-pane" aria-label="Tools">
    <!-- Search first -->
    <button class="tool-btn" data-tool="search" title="Search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>
      </svg>
    </button>
    <button class="tool-btn is-primary" data-tool="select" title="Select / Pan" aria-label="Select">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 4l8 8"/><path d="M4 12V4h8"/><path d="M13 13l7 7"/><path d="M15 19l-4-4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="draw" title="Draw polygon" aria-label="Draw polygon">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7l6-3 6 3 0 7-6 3-6-3z"/>
        <circle cx="9" cy="4" r="1.2"/><circle cx="15" cy="7" r="1.2"/><circle cx="15" cy="14" r="1.2"/>
        <circle cx="9" cy="17" r="1.2"/><circle cx="3" cy="7" r="1.2"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="clear" title="Clear" aria-label="Clear">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 6h18"/><path d="M8 6l1-2h6l1 2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/>
      </svg>
    </button>
    <div class="group-sep"></div>
    <button class="tool-btn" data-tool="layers" title="Layers" aria-label="Layers">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2l9 5-9 5-9-5 9-5z"/><path d="M3 12l9 5 9-5"/><path d="M3 17l9 5 9-5"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="measure" title="Measure" aria-label="Measure">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 18l12-12 6 6-12 12H3v-6z"/><path d="M14 6l4 4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="export" title="Export" aria-label="Export">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3v12"/><path d="M8 9l4 4 4-4"/><path d="M20 21H4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="settings" title="Settings" aria-label="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.26-.39 1.51-1 .25-.6.12-1.28-.33-1.82l-.06-.06A2 2 0 1 1 7.1 3.3l.06.06c.54.45 1.22.58 1.82.33H9c.61-.25 1-.85 1-1.51V3a2 2 0 1 1 4 0v.09c0 .66.39 1.26 1 1.51.6.25 1.28.12 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.45.54-.58 1.22-.33 1.82.25.61.85 1 1.51 1H21a2 2 0 1 1 0 4h-.09c-.66 0-1.26.39-1.51 1z"/>
      </svg>
    </button>
  </div>

  <!-- Toggled search -->
  <div class="search-wrap" id="search-wrap" aria-expanded="false">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7f8aa3" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>
    </svg>
    <input id="search-input" type="text" placeholder="Search location…" aria-label="Search location" />
  </div>

  <div id="chip" class="chip" style="display:none;"></div>
</div>

<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS8L-j2sIfptPCLDUIMP3314KPrKq4394&libraries=places,drawing,geometry&callback=initMap"></script>
<script>
  window.initMap = function(){
    const center = { lat: 23.5859, lng: 58.4059 }; // Muscat
    const map = new google.maps.Map(document.getElementById('map'), {
      center, zoom: 5,
      mapTypeId: 'satellite',
      mapTypeControl: false,
      fullscreenControl: false,     // we use our own
      streetViewControl: false,
      zoomControl: false            // REMOVE native +/−
    });

    // --- Places search ---
    let searchMarker = null;
    const wrap = document.getElementById('search-wrap');
    const input = document.getElementById('search-input');
    const ac = new google.maps.places.Autocomplete(input, { fields: ['geometry','name'] });
    ac.bindTo('bounds', map);
    ac.addListener('place_changed', () => {
      const p = ac.getPlace();
      if (!p.geometry || !p.geometry.location) return;
      map.panTo(p.geometry.location); map.setZoom(12);
      if (!searchMarker) searchMarker = new google.maps.Marker({ map, position: p.geometry.location });
      else searchMarker.setPosition(p.geometry.location);
      showChip(`📍 ${p.name || 'Location'}`);
    });

    // --- Left tools (search toggle) ---
    const byTool = (t)=>document.querySelector(`[data-tool="${t}"]`);
    ['search','select','draw','clear','layers','measure','export','settings'].forEach(t=>{
      const el = byTool(t); if(!el) return;
      el.addEventListener('click', ()=>{
        if (t==='search'){
          const isOpen = wrap.classList.toggle('open');
          wrap.setAttribute('aria-expanded', String(isOpen));
          if (isOpen) setTimeout(()=>{ input.focus(); input.select(); }, 0);
        } else {
          flashPrimary(el); showChip(`Tool: ${t}`);
        }
      });
    });

    // Close search on outside click or ESC
    document.addEventListener('click', (e)=>{
      const searchBtn = byTool('search');
      if (!wrap.classList.contains('open')) return;
      if (!wrap.contains(e.target) && !searchBtn.contains(e.target)) {
        wrap.classList.remove('open'); wrap.setAttribute('aria-expanded','false');
      }
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && wrap.classList.contains('open')) {
        wrap.classList.remove('open'); wrap.setAttribute('aria-expanded','false');
      }
      if (e.key === 'Escape' && document.body.classList.contains('fs')){
        document.body.classList.remove('fs'); google.maps.event.trigger(map,'resize');
      }
    });

    // --- Custom ROUND FULLSCREEN control (RIGHT_BOTTOM) ---
    const fsControl = buildRoundFullScreenControl();
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(fsControl);

    function buildRoundFullScreenControl(){
      const container = document.createElement('div');
      container.style.margin = '8px';

      const btn = document.createElement('button');
      btn.title = 'Full screen';
      btn.setAttribute('aria-label','Full screen');

      // circular look like Google controls
      Object.assign(btn.style, {
        width:'40px', height:'40px',
        borderRadius:'9999px',
        border:'1px solid var(--panel-border)',
        background:'#fff',
        boxShadow:'var(--shadow)',
        display:'grid', placeItems:'center',
        cursor:'pointer', padding:'0'
      });

      btn.innerHTML = `
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none"
             stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"
             style="color:#2f3a55">
          <path d="M9 3H3v6M15 3h6v6M9 21H3v-6M21 15v6h-6"/>
        </svg>`;
      btn.addEventListener('click', toggleFullScreen);

      container.appendChild(btn);
      return container;
    }

    // --- Helpers ---
    function flashPrimary(el){
      const was=el.classList.contains('is-primary');
      document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('is-primary'));
      if(!was) el.classList.add('is-primary');
    }
    function showChip(text){
      const c=document.getElementById('chip'); c.textContent=text; c.style.display='inline-flex';
      clearTimeout(showChip._t); showChip._t=setTimeout(()=>c.style.display='none', 2000);
    }

    async function toggleFullScreen(){
      const root = document.documentElement;
      if (!document.fullscreenElement && root.requestFullscreen){
        try { await root.requestFullscreen(); } catch(e){ /* Excel task pane may block */ }
      } else if (document.fullscreenElement && document.exitFullscreen){
        try { await document.exitFullscreen(); } catch(e){}
      }
      document.body.classList.toggle('fs');
      google.maps.event.trigger(map,'resize');
    }

    window.addEventListener('resize', ()=>google.maps.event.trigger(map,'resize'));
  };
</script>
</body>
</html>
