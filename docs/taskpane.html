<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Integrated PV Layout & Inverter Sizing (Modern UI)</title>

  <script src="https://unpkg.com/dxf-writer@1.4.2/dist/dxf-writer.min.js"></script>
 
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS8L-j2sIfptPCLDUIMP3314KPrKq4394&libraries=places,drawing,geometry"></script>
  <script src="https://unpkg.com/jsts@2.12.2/dist/jsts.min.js"></script>
  <script src="InverterLibrary16.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

  <style>
    html,body {
      height: 100%; margin: 0; padding: 0;
      font-family:'Roboto', sans-serif; color:#333;
    }
    html,body{ height:100%; margin:0; overflow:hidden; }
    #map{
      position:absolute;
      top:45px;                    /* height of #topâ€‘menuâ€‘bar  */
      left:300px;                  /* width of the side panel */
      width:calc(100% - 300px);    /* rest of the page */
      height:calc(100% - 45px);    /* rest of the page */
    }
    /* +++++++++++++++++++++++++++++++++++++++++++++++++++++
       NEW: Thin top menu bar 
       +++++++++++++++++++++++++++++++++++++++++++++++++++++ */
    #top-menu-bar{
      position:fixed;          /* stays stuck to the top */
      top:0;
      left:300px;              /* flush with the side panel */
      right:0;                 /* â† let the browser work out the width */
      height:45px;
      background:#f7f7f7;
      color:#005899;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      box-sizing:border-box;   /* padding counted inside width */
      z-index:999999;
      overflow:hidden;         /* prevents the bar itself pushing out */
    }
    #menu-left-section {
      display: flex;
      align-items: center;
      gap: 15px; /* space between icons */
    }
    .menu-button {
      position: relative; /* for tooltip */
      cursor: pointer;
      font-size: 18px;
    }
    /* Simple tooltip on hover, using data-title attribute */
    .menu-button::after {
      content: attr(data-title);
      position: absolute;
      bottom: -38px; /* place tooltip below the icon */
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 9999999;
    }
    .menu-button:hover::after {
      opacity: 0.9;
    }

    #menu-right-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #username {
      font-weight: 500;
      margin-right: 8px;
    }
    /* The new top search input */
    #top-search-input {
      width: 220px;
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    #search-bar {
      position: static;
      top: auto;
      left: auto;
      transform: none;
      width: 90%;
      margin: auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    #search-bar input {
      width:100%; margin:5px 0; padding:8px; font-size:14px;
      border-radius:4px; border:1px solid #ccc;
    }
    #info-bar {
  position: absolute;
  top: auto;
  left: auto;
  bottom: 75px;
  right: 10px;
  
  background: rgba(255,255,255,0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  z-index: 99999;
  width: 180px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  display: none;
}

#info-bar-header {
  

      background:#005899;
      color:#fff;
      font-size:14px;
      padding:4px 6px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:move;
    }



#info-bar-close {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 14px;
  line-height: 1;
  cursor: pointer;
  padding: 0 2px;
}

#info-bar-body {
  padding: 10px;
  font-size: 13px;
}

    /* -------------------------------------------------------------
       Inverter Sizing Modal
       ------------------------------------------------------------- */
    #inverter-sizing-modal {
      display:none;
      position:absolute; top:50px; left:320px;
      width:80%; max-width:1000px;
      background:#fff; border:2px solid #ccc;
      z-index:999; box-shadow:0 0 10px rgba(0,0,0,0.5);
      max-height:80%;
      resize: both; /* For manual resizing from edges */
      overflow: auto;
      min-width:400px; 
      min-height:200px;
    }
    #inverter-sizing-header {
      padding: 2px; 
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #333;
      color: #fff;
    }
    #close-inverter-sizing-btn,
    #inv-zoom-in,
    #inv-zoom-out {
      margin: 0 !important;  
      padding: 2px 6px !important;  
      font-size: 12px;
      line-height: 1;
      display: inline-block;
    }
    #inverter-sizing-content {
      padding:10px;
      transform-origin: top left; /* for zoom scaling */
    }
    #inverter-sizing-modal h1, #inverter-sizing-modal h2, #inverter-sizing-modal h3 {
      text-align:center;
    }
    #inverter-sizing-modal .form-group { margin-bottom:1em; }
    #inverter-sizing-modal label { font-weight:bold; }
    #inverter-sizing-modal input[type=number] {
      width:100%; padding:0.4em; box-sizing:border-box; margin-bottom:0.4em;
    }
    #inverter-sizing-modal .inverter-checkbox {
      margin-right:10px;
    }
    #inverter-sizing-modal .note {
      font-style:italic; font-size:0.9em; color:#555; margin:0.5em 0;
    }
    #inverter-sizing-modal button {
      padding:0.6em 1.2em; font-size:1em; cursor:pointer; margin:1em 0;
    }
    #inverter-sizing-modal #result {
      margin-top:2em; background:#f9f9f9; border:1px solid #ddd; padding:1em;
    }
    #inverter-sizing-modal table {
      width:100%; border-collapse:collapse; margin-top:1em;
    }
    #inverter-sizing-modal th, #inverter-sizing-modal td {
      border:1px solid #ccc; padding:0.6em; text-align:center; vertical-align:middle;
    }
    #inverter-sizing-modal .sub-table {
      width:100%; border-collapse:collapse; margin-top:0.5em;
    }
    #inverter-sizing-modal .sub-table th, #inverter-sizing-modal .sub-table td {
      border:1px solid #ddd; padding:0.4em; text-align:center; background:#fafafa;
    }
    #inverter-sizing-modal .warning {
      color:#b00; font-weight:bold;
    }

    /* -------------------------------------------------------------
       Side Panel
       ------------------------------------------------------------- */
       #side-panel {
  position: absolute;
  top: 0;
  left: 0;
  width: 300px;
  height: 100%;
  background: #f7f7f7;
  border-left: 1px solid #ccc;
  z-index: 1000;

  overflow-y: scroll;     /* ðŸ”’ always show scrollbar */
  scrollbar-width: auto;  /* for Firefox â€“ optional */
  box-shadow: -3px 0 6px rgba(0, 0, 0, 0.1);

  direction: rtl;         /* â¬… scrollbar on left */
}

#side-panel > * {
  direction: ltr;         /* normal content flow */
}

    #toggle-button:hover { background:#222; }

    .collapsible-section {
      border:1px solid #ccc; border-radius:4px; margin:10px; background:#fafafa;
    }
    .collapsible-header {
      padding:10px; cursor:pointer; font-weight:bold; background:#e0e0e0;
      display:flex; align-items:center; justify-content:space-between;
    }
    .icon-indicator { margin-left:5px; }
    .collapsible-content { display:none; padding:10px; }
    .collapsible-content.open { display:block; }

    .modern-btn {
      display:inline-flex; align-items:center; background:#005899; color:#fff;
      border:none; outline:none; padding:8px 12px; margin:5px 0; font-size:14px;
      border-radius:4px; cursor:pointer; transition:background 0.2s ease;
      width:100%; justify-content:center;
    }
    .modern-btn i { margin-right:8px; }
    .modern-btn:hover { background:#0056b3; }
    .modern-btn:active {
      background:#003f7f; transform:translateY(1px);
    }
    .icon-btn {
      background:#007BFF; width:40px; height:40px; border-radius:50%;
      justify-content:center; margin:5px;
    }
    .icon-btn i { margin-right:0; }

    .drop-zone {
      width:100%; min-height:100px; border:2px dashed #999;
      border-radius:10px; text-align:center; line-height:100px;
      color:#999; margin-bottom:20px; cursor:pointer;
    }
    .drop-zone.dragover { background:#f0f0f0; }

    select {
      margin-bottom:10px; margin-right:10px;
    }
    .details {
      margin-top:20px; border:1px solid #ccc; padding:10px; width:100%;
      background:#fafafa; max-height:200px; overflow-y:auto;
    }
    #ond-inverter-list { margin:1em 0; }
    .ond-inverter-item { margin:0.3em 0; }

    .obstacles-draw-tools {
      display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;
    }
    .obstacles-draw-tools button {
  background: #005899;
  color: #fff;
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s ease;
  font-size: 18px; /* Icon size */
}

.obstacles-draw-tools button:hover {
  background-color: #0056b3;
}

.obstacles-draw-tools button:active {
  background-color: #003f7f;
  transform: translateY(1px);
}

.obstacles-draw-tools i,
.obstacles-draw-tools .material-icons {
  margin: 0; /* no margin between icon and border */
  font-size: 18px;
}

#drawing-controls-body button {
  background: #ffffff;
  color: #333;
  width: 36px;
  height: 36px;
  border: 1px solid #ccc;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
  font-size: 18px;
}

#drawing-controls-body button:hover {
  background-color: #f5f5f5;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

#drawing-controls-body button:active {
  background-color: #e0e0e0;
  transform: translateY(1px);
}

#drawing-controls-body {
  display: flex;
  flex-wrap: wrap;
  justify-content: center; /* CENTER the buttons */
  gap: 5px; /* small gap between buttons */
  margin-top: 10px;
}

    #marquee {
      position:absolute; border:1px dashed #f00; background:rgba(255,0,0,0.1);
      display:none; pointer-events:none; z-index:1000000;
    }
    #rotationPanel {
      position:absolute; z-index:1000001; display:none;
      background:rgba(255,255,255,0.95); padding:6px; border-radius:6px;
      box-shadow:0 2px 5px rgba(0,0,0,0.15); font-size:0.9rem;
    }
    #rotationPanel .sliderContainer {
      display:flex; align-items:center;
    }
    #rotationSlider { width:80px; }
    #rotationInput {
      width:45px; margin-left:6px; font-size:0.85rem; padding:2px;
    }
    #gridPanel{
  position:fixed;
  top:55px;            /* 45Â px menu bar + 10Â px gap */
  right:10px;          /* 10Â px from windowâ€™s right edge */
  width:200px;

  /* keep it hidden until the user clicks the Grid button */
  display:none;        /* <= THIS line prevents autoâ€‘open */

  background:rgba(255,255,255,0.95);
  padding:6px;
  border:1px solid #ccc;
  border-radius:6px;
  box-shadow:0 2px 5px rgba(0,0,0,0.15);
  font-size:0.9rem;
  z-index:1000002;
}
    #gridPanel label {
      display:block; margin:4px 0 2px; font-weight:600; font-size:0.85rem;
    }
    #gridPanel input[type="number"], #gridPanel input[type="range"] {
      font-size:0.85rem;
    }
    #gridPanel input[type="number"] {
      width:60px; padding:2px;
    }
    #gridPanel input[type="range"] {
      width:110px;
    }
    .gridRotationContainer {
      display:flex; align-items:center;
    }
    #gridRotationInput {
      width:45px; margin-left:6px; font-size:0.85rem; padding:2px;
    }
    #gridPanel button {
      margin-top:8px; margin-right:4px; padding:4px 8px; border:none;
      background:#007bff; color:#fff; border-radius:4px; cursor:pointer;
      font-size:0.8rem;
    }
    #gridPanel button:hover { background:#005dc1; }

    .modal-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.4); z-index:9999; display:none;
    }
    .modal-box {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; padding:20px; border:2px solid #ccc;
      width:600px; max-height:80%; overflow-y:auto; border-radius:8px;
    }
    .modal-title {
      font-weight:bold; margin-bottom:10px; text-align:center;
    }
    .modal-table {
      width:100%; border-collapse:collapse;
    }
    .modal-table th, .modal-table td {
      border:1px solid #ddd; padding:6px; text-align:center;
    }
    .modal-actions { text-align:center; margin-top:15px; }
    .close-btn {
      background:#ccc; color:#333; margin-left:10px;
    }

    /* -------------------------------------------
       Electrical Design Popout
       ------------------------------------------- */
    #electrical-design-popout {
      display:none; position:absolute; top:60px; left:320px;
      width:80%; height:80%;
      background:#fff; border:2px solid #ccc;
      z-index:999999; box-shadow:0 0 10px rgba(0,0,0,0.5);
      resize: both; /* For manual resizing from edges */
      overflow: auto;
      min-width:400px;
      min-height:200px;
    }
    #electrical-design-header {
      background:#333; color:#fff; padding:6px;
      cursor:move; /* drag handle */
      display:flex; justify-content:space-between; align-items:center;
    }
    #ed-header-left {
      display:flex;
      gap:8px;
      align-items:center;
    }
    #close-electrical-design-btn {
      background:#999; color:#fff; border:none; padding:4px 10px;
      cursor:pointer; border-radius:4px;
    }
    #electrical-design-content {
      width:100%; height:calc(100% - 30px); position:relative; overflow:hidden;
      transform-origin: top left; /* for potential zoom */
    }
    #ed-container {
      display:flex; width:100%; height:100%;
    }
    #ed-systemConfigModal {
      position:relative; width:250px; background:#f0f0f0; flex-shrink:0;
      overflow-y:auto; border-right:1px solid #ccc; padding:1rem;
      box-shadow:0 0 10px rgba(0,0,0,0.2); z-index:2;
    }
    #ed-systemConfigModal .modal-content {
      position:static; transform:none; background:none; box-shadow:none;
      width:100%; height:auto; padding:0; margin:0;
    }
    #ed-systemConfigModal .modal-content h2 {
      margin-bottom:1rem; text-align:left;
    }
    #ed-systemConfigModal .modal-content label {
      display:block; margin:0.5rem 0 0.2rem;
    }
    #ed-systemConfigModal .modal-content input,
    #ed-systemConfigModal .modal-content select {
      width:100%; padding:0.4rem; margin-bottom:0.6rem;
      border:1px solid #ccc; border-radius:4px; font-size:1rem;
    }
    .assoc-table {
      margin:1rem 0; border:1px solid #ccc; border-collapse:collapse; width:100%;
    }
    .assoc-table th, .assoc-table td {
      border:1px solid #ccc; padding:0.5rem; text-align:center;
    }
    #ed-systemConfigModal .modal-content button {
      margin:0.5rem 0.25rem 0; padding:0.5rem 1rem;
      border:none; border-radius:4px; font-size:1rem; cursor:pointer;
    }
    #ed-systemConfigModal .modal-content button:hover { opacity:0.9; }
    #ed-btnApplyConfig { background-color:#4caf50; color:#fff; }
    #ed-btnCancelConfig { background-color:#f44336; color:#fff; }

    #ed-drawing-area {
      position:relative; flex:1; margin:0.5rem; border-radius:8px;
      background-color:#ffffff; box-shadow:0 2px 10px rgba(0,0,0,0.15);
      background-image:radial-gradient(#ccc 1px, transparent 1px);
      background-size:15px 15px; overflow:hidden;
    }
    #ed-cable-layer {
      position:absolute; top:0; left:0; width:100%; height:100%;
      pointer-events:none; z-index:1;
    }
    .ed-dropped-element {
      position:absolute; user-select:none; border-radius:8px; overflow:hidden;
      display:flex; align-items:center; justify-content:center; cursor:move;
      transition:box-shadow 0.2s ease; z-index:2;
    }
    .ed-dropped-element svg {
      width:100%; height:100%;
      filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.2));
    }
    .ed-dropped-element:hover {
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
    }
    .ed-dropped-element.selected {
      outline:2px solid #ff9800;
    }
    #ed-selection-box {
      position:absolute; border:2px dashed #ff9800;
      background:rgba(255,152,0,0.1); pointer-events:none;
      display:none; z-index:10; border-radius:4px;
    }

    /* ---------- ADDED for layer toggles panel ---------- */
    #layer-panel {
      position:absolute; 
      top:362px; 
      right:10px; 
      transform:translateY(-50%);
      background:rgba(255,255,255,0.95);
      border:1px solid #ccc;
      border-radius:8px;
      padding:10px;
      z-index:99999;
      width:180px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    #drawing-controls-panel {
  position: absolute;
  top: 60px;
  right: 10px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  z-index: 99999;
  width: 180px; /* <-- Change this from 200px to 180px */
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

#drawing-controls-header {
  background: #005899;
  color: #fff;
  font-size: 14px;
  padding: 4px 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
}

#drawing-controls-close {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 14px;
  line-height: 1;
  cursor: pointer;
  padding: 0 2px;
}



    #layer-header{
      background:#005899;
      color:#fff;
      font-size:14px;
      padding:4px 6px;
      display:flex; justify-content:space-between; align-items:center;
      cursor:move;
    }
    #layer-close{
      background:transparent;
      border:none;
      color:#fff;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      padding:0 2px;
    }
    #layer-panel h3 {
      margin:0 0 10px 0;
      font-size:16px;
      text-align:center;
    }
    .layer-toggle-item {
      display:flex; align-items:center;
      margin:5px 0;
      cursor:pointer;
    }
    .layer-toggle-item i {
      margin-right:6px;
    }
    .layer-toggle-item input[type="checkbox"] {
      margin-right:6px;
      cursor:pointer;
    }

    /* --- Foundations Popout --- */
    #foundation-design-popout {
      display: none;
      position: absolute;
      top: 20px;
      left: 320px;
      width: 82%;
      height: 95%;
      background: #fff;
      border: 2px solid #ccc;
      z-index: 999999;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      resize: both;
      overflow: hidden;
    }
    #foundation-design-header {
      background: #333;
      color: #fff;
      padding: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move; /* for dragging */
    }
    #foundation-design-content {
      width: 100%;
      height: calc(100% - 30px);
      position: relative;
    }
    #foundation-design-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    #foundation-drawing-area {
      flex: 1; 
      position: relative;
      margin: 0.5rem;
      background: #ffffff;
      overflow: auto; 
    }
    #foundation-summary-table {
      position: absolute; 
      top: 0;
      left: 0;
      z-index: 9999;
      background: #fff;
      border: 1px solid #ccc;
      padding: 4px;
    }
    #foundation-summary-table table {
      width: auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    #foundation-summary-table th,
    #foundation-summary-table td {
      width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
      vertical-align: middle;
    }
    #foundation-svg {
      width: 100%;
      min-height: 500px; 
      background: #fff; 
    }
    .foundation-area {
      fill: #f5f5f5;
      stroke: #888;
      stroke-width: 1;
    }
    .foundation-module {
      fill: #2a8ef4;
      fill-opacity: 0.6;
      stroke: #666;
      stroke-width: 0.5;
    }
    #mounting-collapse label,
    #mounting-collapse input[type="number"],
    #mounting-collapse select {
      display: block;
      margin-bottom: 0.2em;
    }
    #mounting-catalog-popout {
      display: none; 
      position: absolute;
      top: 0;
      left: 300px; 
      width: 300px;
      height: 100%;
      background: #fff;
      border: 2px solid #ccc;
      z-index: 999999; 
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #mounting-catalog-header {
      background: #333;
      color: #fff;
      padding: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
    }
    #mounting-catalog-title span {
      font-weight: bold;
      font-size: 1.1em;
    }
    #close-mounting-catalog-btn {
      background: #999;
      color: #fff;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    #mounting-catalog-content {
      width: 100%;
      height: calc(100% - 30px);
      overflow-y: auto;
      position: relative;
      transform-origin: top left;
      padding: 8px;
    }
    #mounting-catalog-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .mounting-catalog-item {
      width: 120px;
      text-align: center;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 5px;
      background-color: #f9f9f9;
      transition: box-shadow 0.2s;
    }
    .mounting-catalog-item:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .mounting-catalog-item img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .section-header{
  font-weight:600;
  font-size:14px;     /* same size as collapsible headers */
  color:#333;
  margin:15px 5px ;     /* 4Â px above, 0 below for tighter gap */
}

.section-separator{
  border:0;
  border-top:1px solid #ccc;
  margin:10px 10px;      /* space above & below the line        */
}

/* first button that follows one of these headers */
.section-header + .modern-btn{
  margin-top:5px !important; /* overrides the default 5Â px    */
}

/* ---------- layout-mode toggle ---------- */
.layout-switch {
  display:flex; align-items:center; gap:6px; margin-bottom:6px;
  font-size:13px; user-select:none;
}
.layout-switch input[type="checkbox"] {display:none;}
.layout-switch .slider {
  width:38px; height:18px; background:#ccc; border-radius:12px;
  position:relative; transition:.25s;
}
.layout-switch .slider::before{
  content:""; position:absolute; left:2px; top:2px; width:14px; height:14px;
  background:#fff; border-radius:50%; transition:.25s;
}
.layout-switch input:checked + .slider           {background:#005899;}
.layout-switch input:checked + .slider::before   {transform:translateX(20px);}

/* Mounting-params table overrides */
#mounting-params-table input,
#mounting-params-table select {
  display: inline-block;   /* cancel the earlier display:block */
  margin: 0;
}
#mounting-params-table td {
  border: 1px solid #ccc;  /* optional thin grid lines */
}

/* -------------------------------
   Overall Modal Container
-------------------------------- */
#inverter-sizing-modal {
  display: none;  
  position: absolute;
  top: 50px;
  left: 320px;
  width: 80%;           /* Larger default width */
  max-width: 1200px;    /* Up to 1200px wide */
  min-width: 600px;     /* Keep a decent min width */
  min-height: 400px;    /* Taller min height */
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 999999;
  resize: both;
  overflow: auto;
  font-family: "Roboto", sans-serif;
  font-size: 14px;
  box-sizing: border-box;
}

/* --------------------------------
   Draggable Header Bar
-------------------------------- */
#inverter-sizing-header {
  background: #444;
  color: #fff;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: move; /* for dragging the modal */
  border-radius: 6px 6px 0 0;
}

#inverter-sizing-header .header-left h2 {
  margin: 0;
  font-size: 16px;
  font-weight: normal;
}

/* The Zoom In/Out and Close buttons in the header */
#inverter-sizing-header .header-right button {
  margin-left: 8px;
  font-size: 12px;
  padding: 4px 8px;
  cursor: pointer;
  background: #555;
  color: #fff;
  border: none;
  border-radius: 4px;
}
#inverter-sizing-header .header-right button:hover {
  background: #666;
}
#inverter-sizing-header .header-right button:active {
  background: #333;
}
#close-inverter-sizing-btn {
  background: #aa3333 !important;
}

/* --------------------------------
   The Two-Column Interior
-------------------------------- */
#inverter-sizing-content {
  display: flex;
  flex-wrap: wrap;
  padding: 10px;
  gap: 10px;
  box-sizing: border-box;
}

/* Left column: stacked inverters in single column */
.inverter-sizing-leftcol {
  flex: 1 1 50%;
  min-width: 280px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  box-sizing: border-box;
}

.column-title {
  margin: 0 0 8px 0;
  font-size: 15px;
  font-weight: 600;
}

/* Each "card" for one inverter, stacked vertically */
.inv-card {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 8px;  /* small gap between cards */
  padding: 4px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  font-size: 13px;
}

/* Two lines: top = checkbox + label; bottom = "Change to" + selects + tiny replace */
.inv-card-top,
.inv-card-bottom {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 0;
  padding: 0;
}
.inv-card-title {
  font-weight: 600;
  font-size: 13px;
}

/* Super-tiny replace button: "R" */
.tiny-replace-btn {
  padding: 2px 4px;
  font-size: 11px;
  background: #005899;  /* same color as "Update Layout" */
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.tiny-replace-btn:hover {
  background: #004f85;
}

/* --------------------------------
   Right column: environment inputs
-------------------------------- */
.inverter-sizing-rightcol {
  flex: 0 0 240px; /* fixed width for environment panel */
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  box-sizing: border-box;
}

.env-fields {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  margin-bottom: 10px;
}
.env-fields label {
  font-weight: 500;
  font-size: 13px;
}
.env-fields input {
  width: 80px;
  padding: 3px;
  font-size: 12px;
}

/* The calculate button - same color as "Update Layout" */
.calc-btn {
  background: #005899;
  color: #fff;
  font-size: 13px;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.calc-btn:hover {
  background: #004f85;
}

/* --------------------------------
   Results area at bottom
-------------------------------- */
#inverter-sizing-results {
  padding: 10px;
  border-top: 1px solid #ddd;
}

/* The container (#result) your JS populates with solutions/tables, etc. */
#inverter-sizing-modal #result {
  margin-top: 0;
  background: #fdfdfd;
  border: 1px solid #ccc;
  padding: 8px;
  font-size: 13px;
  border-radius: 4px;
}

/* ==============
   SIMPLER TABLE
=============== */
#inverter-sizing-modal #result table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 8px;
}
#inverter-sizing-modal #result table th,
#inverter-sizing-modal #result table td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: center;
  font-size: 13px;
  vertical-align: middle;
  white-space: nowrap;
}

/* Example heading row for simpler columns:
   Rank | DC(kW) | AC(kW) | DC/AC | Â±DC | Â±Ratio | Score | Action
   (Your JS can build these headings as you want.)
*/

/* ==============
   Buttons in the table
=============== */
.use-btn {
  display: inline-block;
  padding: 5px 10px;
  font-size: 12px;
  margin-right: 4px;
  cursor: pointer;
  background: #005899;  /* same "Update Layout" color */
  color: #fff;
  border: none;
  border-radius: 4px;
}
.use-btn:hover {
  background: #004f85;
}

.details-icon-btn {
  display: inline-block;
  padding: 4px 7px;
  font-size: 12px;
  background: #eee;
  color: #333;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
}
.details-icon-btn:hover {
  background: #ddd;
}



/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ UPDATED: widen the modal â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#inverter-sizing-modal{
  width:90%;
  max-width:1400px;
}


/* ========= CALLOUT TOOLTIP ========== */
#callout-box{
  position:fixed;        /* follow the viewport for clientX / clientY */
  z-index:10000000;      /* above the map & every panel */
  background:rgba(0,0,0,0.85);
  color:#fff;
  padding:4px 8px;
  border-radius:4px;
  font-family:Roboto, sans-serif;
  font-size:12px;
  line-height:1.3;
  white-space:nowrap;
  pointer-events:none;   /* never block map clicks */
  display:none;          /* JS toggles this */
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ New table styling â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.solution-table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:20px;
  font-size:13px;
}
.solution-table th,
.solution-table td{
  border:1px solid #ccc;
  padding:6px 8px;
  text-align:center;
  white-space:nowrap;
}
.solution-header{
  background:#f3f3f3;
  font-weight:600;
  font-size:14px;
}
.subtotal-row td{
  background:#fafafa;
  height:4px;
  padding:2px;
}
.actions{
  white-space:nowrap;
}

.solution-summary{
  display:flex;
  align-items:center;
  gap:8px;                      /* tighter than before */
  margin:14px 0 6px;
  border:1px solid #d0d0d0;
  border-radius:8px;
  background:#fafafa;
  box-shadow:0 1px 3px rgba(0,0,0,0.08);
  font-size:14px;
  line-height:1.4;
  padding:8px 12px;
}

.solution-summary strong{        /* â€œSolution 1â€ */
  color:#005899;
  font-size:15px;
}

.solution-summary span{          /* the numbers */
  font-weight:600;
}

.summary-actions{                /* wrapper pushes both buttons right */
  margin-left:auto;
  display:flex;
  gap:6px;
}

.summary-actions .use-btn,
.summary-actions .details-icon-btn{
  padding:5px 11px;
}

  </style>
</head>

<body>

  <div id="map"></div>
  <div id="marquee"></div>
  <div id="rotationPanel">
    <div class="sliderContainer">
      <input type="range" id="rotationSlider" min="0" max="360" value="0"/>
      <input type="number" id="rotationInput" min="0" max="360" value="0"/>
    </div>
  </div>
  <div id="gridPanel">
    <label>Rows:</label>
    <input type="number" id="gridRows" value="4" min="1"/>
    <label>Cols:</label>
    <input type="number" id="gridCols" value="2" min="1"/>
    <label>Row Spacing (m):</label>
    <input type="number" id="gridRowSpacing" value="2" step="0.1"/>
    <label>Col Spacing (m):</label>
    <input type="number" id="gridColSpacing" value="2" step="0.1"/>
    <label>Rotation:</label>
    <div class="gridRotationContainer">
      <input type="range" id="gridRotation" min="0" max="360" value="0"/>
      <input type="number" id="gridRotationInput" min="0" max="360" value="0"/>
    </div>
    <button id="btnGridApply">Apply</button>
    <button id="btnGridCancel">Cancel</button>
  </div>

  <!-- ++++++++++++++++++++++++++++++++
       NEW: Top Menu Bar
       ++++++++++++++++++++++++++++++++ -->
  <div id="top-menu-bar">
    <!-- Left side: icon buttons -->
    <div id="menu-left-section">
      <div class="menu-button" data-title="New Project">
        <i class="fas fa-file"></i>
      </div>
      <div class="menu-button" data-title="Open Project" id="btn-open-project">
        <i class="fas fa-folder-open"></i>
      </div>
      
      <div class="menu-button" data-title="Save"    id="btn-save">
        <i class="fas fa-save"></i>
      </div>
      <div class="menu-button" data-title="Save As" id="btn-save-as">
        <i class="fas fa-copy"></i>
      </div>
      <div class="menu-button" data-title="Show Results Panel">
        <i class="fas fa-chart-bar"></i>
      </div>
      <div class="menu-button" data-title="Show Layers Panel">
        <i class="fas fa-layer-group"></i>
      </div>
      <div class="menu-button" data-title="Show Drawing Panel">
        <i class="fas fa-pencil-ruler"></i>
      </div>
      <button id="fill-button" class="modern-btn"
        style="width:120px;height:27px;font-size:13px;padding:0;
               display:inline-flex;align-items:center;justify-content:center;
               gap:4px;background-color:#005899;color:white;">
  <i class="fas fa-sync-alt" style="font-size:11px;"></i>
  <span>Update Layout</span>
</button>

      
    </div>

    <!-- Right side: Username and the new top search input -->
    <div id="menu-right-section">
      <input id="top-search-input" type="text" placeholder="Search location or coordinates">
      <span id="username">John Doe</span>
    </div>
  </div>
  <!-- END top menu bar -->

  <div id="side-panel">
    <div style="text-align: center; padding: 8px;">
      <img src="Logo.png" alt="My Logo" style="max-width: 150px;" />
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('polygon-collapse')">
        PV Area <span class="icon-indicator">+</span>
      </div>
      <div id="polygon-collapse" class="collapsible-content">
        <div class="panel-section">
          
         
          <button id="pen-button" class="modern-btn"><i class="fas fa-draw-polygon"></i>DrawÂ PVÂ Area</button>
          

          <hr class="section-separator">
          
          <h4 class="section-header">Setbacks</h4>

          <hr class="section-separator">

          
          
          <h4 class="section-header">Obstacles</h4>
          <div class="panel-section obstacles-draw-tools">
            <button id="obs-btnDrawPolygon" title="Draw Polygon">
              <i class="fas fa-draw-polygon" style="color:#ffffff; font-size:20px;"></i>
            </button>     
            
            <button id="obs-btnDrawCircle" title="Draw Circle"><span class="material-icons" style="color:#ffffff;">radio_button_unchecked</span></button>
            <button id="obs-btnDrawRect" title="Draw Rectangle"><span class="material-icons" style="color:#ffffff;">crop_square</span></button>
                
          </div>

          <hr class="section-separator">
          
          

          <table style="width:100%;font-size:12px;border-collapse:collapse;margin-bottom:6px">
            <thead>
              <tr><th style="border:1px solid #ccc;padding:2px">Type</th>
                  <th style="border:1px solid #ccc;padding:2px">Width&nbsp;(m)</th>
                  <th style="border:1px solid #ccc;padding:2px">#</th></tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid #ccc;padding:2px">Horizontal</td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input id="road-h-width" type="number" value="3" min="3" step="0.5" style="width:55px">
                </td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input id="road-h-count" type="number" value="2" min="0" step="1" style="width:45px">
                </td>
              </tr>
              <tr>
                <td style="border:1px solid #ccc;padding:2px">Vertical</td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input id="road-v-width" type="number" value="3" min="3" step="0.5" style="width:55px">
                </td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input id="road-v-count" type="number" value="2" min="0" step="1" style="width:45px">
                </td>
              </tr>
              <tr>
                <td style="border:1px solid #ccc;padding:2px">Perimeter</td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input id="road-p-width" type="number" value="3" disabled style="width:55px">
                </td>
                <td style="border:1px solid #ccc;padding:2px">
                  <input value="â€“" disabled style="width:45px">
                </td>
              </tr>
              
            </tbody>
          </table>
          
          <button id="build-roads-btn" class="modern-btn"><i class="fas fa-road"></i>BuildÂ AutoÂ Roads</button>
          <button id="draw-road-btn"   class="modern-btn"><i class="fas fa-pencil-alt"></i>DrawÂ RoadÂ Manually</button>          

          


          <hr class="section-separator">
          
          


          

        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('mounting-collapse')">
        Mounting Structure <span class="icon-indicator">+</span>
      </div>
      <div id="mounting-collapse" class="collapsible-content">
        <button id="open-mounting-catalog-btn" class="modern-btn">
          <i class="fas fa-book-open"></i>Mounting Catalog
        </button>

        <button id="open-foundation-design-btn" class="modern-btn">
          <i class="fas fa-cube"></i>Mounting Structure Foundations
        </button>


        <select id="mounting-structure-select">
          <option value="No Mounting Structure">No Mounting Structure</option>
          <option value="Rooftop Tilted">Rooftop Tilted</option>
          <option value="Rooftop Ballast 1 side">Rooftop Ballast 1 side</option>
          <option value="Rooftop Ballast 2 sides">Rooftop Ballast 2 sides</option>
          <option value="Rooftop Canopy 2P">Rooftop Canopy 2P</option>
          <option value="Fixed Ground Mounted 3L">Fixed Ground Mounted 3L</option>
          <option value="Single Axis Tracker 2P" selected>Single Axis TrackerÂ 2P</option>
          <option value="Single Axis Tracker 1P">Single Axis Tracker&nbsp;1P</option>
        </select>
        <hr/>




<table id="mounting-params-table" style="
        width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">
  <tbody>
    <tr>
      <td style="padding:4px 6px;">Row&nbsp;Space&nbsp;(m)</td>
      <td style="padding:4px 6px; width:90px;">
        <input id="row-space-input" type="number" value="0.02"
               step="0.01" min="0" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Column&nbsp;Space&nbsp;(m)</td>
      <td style="padding:4px 6px;">
        <input id="column-space-input" type="number" value="0.02"
               step="0.01" min="0" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Modules in Row</td>
      <td style="padding:4px 6px;">
        <input id="modules-in-row-input" type="number" value="30"
               step="1" min="1" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Panels&nbsp;/&nbsp;Table</td>
      <td style="padding:4px 6px;">
        <input id="panels-per-table-input" type="number" value="3"
               step="1" min="1" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Dist. between Tables&nbsp;(m)</td>
      <td style="padding:4px 6px;">
        <input id="distance-between-tables-input" type="number" value="0.5"
               step="0.1" min="0" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Table&nbsp;Space&nbsp;(m)</td>
      <td style="padding:4px 6px;">
        <input id="table-space-input" type="number" value="1"
               step="0.1" min="0" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Tilt&nbsp;Angle&nbsp;(Â°)</td>
      <td style="padding:4px 6px;">
        <input id="angle-input" type="number" value="0"
               step="1" min="0" max="90" style="width:100%;">
      </td>
    </tr>
    <tr>
      <td style="padding:4px 6px;">Orientation</td>
      <td style="padding:4px 6px;">
        <select id="orientation-select" style="width:100%;">
          <option value="portrait">Portrait</option>
          <option value="landscape">Landscape</option>
        </select>
      </td>
    </tr>

    <!-- âœ± NEW â€” Block-spacing controls (consistent padding) âœ± -->
<tr>
  <td style="padding:4px 6px;">Tables/Block NS</td>
  <td style="padding:4px 6px;">
    <input id="block-ns-size-input" type="number" min="0" step="1"
           placeholder="â€”" style="width:100%;">
  </td>
</tr>
<tr>
  <td style="padding:4px 6px;">Space/Blocks NS (m)</td>
  <td style="padding:4px 6px;">
    <input id="block-ns-space-input" type="number" min="0" step="0.1"
           placeholder="â€”" style="width:100%;">
  </td>
</tr>
<tr>
  <td style="padding:4px 6px;">Tables/Block EW</td>
  <td style="padding:4px 6px;">
    <input id="block-ew-size-input" type="number" min="0" step="1" value="5"
           placeholder="â€”" style="width:100%;">
  </td>
</tr>
<tr>
  <td style="padding:4px 6px;">Space/Blocks EW (m)</td>
  <td style="padding:4px 6px;">
    <input id="block-ew-space-input" type="number" min="0" step="0.1" value="5"
           placeholder="â€”" style="width:100%;">
  </td>
</tr>
  </tbody>
</table>

        <div class="panel-section" style="margin-top:15px;">
          <button id="clear-rectangles-button" class="modern-btn"><i class="fas fa-eraser"></i>Clear Rectangles</button>
          <label class="layout-switch">
            <span>Block</span>
            <input type="checkbox" id="layout-mode-toggle">
            <span class="slider"></span>
            <span>Adaptive</span>
          </label>



          <label style="font-size:13px;display:block;margin:6px 0 2px;">Fill from side:</label>
          <label class="layout-switch" title="Draw whole tables instead of every module">
            <span>Modules</span>
            <input type="checkbox" id="draw-tables-toggle">
            <span class="slider"></span>
            <span>Tables</span>
          </label>
          
<select id="fill-origin-select" style="width:100%;font-size:13px;">
  <option value="west">West (default)</option>
  <option value="east">East</option>
  <option value="south">South</option>
  <option value="north">North</option>
  <option value="center">Center-out</option>
</select>
          
          <button id="align-rectangles-button" class="modern-btn"><i class="fas fa-align-left"></i>Align Rectangles</button>
          
        </div>
      </div>
    </div>

    

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('inverter-collapse')">
        Inverter Tools <span class="icon-indicator">+</span>
      </div>
      <div id="inverter-collapse" class="collapsible-content">
        <div class="panel-section">
          <button id="size-inverters-button" class="modern-btn"><i class="fas fa-bolt"></i>Size Inverters</button>
        </div>
        
        <div class="panel-section">
          <h4>Distribution Options</h4>
          <label><input type="radio" name="distributionOption" id="distribute-tables" checked>Distribute to Tables</label><br>
          <label><input type="radio" name="distributionOption" id="inverter-station">Inverter Station</label>
          <button id="select-inverter-station-btn" class="modern-btn" disabled><i class="fas fa-map-marker-alt"></i>Select Inverter Station</button>
          <button id="distribute-inverters-btn" class="modern-btn"><i class="fas fa-laptop-house"></i>Distribute Inverters</button>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('cable-collapse')">
        Cable Tools <span class="icon-indicator">+</span>
      </div>
      <div id="cable-collapse" class="collapsible-content">
        <div class="panel-section">
          <button id="draw-cable-path-btn" class="modern-btn"><i class="fas fa-route"></i>Draw Cable Path</button>
          <button id="clear-cable-path-btn" class="modern-btn"><i class="fas fa-ban"></i>Clear All Cable Paths</button>
          <button id="remove-cable-path-btn" class="modern-btn"><i class="fas fa-trash"></i>Remove Selected Cable</button>
        </div>
        <div class="panel-section">
          <button id="connect-dc-cable-btn" class="modern-btn"><i class="fas fa-plug"></i>Connect DC Cable</button>
          <button id="connect-ac-cable-btn" class="modern-btn"><i class="fas fa-plug"></i>Connect AC Cable</button>
          <button id="calc-dc-length-btn" class="modern-btn"><i class="fas fa-calculator"></i>Calculate DC Cable Length</button>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('ac-combiner-collapse')">
        AC Combiner Tools <span class="icon-indicator">+</span>
      </div>
      <div id="ac-combiner-collapse" class="collapsible-content">
        <div class="panel-section">
          <button id="select-combiner-btn" class="modern-btn"><i class="fas fa-map-marker-alt"></i>Select Combiner Box Location</button>
          <button id="select-poc-btn" class="modern-btn"><i class="fas fa-map-marker-alt"></i>Select AC POC Location</button>
        </div>
        <div class="panel-section">
          <button id="assign-areas-to-combiner-btn" class="modern-btn"><i class="fas fa-project-diagram"></i>Assign Areas to Combiners</button>
          <button id="assign-combiner-to-poc-btn" class="modern-btn"><i class="fas fa-sitemap"></i>Assign Combiners to POCs</button>
        </div>
        <div class="panel-section">
          <button id="draw-inv-combiner-btn" class="modern-btn"><i class="fas fa-exchange-alt"></i>Draw INV-Combiner</button>
          <button id="draw-combiner-poc-btn" class="modern-btn"><i class="fas fa-exchange-alt"></i>Draw Combiner-POC</button>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('export-collapse')">
        Export <span class="icon-indicator">+</span>
      </div>
      <div id="export-collapse" class="collapsible-content">
        <div class="panel-section">
          <button id="export-dxf-button" class="modern-btn"><i class="fas fa-file-export"></i>Export to DXF</button>
        </div>
        <div class="panel-section">
          <button id="export-csv-button" class="modern-btn"><i class="fas fa-file-csv"></i>Export DC Cables to CSV</button>
        </div>
        <div class="panel-section">
          <button id="export-ac-assignments-button" class="modern-btn"><i class="fas fa-file-csv"></i>Export AC Assignments to CSV</button>
        </div>
        <div class="panel-section">
          <button id="export-json-button" class="modern-btn"><i class="fas fa-file-export"></i>Export Layout to JSON</button>
          <input type="file" id="import-json-input" accept=".json" style="display:none;">
          <button id="import-json-button" class="modern-btn"><i class="fas fa-file-import"></i>Import Layout from JSON</button>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('panOnd-collapse')">
        Module & Inverter DB <span class="icon-indicator">+</span>
      </div>
      <div id="panOnd-collapse" class="collapsible-content">
        <h4>Upload & Select Module (PAN) & Inverters (OND)</h4>
        <h5>PAN Files</h5>
        <div id="drop-zone-pan" class="drop-zone">Drop your .PAN files here</div>
        <label for="manufacturer-select-pan">Manufacturer:</label>
        <select id="manufacturer-select-pan">
          <option value="">-- Choose a manufacturer --</option>
        </select>
        <label for="module-select-pan">Model:</label>
        <select id="module-select-pan">
          <option value="">-- Choose a module --</option>
        </select>
        <div id="module-details-pan" class="details"></div>
        <hr/>
        <h5>OND Files</h5>
        <div id="drop-zone-ond" class="drop-zone">Drop your .OND files here</div>
        <label for="manufacturer-select-ond">Manufacturer:</label>
        <select id="manufacturer-select-ond">
          <option value="">-- Choose a manufacturer --</option>
        </select>
        
        <label for="inverter-select-ond">Model:</label>
        <select id="inverter-select-ond">
          <option value="">-- Choose an inverter --</option>
        </select>
        <button id="add-ond-inverter-btn">Add to Sizing List</button>

        
        <button id="add-ond-inverter-btn" class="modern-btn" style="margin-top:5px;">
          <i class="fas fa-plus"></i>Add to Sizing List
        </button>
        <div id="inverter-details-ond" class="details"></div>
        <button id="btn-save-inverter-lib" class="modern-btn">
  Save Inverter Library
</button>

      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('electrical-design-collapse')">
        Electrical Design <span class="icon-indicator">+</span>
      </div>
      <div id="electrical-design-collapse" class="collapsible-content">
        <button id="open-electrical-design-btn" class="modern-btn">
          <i class="fas fa-project-diagram"></i>Single Line Diagram
        </button>
      </div>
    </div>

    <!-- New collapsible section for BOQ -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('boq-collapse')">
        BOQ <span class="icon-indicator">+</span>
      </div>
      <div id="boq-collapse" class="collapsible-content">
        <button id="boq-tools-button" class="modern-btn">
          <i class="fas fa-list-alt"></i> BOQ Tools
        </button>
      </div>
    </div>

    <!-- === MEASUREMENT SECTION ADDED === -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('measure-collapse')">
        Measurement <span class="icon-indicator">+</span>
      </div>
      <div id="measure-collapse" class="collapsible-content">
        <button id="measure-distance-btn" class="modern-btn">
          <i class="fas fa-ruler-combined"></i>Measure Distance
        </button>
      </div>
    </div>
    <!-- === END MEASUREMENT SECTION === -->






  </div>

  <div id="info-bar" style="display:none;">
    <div id="info-bar-header">
      <span>Results Panel</span>
      <button id="info-bar-close">âœ•</button>
    </div>
    <div id="info-bar-body">
      <p id="panel-count">Number of Panels: 0</p>
      <p id="kwp-value">Total kWp: 0.00</p>
      <div id="area-capacity-info" style="margin-top:10px;"></div>
      <div id="cable-length-info"></div>
    </div>
  </div>

  <div id="callout-box"></div>

  <!-- NEW or UPDATED: Inverter Sizing header with Zoom buttons + close -->
 <!-- INVERTER SIZING MODAL - brand-new layout -->
 <div id="inverter-sizing-modal">
  <div id="inverter-sizing-header">
    <!-- Left Title -->
    <div class="header-left">
      <h2>Inverter Sizing</h2>
    </div>
    <!-- Right: Zoom + Close -->
    <div class="header-right">
      <button id="inv-zoom-in">Zoom In</button>
      <button id="inv-zoom-out">Zoom Out</button>
      <button id="close-inverter-sizing-btn">X</button>
    </div>
  </div>

  <!-- The 2-column interior -->
  <div id="inverter-sizing-content">
    <!-- Left column: single-column stacked inverters -->
    <div class="inverter-sizing-leftcol">
      <h3 class="column-title">1) Pick Inverters</h3>

      <!-- Inverter #1 -->
      <div class="inv-card">
        <div class="inv-card-top">
          <input type="checkbox" id="invChk1" class="inverter-checkbox" />
          <span class="inv-card-title" id="inv1Label">SUN2000MA-20KTL-M0</span>
        </div>
        <div class="inv-card-bottom">
          <label>Change to:</label>
          <select id="inv1Manuf">
            <option value="">-- Mfr --</option>
          </select>
          <select id="inv1Model">
            <option value="">-- Model --</option>
          </select>
          <button id="btnInv1Replace" class="tiny-replace-btn">R</button>
        </div>
      </div>

      <!-- Inverter #2 -->
      <div class="inv-card">
        <div class="inv-card-top">
          <input type="checkbox" id="invChk2" class="inverter-checkbox" />
          <span class="inv-card-title" id="inv2Label">Huawei_SUN2000-60KTL-M0</span>
        </div>
        <div class="inv-card-bottom">
          <label>Change to:</label>
          <select id="inv2Manuf"></select>
          <select id="inv2Model"></select>
          <button id="btnInv2Replace" class="tiny-replace-btn">R</button>
        </div>
      </div>
     

      <!-- Inverter #3 -->
      <div class="inv-card">
        <div class="inv-card-top">
          <input type="checkbox" id="invChk3" class="inverter-checkbox" />
          <span class="inv-card-title" id="inv3Label">Sungrow_SG110CX_Pvsyst668</span>
        </div>
        <div class="inv-card-bottom">
          <label>Change to:</label>
          <select id="inv3Manuf"></select>
          <select id="inv3Model"></select>
          <button id="btnInv3Replace" class="tiny-replace-btn">R</button>
        </div>
      </div>

      <!-- Inverter #4 -->
      <div class="inv-card">
        <div class="inv-card-top">
          <input type="checkbox" id="invChk4" class="inverter-checkbox" />
          <span class="inv-card-title" id="inv4Label">SG250HX</span>
        </div>
        <div class="inv-card-bottom">
          <label>Change to:</label>
          <select id="inv4Manuf"></select>
          <select id="inv4Model"></select>
          <button id="btnInv4Replace" class="tiny-replace-btn">R</button>
        </div>
      </div>

      <!-- Inverter #5 -->
      <div class="inv-card">
        <div class="inv-card-top">
          <input type="checkbox" id="invChk5" class="inverter-checkbox" />
          <span class="inv-card-title" id="inv5Label">SUN2000-330KTL-H2</span>
        </div>
        <div class="inv-card-bottom">
          <label>Change to:</label>
          <select id="inv5Manuf"></select>
          <select id="inv5Model"></select>
          <button id="btnInv5Replace" class="tiny-replace-btn">R</button>
        </div>
      </div>
    </div>
    <!-- end inverter-sizing-leftcol -->

    <!-- Right column: environment fields & calculate -->
    <div class="inverter-sizing-rightcol">
      <h3 class="column-title">2) Environment</h3>
      <div class="env-fields">
        
        <label for="powerFactor">Power Factor</label>
        <input type="number" id="powerFactor" type="number" step="0.01" min="0.5" max="1"
        value="0.9">


        <label for="lowestTemp">Lowest (Â°C)</label>
        <input type="number" id="lowestTemp" value="-10" step="1">

        <label for="highestTemp">Highest (Â°C)</label>
        <input type="number" id="highestTemp" value="40" step="1">

        <label for="desiredDcCapacity">Desired DC (kW)</label>
        <input type="number" id="desiredDcCapacity" value="100" step="0.1">

        <label for="minDcRatio">Min DC/AC Ratio</label>
        <input type="number" id="minDcRatio" value="0.8" step="0.01">

        <label for="maxDcRatio">Max DC/AC Ratio</label>
        <input type="number" id="maxDcRatio" value="1.3" step="0.01">
      </div>
       <label>
        <input type="checkbox" id="enableMVSystem">
        Use MV System
      </label>
      <div id="mvSubstationsContainer" style="display: none;">
        <label>Substation MVA Sizes (comma separated):</label>
        <input type="text" id="mvSubstationSizes" placeholder="e.g. 5,2" />
      </div>      

      <button type="button" onclick="calculateSizing()" class="calc-btn">
        <i class="fas fa-calculator"></i> Calculate Sizing
      </button>
    </div>
    <!-- end inverter-sizing-rightcol -->
  </div>
  <!-- end #inverter-sizing-content -->

  <!-- Results area below the columns -->
  <div id="inverter-sizing-results">
    <!-- your JS will fill "result" with simpler table, e.g.:
         Rank | DC (kW) | AC (kW) | DC/AC | Â±DC | Â±Ratio | Score | Action
    -->
    <div id="result"></div>
  </div>
</div>
<!-- ==============================
     END INVERTER SIZING MODAL
     ============================== -->

  <div id="acCombinerModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">Assign Areas to Combiners</div>
      <div id="acCombinerModalBody"></div>
      <div class="modal-actions">
        <button id="saveAreasToCombinerBtn" class="modern-btn">Save</button>
        <button id="closeAcCombinerModal" class="modern-btn close-btn">Close</button>
      </div>
    </div>
  </div>

  <div id="pocAssignmentModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-title">Assign Combiners to POCs</div>
      <div id="pocAssignmentModalBody"></div>
      <div class="modal-actions">
        <button id="saveCombinerToPocBtn" class="modern-btn">Save</button>
        <button id="closePocAssignmentModal" class="modern-btn close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Foundations Popout -->
  <div id="foundation-design-popout">
    <div id="foundation-design-header">
      <div id="foundation-header-left">
        <button id="foundation-zoom-in" style="background:#555;color:#fff;border:none;padding:4px 8px;cursor:pointer;">
          Zoom In
        </button>
        <button id="foundation-zoom-out" style="background:#555;color:#fff;border:none;padding:4px 8px;cursor:pointer;">
          Zoom Out
        </button>
        <button id="foundation-reset-view">Reset View</button>
        <button id="create-mounting-btn" style="margin: 10px 0;">Update</button>
      </div>
      <button id="close-foundation-design-btn">X</button>
    </div>

    <div id="foundation-design-content">
      <div id="foundation-design-container">
        <main id="foundation-drawing-area">
          <div id="foundation-summary-table"></div>
          <svg id="foundation-svg"></svg>
        </main>
      </div>
    </div>
  </div>

  <!-- Electrical Design Popout -->
  <div id="electrical-design-popout">
    <div id="electrical-design-header">
      <div id="ed-header-left">
        <button id="ed-zoom-in" style="background:#555;color:#fff;border:none;padding:4px 8px;cursor:pointer;">Zoom In</button>
        <button id="ed-zoom-out" style="background:#555;color:#fff;border:none;padding:4px 8px;cursor:pointer;">Zoom Out</button>
      </div>
      <button id="close-electrical-design-btn">X</button>
    </div>
    <div id="electrical-design-content">
      <div id="ed-container">
        <div id="ed-systemConfigModal">
          <div class="modal-content">
            <h2>System Configuration</h2>
            <label for="ed-systemVoltage">Voltage</label>
            <input id="ed-systemVoltage" type="number" value="400"/>
            <button id="ed-btnAlignTop">Align Top</button>
            <button id="ed-btnDistributeHorizontally">Distribute Horizontally</button>

            <label for="ed-pocCount">Number of POCs</label>
            <input type="number" id="ed-pocCount" min="1" value="1"/>
            <label for="ed-combinerCount">Number of Combiner Boxes</label>
            <input type="number" id="ed-combinerCount" min="1" value="2"/>
            <label for="ed-inverterCount">Number of Inverters</label>
            <input type="number" id="ed-inverterCount" min="1" value="5"/>

            <h3>Combiner â†’ POC Association</h3>
            <table class="assoc-table" id="ed-combinerToPocTable">
              <thead>
                <tr>
                  <th>Combiner #</th>
                  <th>Associated POC</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <h3>Inverter â†’ Combiner Association</h3>
            <table class="assoc-table" id="ed-inverterToCombinerTable">
              <thead>
                <tr>
                  <th>Inverter #</th>
                  <th>Associated Combiner</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div style="text-align:right;margin-top:1rem;">
              <button id="ed-btnApplyConfig">Apply</button>
              <button id="ed-btnCancelConfig">Cancel</button>
            </div>
          </div>
        </div>
        <main id="ed-drawing-area">
          <svg id="ed-cable-layer"></svg>
          <div id="ed-selection-box"></div>
        </main>
      </div>
    </div>
  </div>

  <!-- ---------- ADDED: Layers Panel (mid-left) ---------- -->
  <div id="layer-panel" style="display:none;">
    <div id="layer-header">
      <span>Layers</span>
      <button id="layer-close">âœ•</button>
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-pv-areas" checked>
      <i class="fas fa-eye"></i>Â PV Areas
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-pv-modules" checked>
      <i class="fas fa-eye"></i>Â PV Modules
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-obstacles" checked>
      <i class="fas fa-eye"></i>Â Obstacles
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-inverters" checked>
      <i class="fas fa-eye"></i>Â Inverters
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-cables" checked>
      <i class="fas fa-eye"></i>Â DCÂ Cables/Paths
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-combiners" checked>
      <i class="fas fa-eye"></i>Â Combiners
    </div>
    <div class="layer-toggle-item">
      <input type="checkbox" id="toggle-pocs" checked>
      <i class="fas fa-eye"></i>Â POCs
    </div>
  </div>

  <div id="drawing-controls-panel" style="display:none;">
    <div id="drawing-controls-header">
      <span>Drawing Controls</span>
      <button id="drawing-controls-close">âœ•</button>
    </div>
    <div id="drawing-controls-body" class="obstacles-draw-tools">
      <!-- All your drawing buttons move here -->
      <button id="obs-btnCopy" title="Copy"><span class="material-icons" style="color:#2196f3;">content_copy</span></button>
      <button id="obs-btnPaste" title="Paste (One-Time)"><span class="material-icons" style="color:#4caf50;">content_paste</span></button>
      <button id="obs-btnPasteMultiple" title="Paste Multiple"><span class="material-icons" style="color:#9c27b0;">layers</span></button>
      <button id="obs-btnToggleRotation" title="Rotate"><span class="material-icons" style="color:#009688;">rotate_right</span></button>
      <button id="obs-btnGrid" title="Grid"><span class="material-icons" style="color:#f44336;">grid_on</span></button>
      <button id="obs-btnAlignTop" title="Align Top"><span class="material-icons" style="color:#795548;">vertical_align_top</span></button>
      <button id="obs-btnAlignBottom" title="Align Bottom"><span class="material-icons" style="color:#795548;">vertical_align_bottom</span></button>
      <button id="obs-btnDistributeH" title="Distribute Horizontally"><span class="material-icons" style="color:#795548;">align_horizontal_center</span></button>
      <button id="obs-btnDistributeV" title="Distribute Vertically"><span class="material-icons" style="color:#795548;">align_vertical_center</span></button>
      <button id="obs-btnDelete" title="Delete"><span class="material-icons" style="color:#f44336;">delete</span></button>
    </div>
  </div>
  


  <!-- Mounting Catalog Popout -->
  <div id="mounting-catalog-popout">
    <div id="mounting-catalog-header">
      <div id="mounting-catalog-title">
        <span>Mounting Catalog</span>
      </div>
      <button id="close-mounting-catalog-btn">X</button>
    </div>
    <div id="mounting-catalog-content">
      <div id="mounting-catalog-grid">
        <div class="mounting-catalog-item" data-value="Fixed Ground Mounted 3L">
          <img src="MMS_IMAGES\GM 3L.jpg" alt="Fixed Ground" />
          <span>Fixed Ground Mounted 3L</span>
        </div>

        <div class="mounting-catalog-item" data-value="Rooftop Tilted">
          <img src="MMS_IMAGES\Rooftop tilted.jpg" alt="Rooftop Tilted" />
          <span>Rooftop Tilted</span>
        </div>

        <div class="mounting-catalog-item" data-value="Rooftop Ballast 1 side">
          <img src="MMS_IMAGES\RT Ballasted.png" alt="Rooftop Ballast 1 side" />
          <span>Rooftop Ballast (1 side)</span>
        </div>

        <div class="mounting-catalog-item" data-value="Rooftop Ballast 2 sides">
          <img src="MMS_IMAGES\RT Ballasted two Sides.jpg" alt="Rooftop Ballast 2 sides" />
          <span>Rooftop Ballast (2 Sides)</span>
        </div>

        <div class="mounting-catalog-item" data-value="Rooftop Canopy 2P">
          <img src="MMS_IMAGES\RT 2P.jpg" alt="Rooftop Canopy 2P" />
          <span>Rooftop Canopy 2P</span>
        </div>

        <div class="mounting-catalog-item" data-value="Single Axis Tracker 2P">
          <img src="MMS_IMAGES\Single Axes 2p.jpg" alt="Single Axis Tracker 2P" />
          <span>Single Axis Tracker 2P</span>
        </div>

        <div class="mounting-catalog-item" data-value="Single Axis Tracker 1P"> 
          <img src="MMS_IMAGES/Single Axes 1p.jpg" alt="Single Axis Tracker 1P" />
          <span>Single Axis Tracker&nbsp;1P</span>
        </div>
      </div>
    </div>
  </div>

  <input id="open-project-input"
       type="file"
       accept=".pvproj,application/json"
       style="display:none;">
``` :contentReference[oaicite:4]{index=4}&#8203;:contentReference[oaicite:5]{index=5}

<script src="ProjectIO.js"></script>


  
  <script>
    /*
      ---------------------------------------------------------------
      0) NEW: Create a global results object to track info for BOQ
      ---------------------------------------------------------------
    */
    window.boqResults = {
      numberOfModules: 0,
      moduleCapacityWp: 0,
      totalSystemCapacityKwp: 0,
      inverters: [],
      mounting: [],  
      dcCablesAllStrings: []
    };
    window.realCableDistances = {}; 
    window.allInverters = [];  // optional: we can gather each polygonâ€™s inverters here if needed

  </script>

 
  <!-- Main Code Script (including bridging logic) -->
  <script>
 

    /* ---------------------------------------------------------------
       Original Main Code JavaScript (unchanged except where noted)
       --------------------------------------------------------------- */
    function toggleCollapse(id){
      const c = document.getElementById(id);
      if(!c) return;
      c.classList.toggle("open");
      const i = c.previousElementSibling.querySelector(".icon-indicator");
      if(i) i.textContent = c.classList.contains("open") ? "-" : "+";
    }

    let map, drawingManager, polygon = null, polygonCount = 0;
    let obstaclePolygons = [], userPolygons = [], selectedPolygon = null, selectedEdge = null;
    let marker = null, lastPanelCount = 0, lastChosenSolution = null;
    let polygonStationMarkerMap = new Map(), polygonInverterBoxesMap = new Map(), polygonRectanglesMap = new Map();
    let cablePaths = [], selectedCable = null;
    let selectedModuleWidth=2.2, selectedModuleHeight=1.1, selectedModuleWatt=590, selectedModuleVoc=49, selectedModuleVmp=40, selectedModuleIsc=10;
    let obstacleMode = false;  // <--- NEW: set to true when user draws obstacles

    let selectedModuleBetaVoc = -0.3;   // %/Â°C, update when the user picks a module


    
    window.userPolygons = userPolygons;
    window.obstaclePolygons      = obstaclePolygons;
    window.polygonRectanglesMap = polygonRectanglesMap;

    const mountingStructuresDefaults = {
      "No Mounting Structure": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:1, panels:1,
        distanceBetweenTables:0.02, tableSpace:0.5, orientation:"landscape", angle: 0
      },
      "Rooftop Tilted": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:1, panels:4,
        distanceBetweenTables:.02, tableSpace:1, orientation:"portrait", angle: 0
      },
      "Rooftop Ballast 1 side": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:1, panels:1,
        distanceBetweenTables:0.02, tableSpace:0.5, orientation:"portrait", angle: 0
      },
      "Rooftop Ballast 2 sides": {
        rowSpace:0.02, columnSpace:0.1, modulesInRow:1, panels:2,
        distanceBetweenTables:0.02, tableSpace:0.5, orientation:"portrait", angle: 90
      },
      "Rooftop Canopy 2P": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:1, panels:2,
        distanceBetweenTables:0.02, tableSpace:3, orientation:"landscape", angle: 0
      },
      "Fixed Ground Mounted 3L": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:10, panels:3,
        distanceBetweenTables:0.5, tableSpace:4, orientation:"portrait", angle: 0
      },
      "Single Axis Tracker 2P": {
        rowSpace:0.02, columnSpace:0.02, modulesInRow:20, panels:2,
        distanceBetweenTables:0.5, tableSpace:5, orientation:"landscape", angle: 90
      },
      "Single Axis Tracker 1P": {                     // NEW
        rowSpace: 0.02, columnSpace: 0.02, modulesInRow: 20, panels: 1,                   
        distanceBetweenTables: 0.5, tableSpace: 3, orientation: "landscape", angle: 90                    
      },
      
    };

    let ondInverterList = [];
    const predefinedInverters = [
  { ...window.inverterLibrary.find(x => x.name?.includes("20KTL-M0")) },
  { ...window.inverterLibrary.find(x => x.name?.includes("60KTL-M0")) },
  { ...window.inverterLibrary.find(x => x.name?.includes("SG110CX")) },
  { ...window.inverterLibrary.find(x => x.name?.includes("SG250HX")) },
  { ...window.inverterLibrary.find(x => x.name?.includes("330KTL")) }
];

    // AC Combiner / POC info
    let acCombiners = []; // { id, marker }
    let acPocs      = []; // { id, marker }
    let combinerCounter=0;
    let pocCounter=0;
    let areaToCombinerMap = {}; // key: areaIndex, value: combinerId
    let combinerToPocMap = {};  // key: combinerId, value: pocId

    let isSelectingInverterStation = false;
    let isSelectingCombiner        = false;
    let isSelectingPoc             = false;

    // NEW LINES ADDED (Inv->Combiner / Combiner->POC)
    let invCombinerPolylines = [];
    let combinerPocPolylines = [];


    let deliveryStationMarker  = null;
    let isSelectingDeliveryStation = false;
    let mvPolylines            = [];      // the drawn MV lines
    let trenchPolyline = null;
    let isDrawingTrench = false;


    let layoutMode = "adaptive";          // default

document.getElementById("layout-mode-toggle")
        .addEventListener("change", e=>{
          layoutMode = e.target.checked ? "adaptive" : "block";
        });

        let fillOrigin = "west";      // default
document.getElementById("fill-origin-select")
        .addEventListener("change", e => fillOrigin = e.target.value);

        let drawMode = "module";

document.getElementById("draw-tables-toggle")
        .addEventListener("change", e => {
          drawMode = e.target.checked ? "table" : "module";
});

const polygonTableOutlinesMap = new Map();




    function initMap(){
      const c = {lat:38.4000, lng:34.9780};
      map = new google.maps.Map(document.getElementById("map"), {
        zoom:18,
        center:c,
        mapTypeId:google.maps.MapTypeId.SATELLITE
      });

      map = new google.maps.Map(document.getElementById("map"), {
  center: {lat:38.4000, lng:34.9780},
  zoom: 19,
  mapTypeId: google.maps.MapTypeId.SATELLITE,

  // Turn on each control and push it to top-right:
  zoomControl: false,
  zoomControlOptions: {
    position: google.maps.ControlPosition.TOP_RIGHT
  },

  streetViewControl: false,
  streetViewControlOptions: {
    position: google.maps.ControlPosition.TOP_RIGHT
  },

  mapTypeControl: false,
  mapTypeControlOptions: {
    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR, // forces horizontal map/satellite toggles
    position: google.maps.ControlPosition.TOP_RIGHT
  },

  fullscreenControl: false,
  fullscreenControlOptions: {
    position: google.maps.ControlPosition.TOP_RIGHT
  }
});



      drawingManager = new google.maps.drawing.DrawingManager({
        drawingControl:false,
        polygonOptions: {
    fillColor: "#FF0000", fillOpacity: 0.15, strokeColor: "#FF0000", strokeWeight: 2,
    clickable: true, editable: true, zIndex: 1
  }
      });
      drawingManager.setMap(map);

      document.getElementById("pen-button").addEventListener("click", toggleDrawingPolygon);
     
      document.getElementById("align-rectangles-button").addEventListener("click", alignRectanglesToEdge);
      document.getElementById("fill-button")
        .addEventListener("click", () => {
          if (!selectedPolygon) {
            alert("No polygon selected to fill.");
            return;
          }
          clearRectangles(false);      // wipe old modules silently
          if (layoutMode === "adaptive") {
            fillAdaptive(selectedPolygon);
          } else {
            fillBlock(selectedPolygon);
          }
          displayAllCapacities();
        });

/* ===== ROAD drawing ===== */
document.getElementById("draw-road-btn").addEventListener("click", () => {
  drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYLINE);

  google.maps.event.addListenerOnce(drawingManager, "polylinecomplete", pl => {
    const polyPath = pl.getPath().getArray();
    pl.setMap(null);                      // remove centreâ€‘line

    /* 1. build buffered polygon */
    const roadPolyCoords = polylineToRoadPolygon(polyPath);
    const roadPoly = new google.maps.Polygon({
      paths       : roadPolyCoords,
      fillColor   : "#777",
      fillOpacity : 0.5,
      strokeColor : "#555",
      strokeWeight: 1,
      map         : map
    });

    /* 2. add to obstaclePolygons so modules avoid it */
    obstaclePolygons.push(roadPoly);

    drawingManager.setDrawingMode(null);  // exit drawing mode
  });
});






      document.getElementById("clear-rectangles-button").addEventListener("click",()=>clearRectangles(true));
      document.getElementById("mounting-structure-select").addEventListener("change", setMountingDefaults);
      document.getElementById("size-inverters-button").addEventListener("click", openInverterSizingModal);
      document.getElementById("calc-dc-length-btn").addEventListener("click", () => calculateDcCableLength());



     



      document.getElementById("boq-tools-button").addEventListener("click", () => {
        // Calculate 90% of the available screen width & height
        const w = Math.floor(window.screen.availWidth * 0.90);
        const h = Math.floor(window.screen.availHeight * 0.90);
        window.open(
          "BOQ.html",
          "boqWindow",
          `width=${w},height=${h},menubar=no,location=no,resizable=yes,scrollbars=yes,status=no,toolbar=no`
        );
      });

      const distributeTablesRadio = document.getElementById("distribute-tables");
      const inverterStationRadio = document.getElementById("inverter-station");
      const selectInverterBtn = document.getElementById("select-inverter-station-btn");
      const distributeInvertersBtn = document.getElementById("distribute-inverters-btn");

      distributeTablesRadio.addEventListener("change", ()=>{
        selectInverterBtn.disabled = true;
      });
      inverterStationRadio.addEventListener("change", ()=>{
        selectInverterBtn.disabled = false;
      });
      selectInverterBtn.addEventListener("click", ()=>{
        if(!selectedPolygon){  return; }
        if(!isSelectingInverterStation){
          isSelectingInverterStation = true;
          selectInverterBtn.classList.add("active-button");
         
        } else {
          isSelectingInverterStation = false;
          selectInverterBtn.classList.remove("active-button");
          alert("Inverter station selection mode off.");
        }
      });
      distributeInvertersBtn.addEventListener("click", ()=>{
        if(!selectedPolygon){
          
          return;
        }
        if(distributeTablesRadio.checked){
          distributeInvertersOnLayout(selectedPolygon);
        } else {
          distributeInvertersAroundStation(selectedPolygon);
        }
      });

      document.getElementById("draw-cable-path-btn").addEventListener("click", ()=>drawCablePath());
      document.getElementById("clear-cable-path-btn").addEventListener("click", ()=>clearCablePath());
      document.getElementById("remove-cable-path-btn").addEventListener("click", ()=>removeSelectedCable());
      document.getElementById("connect-dc-cable-btn").addEventListener("click", ()=>connectDcCable());
      document.getElementById("connect-ac-cable-btn").addEventListener("click", ()=>connectAcCable());
      document.getElementById("calc-dc-length-btn").addEventListener("click", ()=>calculateDcCableLength());
      document.getElementById("export-dxf-button").addEventListener("click", ()=>exportToDXF());
      document.getElementById("export-csv-button").addEventListener("click", ()=>exportToCSV());
      document.getElementById("export-json-button").addEventListener("click", ()=>exportLayoutToJSON());
      document.getElementById("import-json-button").addEventListener("click", ()=>{
        document.getElementById("import-json-input").click();
      });
      document.getElementById("import-json-input").addEventListener("change", handleImportJSON);

      // AC Combiner Tools
      document.getElementById("select-combiner-btn").addEventListener("click", toggleSelectCombiner);
      document.getElementById("select-poc-btn").addEventListener("click", toggleSelectPoc);
      document.getElementById("assign-areas-to-combiner-btn").addEventListener("click", openCombinerAssignmentModal);
      document.getElementById("assign-combiner-to-poc-btn").addEventListener("click", openPocAssignmentModal);
      document.getElementById("export-ac-assignments-button").addEventListener("click", exportACAssignmentsToCSV);
      document.getElementById("saveAreasToCombinerBtn").addEventListener("click", saveAreasToCombiner);
      document.getElementById("closeAcCombinerModal").addEventListener("click", ()=>closeModal("acCombinerModal"));
      document.getElementById("saveCombinerToPocBtn").addEventListener("click", saveCombinerToPoc);
      document.getElementById("closePocAssignmentModal").addEventListener("click", ()=>closeModal("pocAssignmentModal"));

      // NEW LINES ADDED (Inv->Combiner / Combiner->POC) => event listeners
      document.getElementById("draw-inv-combiner-btn").addEventListener("click", drawAllInvToCombinerLines);
      document.getElementById("draw-combiner-poc-btn").addEventListener("click", drawAllCombinerToPocLines);



      // Search box
      const input = document.getElementById("top-search-input");

      const searchBox = new google.maps.places.SearchBox(input);
      searchBox.addListener("places_changed", ()=>{
        const places = searchBox.getPlaces();
        if(!places.length) return;
        if(marker) marker.setMap(null);
        const p = places[0];
        if(p.geometry){
          map.panTo(p.geometry.location);
          map.setZoom(18);
          marker = new google.maps.Marker({
            map,
            position:p.geometry.location,
            icon:{
              path:google.maps.SymbolPath.CIRCLE,
              fillColor:"red", fillOpacity:1,
              strokeColor:"red", strokeWeight:2,
              scale:2
            }
          });
        }
      });

      // Keydown for deleting polygons or cables
      document.addEventListener("keydown", e => {

if (e.key !== "Delete" && e.key !== "Backspace") return;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  A) delete a selected PV-area polygon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if (selectedPolygon) {

  /* 1. wipe per-module rectangles (module-mode) */
  if (polygonRectanglesMap.has(selectedPolygon)) {
    polygonRectanglesMap.get(selectedPolygon).forEach(r => r.setMap(null));
    polygonRectanglesMap.delete(selectedPolygon);
  }

  /* 2. wipe per-table outlines (table-mode) â€“ NEW */
  if (polygonTableOutlinesMap.has(selectedPolygon)) {
    polygonTableOutlinesMap.get(selectedPolygon).forEach(o => o.setMap(null));
    polygonTableOutlinesMap.delete(selectedPolygon);
  }

  /* 3. clean up everything else tied to that polygon */
  removeStationMarker(selectedPolygon);               // inverter station
  clearInverterBoxesForPolygon(selectedPolygon);      // white inverter boxes
  selectedPolygon.setMap(null);                       // remove the area itself

  /* 4. drop references from the global arrays */
  let i = obstaclePolygons.indexOf(selectedPolygon);
  if (i > -1) obstaclePolygons.splice(i, 1);

  i = userPolygons.indexOf(selectedPolygon);
  if (i > -1) userPolygons.splice(i, 1);

  selectedPolygon = null;                 // fully deselect
  updateInfo(0);
  displayAllCapacities();
  return;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  B) delete a selected cable polyline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if (selectedCable) {
  const i = cablePaths.indexOf(selectedCable);
  if (i > -1) cablePaths.splice(i, 1);
  selectedCable.setMap(null);
  selectedCable = null;
}
});

      // Map click => handle station/combiner/poc placement or polygon deselect
      map.addListener("click", e=>{
        // === MEASUREMENT FEATURE: check if measureMode is ON
        if (measureMode) {
          addMeasurePoint(e.latLng);
          return; 
        }
        if(isSelectingInverterStation){
          if(!selectedPolygon){ return; }
          placeStationMarkerForPolygon(selectedPolygon, e.latLng);
          isSelectingInverterStation=false;
          selectInverterBtn.classList.remove("active-button");
          
          return;
        }
        if(isSelectingCombiner){
          combinerCounter++;
          placeCombinerMarker(e.latLng, combinerCounter);
          isSelectingCombiner=false;
          document.getElementById("select-combiner-btn").classList.remove("active-button");
          
          return;
        }
        if(isSelectingPoc){
          pocCounter++;
          placePocMarker(e.latLng, pocCounter);
          isSelectingPoc=false;
          document.getElementById("select-poc-btn").classList.remove("active-button");
          
          return;
        }
        if(selectedPolygon){
          if(!google.maps.geometry.poly.containsLocation(e.latLng, selectedPolygon)){
            deselectPolygon();
          }
        }

        if (isSelectingDeliveryStation) {
  placeDeliveryStationMarker(e.latLng);
  isSelectingDeliveryStation = false;
  document.getElementById("select-delivery-btn").classList.remove("active-button");
  
  return;
}



      });

      // Also handle a double-click to end measuring if measureMode is true
      map.addListener("dblclick", e => {
        if (measureMode) {
          e.stop();
          toggleMeasureDistance(); 
        }
      });

      // If you have obstacles init
      if(typeof initObstacles==="function"){
        initObstacles(map, drawingManager);
      }

      // ---------- ADDED: layer toggle event listeners ----------
      document.getElementById("toggle-pv-areas").addEventListener("change",(e)=>{
        setPvAreasVisibility(e.target.checked);
      });
      document.getElementById("toggle-pv-modules").addEventListener("change",(e)=>{
        setPvModulesVisibility(e.target.checked);
      });
      document.getElementById("toggle-obstacles").addEventListener("change",(e)=>{
        setObstaclesVisibility(e.target.checked);
      });
      document.getElementById("toggle-inverters").addEventListener("change",(e)=>{
        setInvertersVisibility(e.target.checked);
      });
      document.getElementById("toggle-cables").addEventListener("change",(e)=>{
        setCablesVisibility(e.target.checked);
      });
      document.getElementById("toggle-combiners").addEventListener("change",(e)=>{
        setCombinersVisibility(e.target.checked);
      });
      document.getElementById("toggle-pocs").addEventListener("change",(e)=>{
        setPocsVisibility(e.target.checked);
      });

      // === MEASUREMENT FEATURE: button event
      document.getElementById("measure-distance-btn").addEventListener("click", toggleMeasureDistance);

      /* NEW or UPDATED: Drag each modal, plus close & zoom handlers */
      makeModalDraggable(
        document.getElementById("inverter-sizing-modal"),
        document.getElementById("inverter-sizing-header")
      );
      makeModalDraggable(
        document.getElementById("electrical-design-popout"),
        document.getElementById("electrical-design-header")
      );
      document.getElementById("drawing-controls-panel").style.display = "block";
document.getElementById("layer-panel").style.display = "block";
document.getElementById("info-bar").style.display = "block";
// NEW Lines
populateInverterSelectors();

document.getElementById("panel-count").style.display = "none";
document.getElementById("kwp-value").style.display = "none";
document.getElementById("area-capacity-info").innerHTML = "";
    }


    window.onload = initMap;


    function populateAllPredefinedInverterDropdowns() {
  if (!window.inverterLibrary || !window.inverterLibrary.length) {
    console.warn("No inverterLibrary loaded or empty.");
    return;
  }

  // Collect all manufacturer names from either 'manufacturer' or 'Manufacturer'
  const allMakers = window.inverterLibrary.map(inv =>
    inv.manufacturer || inv.Manufacturer
  );
  // remove duplicates, filter undefined, then sort
  const manufacturers = [...new Set(allMakers)].filter(Boolean).sort();


  // We have 5 placeholders: inv1Manuf, inv2Manuf, ...
  for (let i = 1; i <= 5; i++) {
    const manSel = document.getElementById("inv" + i + "Manuf");
    const modSel = document.getElementById("inv" + i + "Model");
    if (!manSel || !modSel) continue;

    // Clear
    manSel.innerHTML = '<option value="">-- Mfr --</option>';
    modSel.innerHTML = '<option value="">-- Model --</option>';

    // Fill manufacturer dropdown
    manufacturers.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      manSel.appendChild(opt);
    });

    // On manufacturer change => rebuild model list
    manSel.addEventListener("change", () => {
      const chosen = manSel.value;
      // Filter the library by the chosen manufacturer
      const sub = window.inverterLibrary.filter(x => {
        const mf = x.manufacturer || x.Manufacturer; // fallback
        return mf === chosen;
      });
      // Sort by AC power or anything you like
      sub.sort((a, b) => (a.acPower || 0) - (b.acPower || 0));

      modSel.innerHTML = '<option value="">-- Model --</option>';
      sub.forEach(inv => {
        // The name or model might exist in either property
        const label      = inv.model || inv.name || "Unknown Model";
        const ratedPower = inv.acPower || 0;
        const opt = document.createElement("option");
        // Usually we store the library's 'name' as the unique key:
        opt.value = inv.name;
        // Display like: "(40 kW) Sungrow_SG40CX"
        opt.textContent = `(${ratedPower} kW) ${label}`;
        modSel.appendChild(opt);
      });
    });
  }
}

function setupPredefinedReplaceButtons() {
  for (let i = 1; i <= 5; i++) {
    const btn = document.getElementById("btnInv" + i + "Replace");
    if (!btn) continue;
    btn.addEventListener("click", () => replacePredefinedInverter(i));
  }
}

function replacePredefinedInverter(index) {
  const manSel = document.getElementById("inv" + index + "Manuf");
  const modSel = document.getElementById("inv" + index + "Model");
  const lbl    = document.getElementById("inv" + index + "Label");
  if (!manSel || !modSel || !lbl) return;

  const chosenMf = manSel.value;
  const chosenMd = modSel.value;
  if (!chosenMf || !chosenMd) {
    alert("Pick Manufacturer and Model first!");
    return;
  }

  // find the matching object in the library
  const found = window.inverterLibrary.find(x => {
    const mf = x.manufacturer || x.Manufacturer;
    return mf === chosenMf && x.name === chosenMd;
  });
  if (!found) {
    alert("No matching inverter found in the library!");
    return;
  }

  // Update the visible label
  lbl.textContent = found.name || found.model;

  // Also update your local â€œpredefinedInverters[index - 1]â€
  predefinedInverters[index - 1] = { ...found };

  console.log("Inverter #" + index + " replaced with: ", found);
}





/* â–‘â–‘â–‘â–‘â–‘  Roadâ€‘builder helpers  â–‘â–‘â–‘â–‘â–‘ */
function metresToLat(m){ return m/111320; }
function metresToLng(m,lat){ return m/(111320*Math.cos(lat*Math.PI/180)); }

/* build a buffered rectangle for a straight road segment  */
function bufferedStripe(p1,p2,halfW){
  const h=google.maps.geometry.spherical.computeHeading(p1,p2);
  const l1=google.maps.geometry.spherical.computeOffset(p1,halfW,h-90);
  const l2=google.maps.geometry.spherical.computeOffset(p2,halfW,h-90);
  const r1=google.maps.geometry.spherical.computeOffset(p1,halfW,h+90);
  const r2=google.maps.geometry.spherical.computeOffset(p2,halfW,h+90);
  return [l1,l2,r2,r1];
}

/* make one road polygon, colour & register it as obstacle */
function makeRoadPoly(pathArr){
  const poly=new google.maps.Polygon({
    paths:[...pathArr,pathArr[0]],
    fillColor:"#A9A9A9", fillOpacity:1,
    strokeColor:"#A9A9A9", strokeWeight:1,
    zIndex:5, map
  });
  poly.isObstacle=true;



  obstaclePolygons.push(poly);






  attachShapeEvents(poly);        // reuse existing handlers
  return poly;
}





    function drawObstacle(){
      drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
      google.maps.event.addListenerOnce(drawingManager,"polygoncomplete", ob=>{
        ob.setOptions({
          fillColor:"#808080", fillOpacity:0.5, strokeColor:"#808080",
          clickable:true, editable:true, zIndex:8
        });
        obstaclePolygons.push(ob);
        drawingManager.setDrawingMode(null);
        ob.addListener("click", ()=>selectPolygon(ob));
      });
    }

    function clampPosition(desiredLeft, desiredTop, panel) {
  const pad  = 10;                                   // margin (px)
  const maxL = window.innerWidth  - panel.offsetWidth  - pad;
  const maxT = window.innerHeight - panel.offsetHeight - pad;
  return {
    left : Math.max(pad, Math.min(desiredLeft, maxL)),
    top  : Math.max(pad, Math.min(desiredTop,  maxT))
  };
}



    function toggleDrawingPolygon(){
      obstacleMode = false; // Ensure we are NOT in obstacle mode
    drawingManager.setDrawingMode(drawingManager.drawingMode ? null : google.maps.drawing.OverlayType.POLYGON);
  google.maps.event.addListenerOnce(drawingManager,"polygoncomplete", p=>{
    p.setOptions({zIndex:1});
    polygonCount++;
    p.myIndex = polygonCount;

    // âœ… Ensure it is not treated as obstacle
    p.isObstacle = false;

    userPolygons.push(p);
    drawingManager.setDrawingMode(null);
    p.addListener("click", ()=>{ selectPolygon(p); });
    deselectPolygon();
    selectPolygon(p);
    displayAllCapacities();
  });
}
    

function addObstacle(shape) {
  shape.isObstacle = true;  // Make sure it's flagged as an obstacle
  if (!obstaclePolygons.includes(shape)) {
    obstaclePolygons.push(shape);
  }
}
function deleteSelectedPolygon() {

if (!selectedPolygon) return;

/* 1. wipe per-module rectangles (module-mode) */
if (polygonRectanglesMap.has(selectedPolygon)) {
  polygonRectanglesMap.get(selectedPolygon).forEach(r => r.setMap(null));
  polygonRectanglesMap.delete(selectedPolygon);
}

/* 2. wipe per-table outlines (table-mode) â€“ NEW */
if (polygonTableOutlinesMap.has(selectedPolygon)) {
  polygonTableOutlinesMap.get(selectedPolygon).forEach(o => o.setMap(null));
  polygonTableOutlinesMap.delete(selectedPolygon);
}

/* 3. other clean-ups */
removeStationMarker(selectedPolygon);
clearInverterBoxesForPolygon(selectedPolygon);

/* 4. remove the area itself and references */
selectedPolygon.setMap(null);

let i = userPolygons.indexOf(selectedPolygon);
if (i > -1) userPolygons.splice(i, 1);

i = obstaclePolygons.indexOf(selectedPolygon);
if (i > -1) obstaclePolygons.splice(i, 1);

selectedPolygon = null;
displayAllCapacities();
}

    function setMountingDefaults(){
      const t = document.getElementById("mounting-structure-select").value;
      const d = mountingStructuresDefaults[t] || mountingStructuresDefaults["Single Axis Tracker 2P"];
      document.getElementById("row-space-input").value = d.rowSpace;
      document.getElementById("column-space-input").value = d.columnSpace;
      document.getElementById("modules-in-row-input").value = d.modulesInRow;
      document.getElementById("panels-per-table-input").value = d.panels;
      document.getElementById("distance-between-tables-input").value = d.distanceBetweenTables;
      document.getElementById("table-space-input").value = d.tableSpace;
      document.getElementById("orientation-select").value = d.orientation;
      document.getElementById("angle-input").value = (typeof d.angle === "number") ? d.angle : 0;
      if (selectedPolygon) {
        selectedPolygon.myMountingType = t;
        displayAllCapacities();
      }
    }



    function orderPositions(arr, axis){               // axis = "lat" | "lng"
  if(fillOrigin==="west" && axis==="lng")   return arr.sort((a,b)=>a-b);
  if(fillOrigin==="east" && axis==="lng")   return arr.sort((a,b)=>b-a);
  if(fillOrigin==="south"&& axis==="lat")   return arr.sort((a,b)=>a-b);
  if(fillOrigin==="north"&& axis==="lat")   return arr.sort((a,b)=>b-a);

  // center-out: sort by |value-center|
  if(fillOrigin==="center"){
    const c = arr.reduce((s,v)=>s+v,0)/arr.length;
    return arr.sort((a,b)=>Math.abs(a-c)-Math.abs(b-c));
  }
  // default fallback
  return arr.sort((a,b)=>a-b);
}

function rememberModuleCount(poly, n) {
  poly._moduleCount = (poly._moduleCount || 0) + n;   // keep tally
}

/*******************************************************************
 *  fillAdaptive â€“ â€œadaptive scanlineâ€ layout
 *******************************************************************/
 function fillAdaptive(selectedPolygon) {
  if (!selectedPolygon) { alert("No polygon selected"); return; }

  /* â”€ 0. Wipe previous graphics & counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  (polygonRectanglesMap.get(selectedPolygon) || []).forEach(r => r.setMap(null));
  (polygonTableOutlinesMap.get(selectedPolygon) || []).forEach(o => o.setMap(null));
  polygonRectanglesMap.delete(selectedPolygon);
  polygonTableOutlinesMap.set(selectedPolygon, []);
  selectedPolygon._moduleCount = 0;
  const freshRects    = [];
  const freshOutlines = [];

  /* â”€ 1. Read current UI parameters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const rs   = +document.getElementById("row-space-input").value        || 0.02;   // m
  const cs   = +document.getElementById("column-space-input").value     || 0.02;
  const mr   = +document.getElementById("modules-in-row-input").value   || 30;     // modules / row
  const pt   = +document.getElementById("panels-per-table-input").value ||  3;     // rows / table
  const dbt  = +document.getElementById("distance-between-tables-input").value || 0.5;
  const vg   = +document.getElementById("table-space-input").value      || 1;
  const ang  = +document.getElementById("angle-input").value            || 0;
  const ori  = document.getElementById("orientation-select").value;

  /* ---- optional block spacing ---- */
  const blockNS      = +document.getElementById("block-ns-size-input").value   || 0;
  const blockSpaceNS = +document.getElementById("block-ns-space-input").value  || 0;
  const blockEW      = +document.getElementById("block-ew-size-input").value   || 0;
  const blockSpaceEW = +document.getElementById("block-ew-space-input").value  || 0;

  /* â”€ 2. Derived constants in â€œdegreesâ€ for current latitude â”€â”€â”€â”€ */
  const m2deg        = 0.000009;                                               // â‰ˆ 1 m â†’ Â°lat
  const pw           = (ori === "portrait" ? selectedModuleWidth  : selectedModuleHeight) * m2deg;
  const ph           = (ori === "portrait" ? selectedModuleHeight : selectedModuleWidth ) * m2deg;
  const rsd          = rs * m2deg,   csd = cs * m2deg;
  const tblW         = mr*pw + (mr-1)*rsd;
  const tblH         = pt*ph + (pt-1)*csd;
  const bigStepLng   = tblW + dbt * m2deg;          // table-to-table jump
  const bigStepLat   = tblH + vg  * m2deg;
  const smallStepLng = tblW / 5;                    // fallback hop during search

  /* â”€ 3. Get a rotated bounding-box of the polygon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const bb  = new google.maps.LatLngBounds();
  selectedPolygon.getPath().forEach(p => bb.extend(p));
  const ctr = bb.getCenter();
  const rad = ang * Math.PI / 180, cos = Math.cos(rad), sin = Math.sin(rad);
  const rot = p => new google.maps.LatLng(                // rotate about centre
      ctr.lat() + (p.lat()-ctr.lat())*cos - (p.lng()-ctr.lng())*sin,
      ctr.lng() + (p.lat()-ctr.lat())*sin + (p.lng()-ctr.lng())*cos );

  const corners = [
    bb.getSouthWest(), bb.getNorthEast(),
    new google.maps.LatLng(bb.getSouthWest().lat(), bb.getNorthEast().lng()),
    new google.maps.LatLng(bb.getNorthEast().lat(), bb.getSouthWest().lng())
  ].map(rot);
  const rbb = { south: Math.min(...corners.map(p=>p.lat())),
                north: Math.max(...corners.map(p=>p.lat())),
                west : Math.min(...corners.map(p=>p.lng())),
                east : Math.max(...corners.map(p=>p.lng())) };

  /* â”€ 4. Build start-coordinates with optional block gaps â”€â”€â”€â”€â”€â”€â”€ */
  const rows = [], cols = [];
  let rIdx = 0, nextLat = rbb.south;
  while (nextLat < rbb.north) {
    rows.push(nextLat);
    nextLat += bigStepLat;
    rIdx++;
    if (blockNS > 0 && blockSpaceNS > 0 && rIdx % blockNS === 0)
      nextLat += blockSpaceNS * m2deg;
  }
  let cIdx = 0, nextLng = rbb.west;
  while (nextLng < rbb.east) {
    cols.push(nextLng);
    nextLng += bigStepLng;
    cIdx++;
    if (blockEW > 0 && blockSpaceEW > 0 && cIdx % blockEW === 0)
      nextLng += blockSpaceEW * m2deg;
  }
  const procRows = orderPositions([...rows], "lat");
  const procCols = orderPositions([...cols], "lng");

  /* â”€ 5. Nested scan â€“ adaptive placement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  procRows.forEach(startLat => {
    let ln = procCols[0];

    while (ln < rbb.east) {

      /* 5-a. The four un-rotated corners of this *table* */
      const tblUn = [
        new google.maps.LatLng(startLat      , ln      ),
        new google.maps.LatLng(startLat      , ln+tblW ),
        new google.maps.LatLng(startLat+tblH , ln+tblW ),
        new google.maps.LatLng(startLat+tblH , ln      )
      ];
      const tbl = tblUn.map(rot);

      /* 5-b. Quick check: are all four inside PV area & clear of obstacles? */
      const fitsWhole =
            tbl.every(c => google.maps.geometry.poly.containsLocation(c, selectedPolygon))
        && !isInsideAnyObstacle(tbl);

      /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
         FAST EXIT when we only need the table outline
         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
      if (drawMode === "table") {
        if (!fitsWhole) { ln += smallStepLng; continue; }

        const outline = new google.maps.Polygon({
          paths:[...tbl, tbl[0]],
          fillColor:"#404aff", fillOpacity:0.6,
          strokeColor:"#404aff", strokeWeight:1,
          zIndex:10, map
        });
        freshOutlines.push(outline);

        /* modules inside this table = pt Ã— mr */
        rememberModuleCount(selectedPolygon, pt * mr);

        ln += bigStepLng;          // jump to next table position
        continue;                  // âš¡ skip the heavy per-module loop
      }

      /* â”€ 5-c. *Module-mode* â€“ verify every module inside that table */
      let modules = [], tableOk = fitsWhole;
      for (let rr = 0; rr < pt && tableOk; rr++) {
        for (let cc = 0; cc < mr && tableOk; cc++) {
          const la2 = startLat + rr*(ph+csd),
                ln2 = ln       + cc*(pw+rsd);
          const mUn = [
            new google.maps.LatLng(la2    , ln2),
            new google.maps.LatLng(la2    , ln2+pw),
            new google.maps.LatLng(la2+ph , ln2+pw),
            new google.maps.LatLng(la2+ph , ln2)
          ];
          const mod = mUn.map(rot);
          if (!mod.every(pt=>google.maps.geometry.poly.containsLocation(pt,selectedPolygon))
              || isInsideAnyObstacle(mod)) { tableOk = false; break; }
          modules.push(mod);
        }
      }
      if (!tableOk) { ln += smallStepLng; continue; }

      /* 5-d. Paint each module */
      modules.forEach(m => {
        const r = new google.maps.Polygon({
          paths:[...m, m[0]],
          fillColor:"#404aff", strokeColor:"#404aff",
          fillOpacity:0.6, strokeOpacity:1, strokeWeight:1,
          zIndex:10, map
        });
        freshRects.push(r);
      });

      ln += bigStepLng;
    }
  });

  /* â”€ 6. Register & refresh counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  polygonTableOutlinesMap.set(selectedPolygon, freshOutlines);
  if (drawMode === "module") polygonRectanglesMap.set(selectedPolygon, freshRects);

  displayAllCapacities();
}



/*******************************************************************
 *  fillBlock â€“ strict grid layout
 *******************************************************************/
function fillBlock(selectedPolygon) {
  if (!selectedPolygon) { alert("No polygon selected"); return; }

  /* â”€ 0. Clean previous graphics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  (polygonRectanglesMap.get(selectedPolygon) || []).forEach(r => r.setMap(null));
  (polygonTableOutlinesMap.get(selectedPolygon) || []).forEach(o => o.setMap(null));
  polygonRectanglesMap.delete(selectedPolygon);
  polygonTableOutlinesMap.set(selectedPolygon, []);
  selectedPolygon._moduleCount = 0;
  const freshRects    = [];
  const freshOutlines = [];

  /* â”€ 1. UI parameters (same as adaptive) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const rs   = +document.getElementById("row-space-input").value        || 0.02;
  const cs   = +document.getElementById("column-space-input").value     || 0.02;
  const mr   = +document.getElementById("modules-in-row-input").value   || 30;
  const pt   = +document.getElementById("panels-per-table-input").value ||  3;
  const dbt  = +document.getElementById("distance-between-tables-input").value || 0.5;
  const vg   = +document.getElementById("table-space-input").value      || 1;
  const ang  = +document.getElementById("angle-input").value            || 0;
  const ori  = document.getElementById("orientation-select").value;

  /* block spacing */
  const blockNS      = +document.getElementById("block-ns-size-input").value   || 0;
  const blockSpaceNS = +document.getElementById("block-ns-space-input").value  || 0;
  const blockEW      = +document.getElementById("block-ew-size-input").value   || 0;
  const blockSpaceEW = +document.getElementById("block-ew-space-input").value  || 0;

  /* â”€ 2. Derived constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const m2deg = 0.000009;
  const pw  = (ori === "portrait" ? selectedModuleWidth  : selectedModuleHeight) * m2deg;
  const ph  = (ori === "portrait" ? selectedModuleHeight : selectedModuleWidth ) * m2deg;
  const rsd = rs*m2deg, csd = cs*m2deg;
  const tblW = mr*pw + (mr-1)*rsd;
  const tblH = pt*ph + (pt-1)*csd;
  const bigStepLng = tblW + dbt*m2deg;
  const bigStepLat = tblH + vg *m2deg;

  /* â”€ 3. Rotated bbox (same helper as adaptive) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const bb  = new google.maps.LatLngBounds();
  selectedPolygon.getPath().forEach(p => bb.extend(p));
  const ctr = bb.getCenter();
  const rad = ang*Math.PI/180, cos = Math.cos(rad), sin = Math.sin(rad);
  const rot = p => new google.maps.LatLng(
      ctr.lat() + (p.lat()-ctr.lat())*cos - (p.lng()-ctr.lng())*sin,
      ctr.lng() + (p.lat()-ctr.lat())*sin + (p.lng()-ctr.lng())*cos );

  const corners = [
    bb.getSouthWest(), bb.getNorthEast(),
    new google.maps.LatLng(bb.getSouthWest().lat(), bb.getNorthEast().lng()),
    new google.maps.LatLng(bb.getNorthEast().lat(), bb.getSouthWest().lng())
  ].map(rot);
  const rbb = { south: Math.min(...corners.map(p=>p.lat())),
                north: Math.max(...corners.map(p=>p.lat())),
                west : Math.min(...corners.map(p=>p.lng())),
                east : Math.max(...corners.map(p=>p.lng())) };

  /* â”€ 4. Row / column anchors with gaps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const rows = [], cols = [];
  let rIdx = 0, nextLat = rbb.south;
  while (nextLat < rbb.north) {
    rows.push(nextLat);
    nextLat += bigStepLat;
    rIdx++;
    if (blockNS > 0 && blockSpaceNS > 0 && rIdx % blockNS === 0)
      nextLat += blockSpaceNS * m2deg;
  }
  let cIdx = 0, nextLng = rbb.west;
  while (nextLng < rbb.east) {
    cols.push(nextLng);
    nextLng += bigStepLng;
    cIdx++;
    if (blockEW > 0 && blockSpaceEW > 0 && cIdx % blockEW === 0)
      nextLng += blockSpaceEW * m2deg;
  }
  const procRows = orderPositions([...rows], "lat");
  const procCols = orderPositions([...cols], "lng");

  /* â”€ 5. Strict grid loops â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  procRows.forEach(la => {
    procCols.forEach(ln => {

      /* 5-a. Quick table containment test */
      const tbl = [
        new google.maps.LatLng(la       , ln),
        new google.maps.LatLng(la       , ln+tblW),
        new google.maps.LatLng(la+tblH  , ln+tblW),
        new google.maps.LatLng(la+tblH  , ln)
      ].map(rot);

      const fitsWhole =
            tbl.every(c => google.maps.geometry.poly.containsLocation(c, selectedPolygon))
        && !isInsideAnyObstacle(tbl);

      /* FAST exit in table-mode */
      if (drawMode === "table") {
        if (!fitsWhole) return;

        const outline = new google.maps.Polygon({
          paths:[...tbl, tbl[0]],
          fillColor:"#404aff", fillOpacity:0.6,
          strokeColor:"#404aff", strokeWeight:1,
          zIndex:10, map
        });
        freshOutlines.push(outline);
        rememberModuleCount(selectedPolygon, mr * pt);
        return;
      }

      /* 5-b. module-by-module verification */
      if (!fitsWhole) return;                // quick reject

      let modules = [], ok = true;
      for (let rr = 0; rr < pt && ok; rr++) {
        for (let cc = 0; cc < mr && ok; cc++) {
          const la2 = la + rr*(ph+csd), ln2 = ln + cc*(pw+rsd);
          const mUn = [
            new google.maps.LatLng(la2    , ln2),
            new google.maps.LatLng(la2    , ln2+pw),
            new google.maps.LatLng(la2+ph , ln2+pw),
            new google.maps.LatLng(la2+ph , ln2)
          ];
          const mod = mUn.map(rot);
          if (!mod.every(pt=>google.maps.geometry.poly.containsLocation(pt, selectedPolygon))
              || isInsideAnyObstacle(mod)) { ok = false; break; }
          modules.push(mod);
        }
      }
      if (!ok) return;

      modules.forEach(m => {
        const r = new google.maps.Polygon({
          paths:[...m,m[0]],
          fillColor:"#404aff", strokeColor:"#404aff",
          fillOpacity:0.6, strokeOpacity:1, strokeWeight:1,
          zIndex:10, map
        });
        freshRects.push(r);
      });
    });
  });

  /* â”€ 6. Register graphics & update counters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  polygonTableOutlinesMap.set(selectedPolygon, freshOutlines);
  if (drawMode === "module") polygonRectanglesMap.set(selectedPolygon, freshRects);
  displayAllCapacities();
}















function clearRectangles(alertUser = true){
  if (!selectedPolygon) return;

  (polygonRectanglesMap.get(selectedPolygon) || []).forEach(r => r.setMap(null));
  (polygonTableOutlinesMap.get(selectedPolygon) || []).forEach(o => o.setMap(null));
  polygonRectanglesMap.delete(selectedPolygon);
  polygonTableOutlinesMap.delete(selectedPolygon);
  selectedPolygon._moduleCount = 0;                           // NEW

  updateInfo(0);
  displayAllCapacities();
  if (alertUser) alert("Rectangles cleared for Area "+selectedPolygon.myIndex+".");
}


    function isInsideAnyObstacle(corners){
  return obstaclePolygons.some(ob => {
    if (!ob.isObstacle) return false;  // â† THIS FILTERS OUT NON-OBSTACLES

    if(ob instanceof google.maps.Polygon){
      return corners.some(pt => google.maps.geometry.poly.containsLocation(pt, ob));
    } else if(ob instanceof google.maps.Circle){
      const center=ob.getCenter();
      const radius=ob.getRadius();
      return corners.some(pt => google.maps.geometry.spherical.computeDistanceBetween(pt,center)<=radius);
    } else if(ob instanceof google.maps.Rectangle){
      const bounds=ob.getBounds();
      return corners.some(pt => bounds.contains(pt));
    }
    return false;
  });
}

    const w = 3;                       // halfâ€‘width in metres (=>Â 6Â m road)
function polylineToRoadPolygon(path) {
  const left  = [], right = [];
  for (let i = 0; i < path.length - 1; i++) {
    const A = path[i], B = path[i + 1];
    const h = google.maps.geometry.spherical.computeHeading(A, B);
    left .push( google.maps.geometry.spherical.computeOffset(A,  w, h-90) );
    right.push( google.maps.geometry.spherical.computeOffset(A,  w, h+90) );
    if (i === path.length - 2) {                    // last vertex
      left .push( google.maps.geometry.spherical.computeOffset(B,  w, h-90) );
      right.push( google.maps.geometry.spherical.computeOffset(B,  w, h+90) );
    }
  }
  right.reverse();
  return left.concat(right);
}



    function selectPolygon(p){
      deselectPolygon();
      selectedPolygon = p;
      selectedPolygon.setOptions({strokeColor:"#00FF00", strokeWeight:3, zIndex:1});
      attachEdgeClickListeners(selectedPolygon);
    }

    function deselectPolygon(){
      if(selectedPolygon){
        if(obstaclePolygons.includes(selectedPolygon)){
          selectedPolygon.setOptions({strokeColor:"#808080", strokeWeight:2, zIndex:1});
        } else {
          selectedPolygon.setOptions({strokeColor:"#FF0000", strokeWeight:2, zIndex:1});
        }
        selectedPolygon=null;
      }
      if(selectedEdge){
        selectedEdge.setMap(null);
        selectedEdge=null;
      }
    }

    function attachEdgeClickListeners(p){
      const path = p.getPath?.();
      if(!path) return;
      for(let i=0; i<path.getLength(); i++){
        const s=path.getAt(i);
        const e=path.getAt((i+1)%path.getLength());
        const line=new google.maps.Polyline({
          path:[s,e],
          strokeColor:"transparent",
          strokeWeight:10,
          map:map,
          clickable:true,
          zIndex:1
        });
        google.maps.event.addListener(line,"click", ()=>highlightEdge(line,s,e));
        google.maps.event.addListener(line,"mouseover", ev=>{
          if(userPolygons.includes(p)){
            const cap=(p.myCapacity||0).toFixed(2);
            showCalloutBox(ev.domEvent,"Area "+p.myIndex+": "+cap+" kWp");
          }
        });
        google.maps.event.addListener(line,"mouseout", hideCalloutBox);
      }
    }

    function highlightEdge(ed, s, e){
      if(selectedEdge){
        selectedEdge.setMap(null);
        selectedEdge=null;
      }
      selectedEdge=new google.maps.Polyline({
        path:[s,e],
        strokeColor:"blue",
        strokeWeight:3,
        map:map,
        zIndex:5
      });
    }

    function calculateEdgeAngle(s,e){
      const la=e.lat()-s.lat();
      const ln=e.lng()-s.lng();
      let a=Math.atan2(ln, la)*180/Math.PI;
      if(a<0) a+=360;
      return a;
    }

    function alignRectanglesToEdge(){
      if(!selectedEdge || !selectedPolygon){
        alert("Please select an edge first!");
        return;
      }
      const ep=selectedEdge.getPath();
      const s=ep.getAt(0);
      const e=ep.getAt(1);
      let a = calculateEdgeAngle(s,e);
      a=(a+90)%360;
      document.getElementById("angle-input").value=a;
      fillWithRectangles();
      alert("Rectangles aligned. Angle="+a.toFixed(2)+"Â°");
    }

    function updateInfo(n){
      lastPanelCount = n;
      const k = n*(selectedModuleWatt/1000);
      document.getElementById("panel-count").textContent = "Number of Panels: " + n;
      document.getElementById("kwp-value").textContent   = "Total kWp: " + k.toFixed(2);
      window.boqResults.numberOfModules        = n;
      window.boqResults.moduleCapacityWp       = selectedModuleWatt;
      window.boqResults.totalSystemCapacityKwp = parseFloat(k.toFixed(2));
    }

/*******************************************************************/
/* 5 â”€â”€ displayAllCapacities â€“ counts modules from both sources    */
/*******************************************************************/
function displayAllCapacities() {

if (userPolygons.length === 0) {
  document.getElementById("area-capacity-info").innerHTML = ""; 
  document.getElementById("panel-count").style.display = "none";
  document.getElementById("kwp-value").style.display   = "none";
  return;
}

let total = 0;
let tableHtml = `<table style="width:100%;font-size:12px;border-collapse:collapse;margin-bottom:8px;text-align:center;">
  <thead>
    <tr><th style="border:1px solid #ccc;padding:4px;width:50%;">Area</th>
        <th style="border:1px solid #ccc;padding:4px;width:50%;">kWp</th></tr>
  </thead><tbody>`;

userPolygons.forEach(p => {
  const drawn = polygonRectanglesMap.has(p) ? polygonRectanglesMap.get(p).length : 0;
  const counted = p._moduleCount || 0;
  const modCount = drawn + counted;
  const capacity = modCount * (selectedModuleWatt / 1000);
  p.myCapacity = capacity;
  total += capacity;

  tableHtml += `<tr>
      <td style="border:1px solid #ccc;padding:4px;">Area ${p.myIndex}</td>
      <td style="border:1px solid #ccc;padding:4px;">${Math.round(capacity).toLocaleString()}</td>
    </tr>`;
});

tableHtml += `<tr>
      <td style="border:1px solid #ccc;padding:4px;font-weight:bold;">Total</td>
      <td style="border:1px solid #ccc;padding:4px;font-weight:bold;">${Math.round(total).toLocaleString()}</td>
    </tr></tbody></table>`;

document.getElementById("area-capacity-info").innerHTML = tableHtml;
document.getElementById("panel-count").style.display = "none";
document.getElementById("kwp-value").style.display   = "none";

/* keep BOQ in-sync */
window.boqResults.numberOfModules = userPolygons.reduce((sum, p) => {
  const drawn = polygonRectanglesMap.has(p) ? polygonRectanglesMap.get(p).length : 0;
  return sum + drawn + (p._moduleCount || 0);
}, 0);
window.boqResults.moduleCapacityWp       = selectedModuleWatt;
window.boqResults.totalSystemCapacityKwp = parseFloat(total.toFixed(2));
}

// Helper: Format number with 0 decimals and thousands separator
function formatNumber(n) {
  return Math.round(n).toLocaleString('en-US');
}




    function getLayoutDC(){
      return lastPanelCount*(selectedModuleWatt/1000);
    }

    function showCalloutBox(evt, txt){
      const b = document.getElementById("callout-box");
      if(!b) return;
      b.style.display="block";
      const x=evt?.clientX||0, y=evt?.clientY||0;
      b.style.left=(x+10)+"px";
      b.style.top=(y+10)+"px";
      b.textContent = txt;
    }

    function hideCalloutBox(){
      const b = document.getElementById("callout-box");
      if(!b) return;
      b.style.display="none";
    }

    function placeStationMarkerForPolygon(p, latLng) {
      removeStationMarker(p);
      const m = new google.maps.Marker({
        map: map,
        position: latLng,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: "green",
          fillOpacity: 1,
          strokeColor: "green",
          strokeWeight: 2,
          scale: 5
        },
        draggable: true
      });
      m.addListener("dragend", () => {
        drawAllInvToCombinerLines();
      });
      polygonStationMarkerMap.set(p, m);
    }

    function removeStationMarker(p){
      const o = polygonStationMarkerMap.get(p);
      if(o){
        o.setMap(null);
        polygonStationMarkerMap.delete(p);
      }
    }

    function clearInverterBoxesForPolygon(p){
      const b = polygonInverterBoxesMap.get(p);
      if(b && b.length){
        b.forEach(x=>x.setMap(null));
      }
      polygonInverterBoxesMap.set(p, []);
    }

    function pushInverterBoxForPolygon(p,b){
      if(!polygonInverterBoxesMap.has(p)){
        polygonInverterBoxesMap.set(p,[]);
      }
      polygonInverterBoxesMap.get(p).push(b);
    }

    function createInverterRect(c, f="#FFFFFF"){
      const baseLat=c.lat(), ml=0.000009;
      const mg=0.000009*Math.cos(baseLat*Math.PI/180);
      const hw=0.5*mg, hh=0.5*ml;
      const cl=c.lat(), cg=c.lng();
      const cd=[
        {lat:cl-hh, lng:cg-hw},
        {lat:cl-hh, lng:cg+hw},
        {lat:cl+hh, lng:cg+hw},
        {lat:cl+hh, lng:cg-hw}
      ];
      return new google.maps.Polygon({
        paths:[...cd,cd[0]],
        fillColor:f,
        fillOpacity:1,
        strokeColor:"#333",
        strokeWeight:1,
        zIndex:20
      });
    }








    
    function drawOneTable(corners, modulesPerTable){
  /* corners = [LatLng,LatLng,LatLng,LatLng] in the usual order */
  const poly = new google.maps.Polygon({
    paths       : [...corners, corners[0]],
    fillColor   : "#1e90ff",
    fillOpacity : 0.35,          // a bit transparent so the grid is visible
    strokeColor : "#1e90ff",
    strokeWeight: 1,
    zIndex      : 10,
    map
  });

  /* keep the *number* of modules on the polygon â€“ weâ€™ll use it later */
  poly.moduleCount = modulesPerTable;       // <<< key line
  return poly;
}

enableMVSystem.addEventListener('change',()=>{
  mvSubstationsContainer.style.display = enableMVSystem.checked ? 'block' : 'none';
});

    

    function distributeInvertersOnLayout(p){
      if(!lastChosenSolution){
        alert("No inverter sizing solution found. Please size inverters and select 'Use This' first.");
        return;
      }
      const r=polygonRectanglesMap.get(p)||[];
      if(!r.length){
        alert("No modules found in this polygon.");
        return;
      }
      clearInverterBoxesForPolygon(p);
      let groups={};
      r.forEach(x=>{
        if(x.inverterNo){
          const k="inv"+x.inverterNo;
          if(!groups[k]) groups[k]=[];
          groups[k].push(x);
        }
      });
      Object.keys(groups).forEach(k=>{
        const arr=groups[k];
        if(!arr.length) return;
        const f=arr[0];
        const path=f.getPath();
        let mlat=9999,MXlat=-9999,mlng=9999,MXlng=-9999;
        for(let i=0;i<path.getLength();i++){
          const pt=path.getAt(i);
          if(pt.lat()<mlat) mlat=pt.lat();
          if(pt.lat()>MXlat)MXlat=pt.lat();
          if(pt.lng()<mlng) mlng=pt.lng();
          if(pt.lng()>MXlng)MXlng=pt.lng();
        }
        const mid=(mlat+MXlat)/2;
        const areaLat=p.getPath().getAt(0).lat();
        const meterLat=0.000009, meterLng=0.000009*Math.cos(areaLat*Math.PI/180);
        const off=1*meterLng;
        const pl=mlng-off;
        const invNo=f.inverterNo||0;
        const invKW=f.inverterKW||0;
        const box=createInverterRect(new google.maps.LatLng(mid,pl),"#FFFFFF");
        box.setMap(map);
        pushInverterBoxForPolygon(p,box);
        
      });

    }

    function distributeInvertersAroundStation(p){
      if(!lastChosenSolution){
        alert("No inverter sizing solution found. Please size inverters first.");
        return;
      }
      if(!polygonStationMarkerMap.has(p)){
        alert("No inverter station selected for this area!");
        return;
      }

      let totalUnits=0, invsData=[], g=1;
      lastChosenSolution.details.forEach(d=>{
        if(!d||d.quantity===0) return;
        const {name,quantity}=d;
        let w=0;
        const mm=name.match(/(\d+)\s?kW/i);
        if(mm){
          w=mm[1];
        }
        for(let i=0;i<quantity;i++){
          invsData.push({no:g, size:w});
        }
        g++;
      });
      totalUnits=invsData.length;
      if(!totalUnits){
        alert("No inverters in chosen solution!");
        return;
      }

      clearInverterBoxesForPolygon(p);

      const st=polygonStationMarkerMap.get(p);
      const stPos=st.getPosition();
      const rs=1.5, cs=1.5;
      const cols=Math.ceil(Math.sqrt(totalUnits));
      const rows=Math.ceil(totalUnits/cols);

      const laP=1/111320;
      const staLat=stPos.lat();
      const lnP=laP*Math.cos(staLat*Math.PI/180);
      const tw=(cols-1)*cs, th=(rows-1)*rs;
      const hw=tw/2, hh=th/2;

      let u=0;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(u>=totalUnits) break;
          const oLat=(r*rs)-hh, oLng=(c*cs)-hw;
          const ofLat=oLat*laP, ofLng=oLng*lnP;
          const CL=staLat+ofLat, CG=stPos.lng()+ofLng;

          const invNo=invsData[u].no, invSize=invsData[u].size;
          u++;

          const box=createInverterRect(new google.maps.LatLng(CL,CG),"#FFFFFF");
          box.setMap(map);
          pushInverterBoxForPolygon(p,box);
          attachInverterMouseEvents(box,p.myIndex,invNo,invSize);
        }
      }
      
    }

    function openInverterSizingModal(){
      if(!selectedPolygon){  return; }
      const r=polygonRectanglesMap.get(selectedPolygon)||[];
      const c=r.length;
      const v=c*(selectedModuleWatt/1000);
      document.getElementById("desiredDcCapacity").value = v.toFixed(2);
      buildOndInvertersListUI();
      document.getElementById("inverter-sizing-modal").style.display="block";
   

    }

    function buildOndInvertersListUI(){
      if(typeof window.buildOndInvertersListUI==="function"){
        window.buildOndInvertersListUI();
      }
    }

    /********************************************************
 *  Real Inverter Library UI: Populate and Add
 ********************************************************/

let selectedRealInverters = []; // We'll store up to 5

function populateInverterSelectors() {
  // 1) Make sure window.inverterLibrary is loaded
  if(!window.inverterLibrary || !window.inverterLibrary.length){
    console.warn("No inverterLibrary found; maybe not loaded yet?");
    return;
  }
  // 2) Get unique manufacturer names
  const manufacturers = [...new Set(window.inverterLibrary.map(inv => inv.manufacturer))]
    .sort();

  const manufSel = document.getElementById("real-inverter-manufacturer");
  if(!manufSel) return; // in case the element not found
  manufSel.innerHTML = "<option value=''>-- Select --</option>";
  manufacturers.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    manufSel.appendChild(opt);
  });

  // 3) Listen for manufacturer change => fill model
  manufSel.addEventListener("change", () => {
    const chosen = manufSel.value;
    fillRealInverterModelSelect(chosen);
  });
}

function fillOndInverterModelSelect(manufacturerName) {
  // The model <select>
  const modelSel = document.getElementById("inverter-select-ond");
  if (!modelSel) return;

  // Reset to default
  modelSel.innerHTML = `<option value="">-- Choose an inverter --</option>`;
  if (!manufacturerName) return; // no selection

  // Filter the library by that manufacturer
  const subset = window.inverterLibrary.filter(inv => {
    const mf = inv.manufacturer || inv.Manufacturer;
    return mf === manufacturerName;
  });

  // Sort by AC power or however you prefer
  subset.sort((a,b) => (a.acPower || 0) - (b.acPower || 0));

  // Populate the <option>
  subset.forEach(inv => {
    const label = inv.model || inv.name || "Unknown Model";
    const ratedKw = inv.acPower || 0;

    const opt = document.createElement("option");
    // Usually store the "name" as the unique value
    opt.value = inv.name; 
    // Shown text: e.g. "(60 kW) SUN2000-60KTL-M0"
    opt.textContent = `(${ratedKw} kW) ${label}`;

    modelSel.appendChild(opt);
  });
}


function setupAddOndInverterBtn() {
  const addBtn = document.getElementById("add-ond-inverter-btn");
  if (!addBtn) return;

  addBtn.addEventListener("click", () => {
    const manufSel = document.getElementById("manufacturer-select-ond");
    const modelSel = document.getElementById("inverter-select-ond");

    const chosenMf = manufSel.value;
    const chosenMd = modelSel.value;

    if (!chosenMf || !chosenMd) {
      alert("Please pick a manufacturer and model first!");
      return;
    }

    // Find matching object in the global inverter library
    const found = window.inverterLibrary.find(item => {
      const mf = item.manufacturer || item.Manufacturer;
      return (mf === chosenMf && item.name === chosenMd);
    });

    if (!found) {
      alert("No matching inverter found in the library for: " 
            + chosenMf + " / " + chosenMd);
      return;
    }

    // Check if already in the list 
    // (assuming you have a global let ondInverterList = [] somewhere)
    if (ondInverterList.some(x => x.name === found.name)) {
      alert("This inverter is already added!");
      return;
    }

    // Push it in
    ondInverterList.push(found);
    alert("Added " + found.name + " to your OND inverter list!");
    console.log("OND list now =>", ondInverterList);
  });
}

function buildSelectedRealInvertersUI(){
  const c = document.getElementById("selectedInvertersDiv");
  if(!c) return;
  c.innerHTML="";
  selectedRealInverters.forEach((inv, idx)=>{
    const row = document.createElement("div");
    row.style.margin="3px 0";
    row.innerHTML = `
      <span style="font-weight:bold;">${inv.model}</span>
      <span style="color:#666;">(${inv.acPower}kW)</span>
      <button data-idx="${idx}" style="margin-left:10px;">Remove</button>
    `;
    c.appendChild(row);
  });
  // remove buttons
  c.querySelectorAll("button[data-idx]").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const i = parseInt(btn.getAttribute("data-idx"),10);
      selectedRealInverters.splice(i,1);
      buildSelectedRealInvertersUI();
    });
  });
}





    function getTwoColorsForUnit(u){
      const p=[
        ["#87CEFA","#82BFEA"],
        ["#FFFFAA","#FFF795"],
        ["#FFA07A","#FF8E70"],
        ["#90EE90","#86DD86"],
        ["#FFDAB9","#FFC8A0"]
      ];
      return p[u%p.length];
    }

    /* --------------------------------------------------------------- */
/*  Rectangle ordering helpers â€“ keep same-row rectangles together */
/* --------------------------------------------------------------- */
function rectCentroid(r){                         // cache on object
  return r._c || (r._c = (()=>{
    const b = r.getBounds();
    return {                        // centre in map degrees
      lat : (b.getNorthEast().lat()+b.getSouthWest().lat())/2,
      lng : (b.getNorthEast().lng()+b.getSouthWest().lng())/2
    };
  })());
}

/*  Scan-line sort: north-to-south rows, then west-to-east inside row  */




    function toggleSelectCombiner(){
      if(!isSelectingCombiner){
        isSelectingCombiner=true;
        document.getElementById("select-combiner-btn").classList.add("active-button");
        
      } else {
        isSelectingCombiner=false;
        document.getElementById("select-combiner-btn").classList.remove("active-button");
        
      }
    }
    function toggleSelectPoc(){
      if(!isSelectingPoc){
        isSelectingPoc=true;
        document.getElementById("select-poc-btn").classList.add("active-button");
        
      } else {
        isSelectingPoc=false;
        document.getElementById("select-poc-btn").classList.remove("active-button");
        
      }
    }

    function placeCombinerMarker(latLng, id) {
      const m = new google.maps.Marker({
        map: map,
        position: latLng,
        icon: {
          path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
          fillColor: "orange",
          fillOpacity: 1,
          strokeColor: "black",
          strokeWeight: 1,
          scale: 5
        },
        draggable: true
      });
      m.addListener("dragend", () => {
        drawAllInvToCombinerLines();
        drawAllCombinerToPocLines();
      });
      acCombiners.push({ id, marker: m });
    }
    function placePocMarker(latLng, id) {
      const m = new google.maps.Marker({
        map: map,
        position: latLng,
        icon: {
          path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
          fillColor: "purple",
          fillOpacity: 1,
          strokeColor: "black",
          strokeWeight: 1,
          scale: 5
        },
        draggable: true
      });
      m.addListener("dragend", () => {
        drawAllCombinerToPocLines();
      });
      acPocs.push({ id, marker: m });
    }

    function openCombinerAssignmentModal(){
      if(!acCombiners.length){
        
        return;
      }
      if(!userPolygons.length){
        
        return;
      }
      buildAcCombinerModalTable();
      openModal("acCombinerModal");
    }
    function buildAcCombinerModalTable(){
      const body=document.getElementById("acCombinerModalBody");
      let html="<table class='modal-table'><thead><tr><th>Area</th>";
      acCombiners.forEach(cmb=>{
        html+="<th>Combiner #"+cmb.id+"</th>";
      });
      html+="</tr></thead><tbody>";
      userPolygons.forEach(p=>{
        html+="<tr>";
        html+="<td>Area "+p.myIndex+"</td>";
        acCombiners.forEach(cmb=>{
          const assigned=(areaToCombinerMap[p.myIndex]===cmb.id);
          html+=`<td>
            <input type="checkbox" class="acCombChk" data-area="${p.myIndex}" data-combiner="${cmb.id}" 
              ${assigned?"checked":""}
              onclick="onAreaCombinerCheckboxClicked(this)">
          </td>`;
        });
        html+="</tr>";
      });
      html+="</tbody></table>";
      body.innerHTML=html;
    }
    window.onAreaCombinerCheckboxClicked = function(chk){
      const area = chk.getAttribute("data-area");
      const boxes = document.querySelectorAll('.acCombChk[data-area="'+ area +'"]');
      if(chk.checked){
        boxes.forEach(b=>{
          if(b!==chk){ b.checked = false; }
        });
      }
    };

    function saveAreasToCombiner(){
      const boxes=document.querySelectorAll(".acCombChk");
      Object.keys(areaToCombinerMap).forEach(k=>{delete areaToCombinerMap[k];});
      boxes.forEach(b=>{
        const area=parseInt(b.getAttribute("data-area"));
        const comb=parseInt(b.getAttribute("data-combiner"));
        if(b.checked){
          areaToCombinerMap[area]=comb;
        }
      });
      closeModal("acCombinerModal");
      
    }

    function openPocAssignmentModal(){
      if(!acPocs.length){
        
        return;
      }
      
      buildPocAssignmentModalTable();
      openModal("pocAssignmentModal");
    }
    function buildPocAssignmentModalTable(){
      const body=document.getElementById("pocAssignmentModalBody");
      let html="<table class='modal-table'><thead><tr><th>Combiner</th>";
      acPocs.forEach(poc=>{
        html+="<th>POC #"+poc.id+"</th>";
      });
      html+="</tr></thead><tbody>";
      acCombiners.forEach(cmb=>{
        html+="<tr>";
        html+="<td>Combiner "+cmb.id+"</td>";
        acPocs.forEach(p=>{
          const assigned=(combinerToPocMap[cmb.id]===p.id);
          html+=`<td>
            <input type="checkbox" class="cmbPocChk" data-combiner="${cmb.id}" data-poc="${p.id}"
              ${assigned?"checked":""}
              onclick="onCombinerPocCheckboxClicked(this)">
          </td>`;
        });
        html+="</tr>";
      });
      html+="</tbody></table>";
      body.innerHTML=html;
    }
    window.onCombinerPocCheckboxClicked = function(chk){
      const combiner = chk.getAttribute("data-combiner");
      const boxes = document.querySelectorAll('.cmbPocChk[data-combiner="'+ combiner +'"]');
      if(chk.checked){
        boxes.forEach(b=>{
          if(b!==chk){ b.checked = false; }
        });
      }
    };
    function saveCombinerToPoc(){
      const boxes=document.querySelectorAll(".cmbPocChk");
      Object.keys(combinerToPocMap).forEach(k=>{delete combinerToPocMap[k];});
      boxes.forEach(b=>{
        const cmb=parseInt(b.getAttribute("data-combiner"));
        const poc=parseInt(b.getAttribute("data-poc"));
        if(b.checked){
          combinerToPocMap[cmb]=poc;
        }
      });
      closeModal("pocAssignmentModal");
      
    }

    function openModal(id){
      document.getElementById(id).style.display="block";
    }
    function closeModal(id){
      document.getElementById(id).style.display="none";
    }

    function exportACAssignmentsToCSV() {
      let csv = "Inverter,Area,Combiner,POC\n";
      userPolygons.forEach(p => {
        const areaIdx = p.myIndex;
        const combinerId = areaToCombinerMap[areaIdx] || "";
        const pocId = combinerToPocMap[combinerId] || "";
        const rects = polygonRectanglesMap.get(p) || [];
        const grouped = {};
        rects.forEach(r => {
          const invNo = r.inverterNo || 0;
          if (!invNo) return;
          if (!grouped[invNo]) grouped[invNo] = [];
          grouped[invNo].push(r);
        });
        Object.keys(grouped).forEach(inv => {
          const combText = combinerId ? combinerId : "?";
          const pocText  = pocId      ? pocId      : "?";
          const line =
            "Inverter" + inv +
            ",Area " + areaIdx +
            ",Combiner " + combText +
            ",POC " + pocText;
          csv += line + "\n";
        });
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "AC_Assignments.csv");
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById("open-electrical-design-btn").addEventListener("click", ()=>{
      let totalInvCount = 0;
      let newInverterCapacities = {};
      userPolygons.forEach(p => {
        const rects = polygonRectanglesMap.get(p) || [];
        let grouped = {};
        rects.forEach(r => {
          if(r.inverterNo){
            if(!grouped[r.inverterNo]){
              grouped[r.inverterNo] = r.inverterKW || 125;
            }
          }
        });
        Object.keys(grouped).forEach(key => {
          totalInvCount++;
          newInverterCapacities[totalInvCount] = grouped[key];
        });
      });
      let iCount = totalInvCount;
      window.ed_inverterCapacities = newInverterCapacities;

      document.getElementById("ed-pocCount").value = acPocs.length>0 ? acPocs.length : 1;
      document.getElementById("ed-combinerCount").value = acCombiners.length>0 ? acCombiners.length : 1;
      document.getElementById("ed-inverterCount").value = iCount>0 ? iCount : 1;
      if(typeof window.ed_rebuildAssociationTables === "function"){
        window.ed_rebuildAssociationTables();
      }
      setTimeout(()=>{
        const combRows = document.querySelectorAll("#ed-combinerToPocTable tbody tr");
        combRows.forEach((tr, idx)=>{
          const cIndex = idx+1;
          let sel = tr.querySelector("select");
          let assignedPoc = combinerToPocMap[cIndex] || 1;
          sel.value = assignedPoc;
        });
        let newInvToComb = {};
        let sequentialInvNumber = 1;
        userPolygons.forEach(p => {
          const cId = areaToCombinerMap[p.myIndex] || 1;
          const rects = polygonRectanglesMap.get(p) || [];
          let seen = new Set();
          rects.forEach(r => {
            if(r.inverterNo && !seen.has(r.inverterNo)) {
              seen.add(r.inverterNo);
              newInvToComb[sequentialInvNumber] = cId;
              sequentialInvNumber++;
            }
          });
        });
        const invRows = document.querySelectorAll("#ed-inverterToCombinerTable tbody tr");
        invRows.forEach((tr, idx) => {
          const invIndex = idx + 1;
          let sel = tr.querySelector("select");
          let assignedComb = newInvToComb[invIndex] || 1;
          sel.value = assignedComb;
        });
      }, 50);
      document.getElementById("electrical-design-popout").style.display = "block";
      if(typeof window.initElectricalDesign === "function"){
        window.initElectricalDesign();
      }
    });

    document.getElementById("close-electrical-design-btn").addEventListener("click", ()=>{
      document.getElementById("electrical-design-popout").style.display = "none";
    });


    /*
      ---------------------------------------------------------------
      ADDITIONAL code to handle layer toggles
      ---------------------------------------------------------------
    */
    function setPvAreasVisibility(visible) {
      userPolygons.forEach(poly => {
        poly.setMap(visible ? map : null);
      });
    }
    function setObstaclesVisibility(visible) {
      obstaclePolygons.forEach(ob => {
        ob.setMap(visible ? map : null);
      });
    }
    function setPvModulesVisibility(visible) {
      userPolygons.forEach(poly => {
        const rects = polygonRectanglesMap.get(poly) || [];
        rects.forEach(r => r.setMap(visible ? map : null));
      });
    }
    function setInvertersVisibility(visible) {
      userPolygons.forEach(poly => {
        const boxes = polygonInverterBoxesMap.get(poly) || [];
        boxes.forEach(b => b.setMap(visible ? map : null));
      });
    }
    function setCablesVisibility(visible) {
      cablePaths.forEach(c => {
        c.setMap(visible ? map : null);
      });
    }
    function setCombinersVisibility(visible) {
      acCombiners.forEach(c => {
        c.marker.setMap(visible ? map : null);
      });
    }
    function setPocsVisibility(visible) {
      acPocs.forEach(p => {
        p.marker.setMap(visible ? map : null);
      });
    }

    // (Inv->Combiner / Combiner->POC) => polylines
    function drawAllInvToCombinerLines() {
      invCombinerPolylines.forEach(line => line.setMap(null));
      invCombinerPolylines = [];
      let distFound = false;
      userPolygons.forEach(p => {
        const stationMarker = polygonStationMarkerMap.get(p);
        if(!stationMarker) return;
        const combId = areaToCombinerMap[p.myIndex];
        if(!combId) return;
        const combObj = acCombiners.find(c => c.id === combId);
        if(!combObj) return;
        const line = new google.maps.Polyline({
          path: [ stationMarker.getPosition(), combObj.marker.getPosition() ],
          strokeColor: "#FFA500",
          strokeWeight: 3,
          map: map
        });
        invCombinerPolylines.push(line);
        const distMeters = google.maps.geometry.spherical.computeLength(line.getPath());
        if(!distFound){
          window.singleInvDistance = distMeters;
          distFound = true;
        }
      });
      const msg = window.singleInvDistance
        ? `Copied distance = ${window.singleInvDistance.toFixed(2)} m`
        : "No distance found.";
      console.log("INVâ†’Combiner lines updated. " + msg);
    }

    function drawAllCombinerToPocLines() {
      combinerPocPolylines.forEach(line => line.setMap(null));
      combinerPocPolylines = [];
      acCombiners.forEach(comb => {
        const pocId = combinerToPocMap[comb.id];
        if(!pocId) return;
        const pocObj = acPocs.find(p => p.id === pocId);
        if(!pocObj) return;
        const line = new google.maps.Polyline({
          path: [comb.marker.getPosition(), pocObj.marker.getPosition()],
          strokeColor: "#800080",
          strokeWeight: 3,
          map: map
        });
        combinerPocPolylines.push(line);
        const distMeters = google.maps.geometry.spherical.computeLength(line.getPath());
        const cableId = "comb"+comb.id+"_poc"+pocId;
        window.realCableDistances[cableId] = distMeters;
      });
      
    }

    // === MEASUREMENT FEATURE (in meters) ===
    let measureMode = false;
    let measureLine = null;
    let measurePoints = [];
    let measureDistanceLabel = null;
    function toggleMeasureDistance() {
      measureMode = !measureMode;
      if (measureMode) {
        if (measureLine) {
          measureLine.setMap(null);
          measureLine = null;
        }
        measurePoints = [];
        measureLine = new google.maps.Polyline({
          strokeColor: "#FF0000",
          strokeWeight: 2,
          map: map
        });
        createOrShowDistanceLabel("Click on the map to add points...");
        
      }
      else {
        if (measureLine) {
          measureLine.setOptions({ strokeColor: "#999999" });
        }
        if (measureDistanceLabel) {
          measureDistanceLabel.style.display = "none";
        }
        
      }
    }
    function addMeasurePoint(latLng) {
      measurePoints.push(latLng);
      measureLine.setPath(measurePoints);
      if (measurePoints.length > 1) {
        const distanceMeters = google.maps.geometry.spherical.computeLength(measureLine.getPath());
        updateDistanceLabel(distanceMeters.toFixed(2) + " m");
      }
      else {
        updateDistanceLabel("Points: 1 | Distance: 0 m");
      }
    }
    function createOrShowDistanceLabel(initialText) {
      if (!measureDistanceLabel) {
        measureDistanceLabel = document.createElement("div");
        measureDistanceLabel.style.position = "absolute";
        measureDistanceLabel.style.top = "50px";
        measureDistanceLabel.style.left = "50%";
        measureDistanceLabel.style.transform = "translateX(-50%)";
        measureDistanceLabel.style.padding = "8px";
        measureDistanceLabel.style.background = "rgba(255,255,255,0.8)";
        measureDistanceLabel.style.border = "1px solid #888";
        measureDistanceLabel.style.borderRadius = "4px";
        measureDistanceLabel.style.fontSize = "14px";
        measureDistanceLabel.style.zIndex = 99999;
        document.body.appendChild(measureDistanceLabel);
      }
      measureDistanceLabel.style.display = "block";
      measureDistanceLabel.innerText = initialText;
    }
    function updateDistanceLabel(newText) {
      if (measureDistanceLabel) {
        measureDistanceLabel.innerText = newText;
      }
    }
    // === END MEASUREMENT FEATURE ===

    /*
      ---------------------------------------------------------------
      NEW or UPDATED: Draggable + Zoom for the modals
      ---------------------------------------------------------------
    */
    // 1) Close button for Inverter Sizing
    document.getElementById("close-inverter-sizing-btn").addEventListener("click", () => {
      document.getElementById("inverter-sizing-modal").style.display = "none";
    });

    // 2) Zoom in/out for Inverter Sizing
    let invSizingScale = 1;
    document.getElementById("inv-zoom-in").addEventListener("click", () => {
      invSizingScale += 0.1;
      if(invSizingScale > 2) invSizingScale = 2; // max 200%
      document.getElementById("inverter-sizing-content").style.transform = `scale(${invSizingScale})`;
    });
    document.getElementById("inv-zoom-out").addEventListener("click", () => {
      invSizingScale -= 0.1;
      if(invSizingScale < 0.5) invSizingScale = 0.5; // min 50%
      document.getElementById("inverter-sizing-content").style.transform = `scale(${invSizingScale})`;
    });

    // 3) Zoom in/out for Electrical Design
    let edScale = 1;
    document.getElementById("ed-zoom-in").addEventListener("click", () => {
      edScale += 0.1;
      if(edScale > 2) edScale = 2;
      document.getElementById("electrical-design-content").style.transform = `scale(${edScale})`;
    });
    document.getElementById("ed-zoom-out").addEventListener("click", () => {
      edScale -= 0.1;
      if(edScale < 0.5) edScale = 0.5;
      document.getElementById("electrical-design-content").style.transform = `scale(${edScale})`;
    });

    // 4) Drag to move windows
    function makeModalDraggable(modal, handle) {
      let offsetX = 0, offsetY = 0, startX = 0, startY = 0;
      if(!handle) return;

      handle.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        startX = e.clientX;
        startY = e.clientY;
        document.onmouseup = closeDrag;
        document.onmousemove = dragElement;
      }
      function dragElement(e) {
        e = e || window.event;
        e.preventDefault();
        offsetX = startX - e.clientX;
        offsetY = startY - e.clientY;
        startX = e.clientX;
        startY = e.clientY;
        modal.style.top = (modal.offsetTop - offsetY) + "px";
        modal.style.left = (modal.offsetLeft - offsetX) + "px";
      }
      function closeDrag() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }
    document.getElementById("open-foundation-design-btn").addEventListener("click", () => {
    // call function from foundationDesign.js
    window.openFoundationDesignPopout();
  });
  document.getElementById("close-foundation-design-btn").addEventListener("click", () => {
    document.getElementById("foundation-design-popout").style.display = "none";
  });

  // Make the new popout draggable (similar to the electrical design):
  makeModalDraggable(
    document.getElementById("foundation-design-popout"),
    document.getElementById("foundation-design-header")
  );

  // 1) Open the popout on button click
document.getElementById("open-mounting-catalog-btn").addEventListener("click", () => {
  document.getElementById("mounting-catalog-popout").style.display = "block";
});

// 2) Close button inside the popout
document.getElementById("close-mounting-catalog-btn").addEventListener("click", () => {
  document.getElementById("mounting-catalog-popout").style.display = "none";
});

// 3) Clicking on an image sets dropdown value
const catalogItems = document.querySelectorAll(".mounting-catalog-item");
catalogItems.forEach(item => {
  item.addEventListener("click", () => {
    const typeValue = item.getAttribute("data-value");
    const dropdown = document.getElementById("mounting-structure-select");
    dropdown.value = typeValue;
    // (optional) If you want to trigger the "change" event
    dropdown.dispatchEvent(new Event("change"));

    // close the popout automatically
    document.getElementById("mounting-catalog-popout").style.display = "none";
  });
});
// After your â€œfoundation-design-popoutâ€ draggable logic:
makeModalDraggable(
  document.getElementById("mounting-catalog-popout"),
  document.getElementById("mounting-catalog-header")
);

/* --------------------------------------------------
   LAYERS PANEL  â€“  show / hide / drag
-------------------------------------------------- */
(function () {
  const layerPanel  = document.getElementById("layer-panel");
  const layerHeader = document.getElementById("layer-header");
  const layerClose  = document.getElementById("layer-close");
  const layersBtn   = [...document.querySelectorAll(".menu-button")]
                        .find(b => b.dataset.title === "Show Layers Panel");

  /* 1)  open / close from menu bar */
  layersBtn.addEventListener("click", () => {
    layerPanel.style.display = (layerPanel.style.display === "none") ? "block" : "none";
  });

  /* 2)  tiny X button */
  layerClose.addEventListener("click", () => layerPanel.style.display = "none");

  /* 3)  drag â€“ reuse your existing helper */
  makeModalDraggable(layerPanel, layerHeader);
})
();
(function () {
  const drawPanel = document.getElementById("drawing-controls-panel");
  const drawHeader = document.getElementById("drawing-controls-header");
  const drawClose = document.getElementById("drawing-controls-close");
  const drawBtn = [...document.querySelectorAll(".menu-button")]
                    .find(b => b.dataset.title === "Show Drawing Panel");

  drawBtn.addEventListener("click", () => {
    drawPanel.style.display = (drawPanel.style.display === "none") ? "block" : "none";
  });

  drawClose.addEventListener("click", () => drawPanel.style.display = "none");

  makeModalDraggable(drawPanel, drawHeader);
})();

(function () {
  const infoBar = document.getElementById("info-bar");
  const infoBarHeader = document.getElementById("info-bar-header");
  const infoBarClose = document.getElementById("info-bar-close");
  const resultsBtn = [...document.querySelectorAll(".menu-button")]
                        .find(b => b.dataset.title === "Show Results Panel");

  // Open/Close from menu
  resultsBtn.addEventListener("click", () => {
    infoBar.style.display = (infoBar.style.display === "none") ? "block" : "none";
  });

  // Close with tiny X
  infoBarClose.addEventListener("click", () => {
    infoBar.style.display = "none";
  });

    // ðŸ‘‰ ADD here (currently missing):
    makeInfoPanelDraggable(infoBar, infoBarHeader);
})();

function makeInfoPanelDraggable(panel, handle) {
  let isDragging = false;
  let offsetX = 0, offsetY = 0;

  handle.addEventListener('mousedown', function(e) {
    isDragging = true;

    // ðŸ”¥ Force positioning from current bottom-right to top-left
    panel.style.top = panel.offsetTop + 'px';
    panel.style.left = panel.offsetLeft + 'px';
    panel.style.bottom = 'auto';
    panel.style.right = 'auto';

    offsetX = e.clientX - panel.offsetLeft;
    offsetY = e.clientY - panel.offsetTop;

    document.addEventListener('mousemove', movePanel);
    document.addEventListener('mouseup', stopDragging);
  });

  function movePanel(e) {
    if (!isDragging) return;
    panel.style.left = (e.clientX - offsetX) + 'px';
    panel.style.top = (e.clientY - offsetY) + 'px';
  }

  function stopDragging() {
    isDragging = false;
    document.removeEventListener('mousemove', movePanel);
    document.removeEventListener('mouseup', stopDragging);
  }
}


function startTrenchDrawing() {
  if (isDrawingTrench) return;
  isDrawingTrench = true;
  

  drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYLINE);

  google.maps.event.addListenerOnce(drawingManager, "polylinecomplete", pl => {
    if (trenchPolyline) trenchPolyline.setMap(null);
    trenchPolyline = pl;
    trenchPolyline.setOptions({
      strokeColor : "#444444",
      strokeWeight: 5,
      zIndex      : 2
    });
    drawingManager.setDrawingMode(null);
    isDrawingTrench = false;
   
    
  });
}

function clearTrench() {
  if (trenchPolyline) trenchPolyline.setMap(null);
  trenchPolyline = null;
}
/* -------------------------------------------------------------
   inset the outline of a (simple) polygon toward its interior
   by  halfW  metres  and return an array of LatLngs
   ------------------------------------------------------------- */
function makeInsetLoop(pathArray, halfW) {

  // 1) orientation  (+) = CW, (â€“) = CCW  â€¦ see â€œShoelaceâ€ test
  let area = 0;
  for (let i = 0, j = pathArray.length - 1; i < pathArray.length; j = i++) {
    area += (pathArray[i].lng() - pathArray[j].lng()) *
            (pathArray[i].lat() + pathArray[j].lat());
  }
  const isCW = area > 0;               // clockwise = positive area

  const inset = [];

  for (let i = 0; i < pathArray.length; i++) {

    const A = pathArray[(i - 1 + pathArray.length) % pathArray.length]; // previous
    const B = pathArray[i];                                             // current
    const C = pathArray[(i + 1) % pathArray.length];                    // next

    // bearings AB and BC
    const hAB = google.maps.geometry.spherical.computeHeading(B, A);
    const hBC = google.maps.geometry.spherical.computeHeading(B, C);

    // interior angle bisector
    let bis = (hAB + hBC) / 2;
    if (isCW) bis += 180;                 // flip to point *inside* for CW loops
    bis = (bis + 360) % 360;             // normalise

    // angle between edges (degrees â†’ radians)
    let theta = (hBC - hAB + 360) % 360;
    if (theta > 180) theta = 360 - theta;          // acute interior angle
    const sinHalf = Math.sin(theta * Math.PI / 360);

    // offset distance along the bisector
    const d = halfW / sinHalf;

    inset.push(
      google.maps.geometry.spherical.computeOffset(B, d, bis)
    );
  }

  return inset;
}

/* â–‘â–‘â–‘â–‘â–‘  AUTO ROAD BUILDER  â–‘â–‘â–‘â–‘â–‘ */
function isClockwise(pathArr){
  // signed area test (Shoelace formula in lat/lng space)
  let sum = 0;
  for (let i = 0, j = pathArr.length - 1; i < pathArr.length; j = i++)
    sum += (pathArr[i].lng() - pathArr[j].lng()) *
           (pathArr[i].lat() + pathArr[j].lat());
  return sum > 0;          //   >0 â†’ clockwise,  <0 â†’ counterâ€‘clockwise
}

function offsetPathInside(pathArr, halfW){
  /* returns a new array of vertices offset **inside** the polygon
     by `halfW`Â metres (positive number). */
  const cw = isClockwise(pathArr);
  const out = [];
  for (let i = 0; i < pathArr.length; i++){
    const A = pathArr[i],
          B = pathArr[(i+1) % pathArr.length];
    const hdg = google.maps.geometry.spherical.computeHeading(A, B);
    /*  inward =  â€‘90Â°  if polygon is CW,  +90Â°  if CCW               */
    const inn = hdg + (cw ? -90 : +90);
    const a2  = google.maps.geometry.spherical.computeOffset(A, halfW, inn);
    const b2  = google.maps.geometry.spherical.computeOffset(B, halfW, inn);
    out.push(a2, b2);
  }
  return out;
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   buildâ€‘roadsâ€‘btn
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/
document.getElementById("build-roads-btn").addEventListener("click", () => {

  if (!selectedPolygon){
    alert("Select a PV Area first."); 
    return;
  }

  const halfPerimW = parseFloat(document.getElementById("road-p-width").value)/2;
  const halfHW     = parseFloat(document.getElementById("road-h-width").value)/2;
  const halfVW     = parseFloat(document.getElementById("road-v-width").value)/2;
  const hN         = parseInt(document.getElementById("road-h-count").value,10);
  const vN         = parseInt(document.getElementById("road-v-count").value,10);

  const pvPath = selectedPolygon.getPath().getArray();        // LatLng[]
  const pvPoly = selectedPolygon;                             // readable alias

  /* 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€  PERIMETER road (inside offset) */
  if (halfPerimW > 0) {
  const inner = makeInsetLoop(pvPath, halfPerimW);      // inner loop
  // Google Maps: outer path first (CW), inner path second (CCW â†’ hole)
  const perimRoad = new google.maps.Polygon({
    paths        : [pvPath, inner.slice().reverse()],
    fillColor    : "#A9A9A9",
    fillOpacity  : 0.6,
    strokeColor  : "#A9A9A9",
    strokeWeight : 1,
    zIndex       : 5,
    map
  });
  perimRoad.isObstacle = true;
  obstaclePolygons.push(perimRoad);
  attachShapeEvents(perimRoad);
}
  /* 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€  PERIMETER road  (offset *inside* the PV area)  */
  function buildPerimeterRoad(pvPoly, halfW){

// ---- A)  polygon âžœ GeoJSON  ---------------------------------
const gjson = {
  type : "Polygon",
  coordinates : [ pvPoly.getPath().getArray()
                    .map(pt => [pt.lng(), pt.lat()]) ]
};

// ---- B)  negative buffer (metres) ----------------------------
const reader  = new jsts.io.GeoJSONReader();
const writer  = new jsts.io.GeoJSONWriter();
const geom    = reader.read(gjson);
const inset   = geom.buffer(-halfW);          // <â€“ inside offset
const coords  = writer.write(inset).coordinates[0];

// ---- C)  draw the band (outer + inner ring) ------------------
const outer = pvPoly.getPath().getArray();          // keep original
const inner = coords.map(c => ({lat:c[1], lng:c[0]})).reverse();

const road = new google.maps.Polygon({
  paths        : [outer, inner],              // 2 paths â‡’ hole
  fillColor    : "#A9A9A9",
  fillOpacity  : 1,
  strokeColor  : "#A9A9A9",
  strokeWeight : 1,
  map
});
road.isObstacle = true;
obstaclePolygons.push(road);
attachShapeEvents(road);
}


  /* helpers to intersect horizontal / vertical stripes with the PV polygon */
  function intersectionsWithLat(lat){
    const pts = [];
    for (let i = 0; i < pvPath.length; i++){
      const A = pvPath[i],
            B = pvPath[(i+1)%pvPath.length];
      if ((A.lat() <= lat && B.lat() >= lat) ||
          (B.lat() <= lat && A.lat() >= lat)){
        if (A.lat() === B.lat()) continue;        // horizontal edge
        const t = (lat - A.lat()) / (B.lat() - A.lat());
        const lng = A.lng() + t * (B.lng() - A.lng());
        pts.push(new google.maps.LatLng(lat, lng));
      }
    }
    return pts.sort((p,q)=>p.lng()-q.lng());
  }
  function intersectionsWithLng(lng){
    const pts = [];
    for (let i = 0; i < pvPath.length; i++){
      const A = pvPath[i],
            B = pvPath[(i+1)%pvPath.length];
      if ((A.lng() <= lng && B.lng() >= lng) ||
          (B.lng() <= lng && A.lng() >= lng)){
        if (A.lng() === B.lng()) continue;        // vertical edge
        const t = (lng - A.lng()) / (B.lng() - A.lng());
        const lat = A.lat() + t * (B.lat() - A.lat());
        pts.push(new google.maps.LatLng(lat, lng));
      }
    }
    return pts.sort((p,q)=>p.lat()-q.lat());
  }

  /* boundingâ€‘box of the PV polygon (needed only for spacing maths) */
  const bb = new google.maps.LatLngBounds();
  pvPath.forEach(pt => bb.extend(pt));
  const lat0 = bb.getSouthWest().lat(),
        lat1 = bb.getNorthEast().lat(),
        lng0 = bb.getSouthWest().lng(),
        lng1 = bb.getNorthEast().lng();

  /* 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€  HORIZONTAL stripes â€“ clipped to polygon  */
  if (hN > 0 && halfHW > 0){
    const step = (lat1 - lat0)/(hN+1);
    for (let k = 1; k <= hN; k++){
      const y = lat0 + k*step;
      const ints = intersectionsWithLat(y);      // ordered by lng
      for (let i = 0; i < ints.length-1; i+=2){
        const A = ints[i], B = ints[i+1];
        const stripe = bufferedStripe(A, B, halfHW);  // your older helper
        makeRoadPoly(stripe);
      }
    }
  }

  /* 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€  VERTICAL stripes â€“ clipped to polygon  */
  if (vN > 0 && halfVW > 0){
    const step = (lng1 - lng0)/(vN+1);
    for (let k = 1; k <= vN; k++){
      const x = lng0 + k*step;
      const ints = intersectionsWithLng(x);      // ordered by lat
      for (let i = 0; i < ints.length-1; i+=2){
        const A = ints[i], B = ints[i+1];
        const stripe = bufferedStripe(A, B, halfVW);
        makeRoadPoly(stripe);
      }
    }
  }

  /* finally: exit any drawing mode the user might have been in */
  drawingManager.setDrawingMode(null);
});


/* helper: intersection of two infinite lines AB and CD --------------*/
function lineIntersect(A,B,C,D){
  const a1 = B.lat() - A.lat(),
        b1 = A.lng() - B.lng(),
        c1 = a1*A.lng() + b1*A.lat();
  const a2 = D.lat() - C.lat(),
        b2 = C.lng() - D.lng(),
        c2 = a2*C.lng() + b2*C.lat();

  const det = a1*b2 - a2*b1;
  if (Math.abs(det) < 1e-14) return B;          // almost parallel
  const x = (b2*c1 - b1*c2) / det,
        y = (a1*c2 - a2*c1) / det;
  return new google.maps.LatLng(y, x);
}

/* offset *one* edge to the inside -----------------------------------*/
function offsetEdge(P,Q,halfW,insideSign){
  const hdg = google.maps.geometry.spherical.computeHeading(P,Q);
  const off = hdg + insideSign*90;
  return [
    google.maps.geometry.spherical.computeOffset(P, halfW, off),
    google.maps.geometry.spherical.computeOffset(Q, halfW, off)
  ];
}

/* final, uniformâ€‘width inset loop -----------------------------------*/
function insetLoopUniform(path, halfW){
  const cw  = isClockwise(path);               // your existing test
  const sgn = cw ? -1 : +1;                    // inward left/right
  const inner = [];

  for (let i=0;i<path.length;i++){
    const A = path[(i-1+path.length)%path.length],
          B = path[i],
          C = path[(i+1)%path.length];

    const e1 = offsetEdge(A,B,halfW,sgn),
          e2 = offsetEdge(B,C,halfW,sgn);

    inner.push( lineIntersect(e1[0],e1[1], e2[0],e2[1]) );
  }
  return inner;
}
  </script>



<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     COLOUR + CALLOUT LOGIC â€“ 07-May-2025
     Fix: correct sub-station assignment + stable call-outs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script id="colour-logic">

  
function calculateSizing() {
/* =====================================================================
   07-May-2025  â€“ valid configs + integer parallelStrings (colour fix)
   ===================================================================== */

  /* ---------- 1. collect inverter candidates ---------- */
  const boxes = [
    document.getElementById("invChk1"),
    document.getElementById("invChk2"),
    document.getElementById("invChk3"),
    document.getElementById("invChk4"),
    document.getElementById("invChk5")
  ];
  const chosenList = [];
  boxes.forEach((b, i) => { if (b && b.checked) chosenList.push(predefinedInverters[i]); });
  if (window.ondInverterList) {
    ondInverterList.forEach((o, i) => {
      const ck = document.getElementById("ondInvChk_" + i);
      if (ck && ck.checked) chosenList.push(o);
    });
  }
  if (!chosenList.length) { result.innerHTML = '<p class="warning">No inverters selected.</p>'; return; }

  /* ---------- 2. user & module inputs ---------- */
  const minRatio = +minDcRatio.value || 0.8;
  const maxRatio = +maxDcRatio.value || 1.3;
  const lt = +lowestTemp.value, ht = +highestTemp.value;
  const dcTarget = +desiredDcCapacity.value || 100;          // kWp

  const mp  = selectedModuleWatt,
        voc = selectedModuleVoc,
        vmp = selectedModuleVmp,
        isc = selectedModuleIsc,
        tc  = (typeof selectedModuleBetaVoc !== "undefined") ? selectedModuleBetaVoc : -0.3;
  if (!mp || !voc || !vmp) { result.innerHTML = "<p class='warning'>Please select a PV module first.</p>"; return; }

  const vocC = voc * (1 + tc / 100 * (lt - 25));
  const vmpH = vmp * (1 + tc / 100 * (ht - 25));

  /* ---------- 3. size ONE inverter ---------- */
  function sizeOneInverter(targetW, inv) {
    const vdcMax  = inv.vdcMax ?? 1500,
          vmpMin  = inv.vmpptMin ?? inv.vstart ?? 600,
          mppts   = inv.mpptCount ?? 1,
          maxStrM = inv.maxStringsPerMPPT ?? 24,
          iscMax  = inv.iscMax ?? inv.idcMax ?? 15;

    const sMax = Math.floor(vdcMax / vocC);
    const sMin = Math.ceil (vmpMin / vmpH);
    if (sMax < sMin) return null;

    let best = null;
    for (let s = sMin; s <= sMax; s++) {
      const strWp    = s * mp;
      const needStr  = Math.max(1, Math.round(targetW / strWp));   // INTEGER strings
      const strPerMP = Math.min(maxStrM, Math.ceil(iscMax / isc));
      const mpptNeed = Math.ceil(needStr / strPerMP);
      if (mpptNeed > mppts) continue;

      const dcKW  = (needStr * strWp) / 1000;
      const ratio = inv.acPower ? dcKW / inv.acPower : 0;
      if (ratio < minRatio || ratio > maxRatio) continue;

      const score = Math.abs(ratio - 1.25) * 2 + Math.abs(dcKW - targetW / 1000) * 0.01;
      if (!best || score < best.score) {
        best = {
          seriesCount        : s,
          stringsPerInverter : needStr,         // integer
          parallelStrings    : needStr,         // alias for map-colour code
          dcPerInverter_kW   : dcKW,
          ratio, score
        };
      }
    }
    return best;
  }

  /* ---------- 4. explore integer quantities ---------- */
  const n = chosenList.length, solutions = [];
  function explore(idx, qty) {
    if (idx === n) {
      if (!qty.some(q => q)) return;

      const totalAC = qty.reduce((sum, q, k) => sum + (q ? (chosenList[k].acPower || 50) * q : 0), 0);
      if (!totalAC) return;

      const refs = qty.map((q, k) => (chosenList[k].acPower || 50) * q);
      const refSum = refs.reduce((a, b) => a + b, 0);

      let totalDC = 0, detRows = [];
      for (let k = 0; k < n; k++) {
        if (!qty[k]) continue;
        const shareW   = dcTarget * 1000 * (refs[k] / refSum);   // total W for this type
        const perInvW  = shareW / qty[k];                        // **per inverter**
        const inv      = chosenList[k];
        const conf     = sizeOneInverter(perInvW, inv);
        if (!conf) return;                                       // infeasible

        totalDC += conf.dcPerInverter_kW * qty[k];
        detRows.push({
          name              : inv.name,
          quantity          : qty[k],
          seriesCount       : conf.seriesCount,
          stringsPerInverter: conf.stringsPerInverter,
          parallelStrings   : conf.parallelStrings,   // <- for colouring
          dcPerInverter_kW  : conf.dcPerInverter_kW
        });
      }

      const ratio = totalDC / totalAC;
      if (ratio < minRatio || ratio > maxRatio) return;

      solutions.push({
        qtyArray: qty.slice(),
        totalDC, totalAC, ratio,
        score   : Math.abs(totalDC - dcTarget) + Math.abs(ratio - 1.25),
        details: detRows.map((row, idx) => {
    // For demonstration, pick substation #1 for half, substation #2 for the rest:
    const assignSS = (idx % 2 === 0) ? 1 : 2;
    return {
      ...row,
      substationNo: assignSS
    };  })


      });
      return;
    }
    for (let q = 0; q <= 1000; q++) { qty[idx] = q; explore(idx + 1, qty); }
  }
  explore(0, new Array(n).fill(0));

  if (!solutions.length) { result.innerHTML = '<p class="warning">No valid configurations found.</p>'; return; }
  solutions.sort((a, b) => a.score - b.score);
  const bestFive = solutions.slice(0, 5);

    /* ---------- 5. build the Excel-style table ---------- */
  const pf      = document.getElementById('powerFactor')
                    ? (+document.getElementById('powerFactor').value || 1)
                    : 1;
  const useMV   = enableMVSystem.checked;
  const capsMW  = (useMV && mvSubstationSizes.value.trim())
        ? mvSubstationSizes.value.split(',').map(v => +v.trim()).filter(v => v > 0)
        : [];

  capsMW.sort((a, b) => b - a);                               // high â†’ low
  const primaryCapKW   = (capsMW[0] ?? 0) * 1000 * pf;
  const secondaryCapKW = (capsMW[1] ?? capsMW[0] ?? 0) * 1000 * pf;

  let html = "";
  bestFive.forEach((sol, sIdx) => {

    /* -------- dynamic sub-station list (big first) -------- */
    let remKW = sol.totalAC;
    const ssCapList = [];
    while (remKW > 0 && useMV) {
      if (remKW > primaryCapKW) {
        ssCapList.push(primaryCapKW);
        remKW -= primaryCapKW;
      } else {
        if (secondaryCapKW && remKW <= secondaryCapKW) {
          ssCapList.push(secondaryCapKW);
        } else {
          ssCapList.push(primaryCapKW);
        }
        remKW = 0;
      }
    }
    if (!useMV) ssCapList.push(Infinity);                      // dummy SS

    /* -------- summary (outside the table) -------- */
    html += `
<div class="solution-summary">
  <strong>Solution ${sIdx + 1}</strong> â€“ 
  Total DC (kWp): <span>${sol.totalDC.toFixed(0)}</span>  
  Total AC (kW): <span>${sol.totalAC.toFixed(0)}</span>  
  DC/AC: <span>${sol.ratio.toFixed(2)}</span>

  <button class="use-btn" onclick="selectSolution(${sIdx})">Use&nbsp;This</button>
  <button class="details-icon-btn" onclick="showIECCheckDetails(${sIdx})">!</button>
</div>`;

    /* -------- start the table -------- */
    html += `
<table class="solution-table">
  <thead>
    <tr>
      <th>SS #</th><th>SS MVA</th>
      <th>Inverter Name</th><th>Qty</th>
      <th>Modules/String</th><th>Strings/Inv</th>
      <th>DC&nbsp;(kWp)/Inv</th><th>AC&nbsp;(kW)/Inv</th>
      <th>Total DC (kWp)</th><th>Total AC (kW)</th><th>DC/AC</th>
      <th>TX&nbsp;loading&nbsp;%</th>
    </tr>
  </thead>
  <tbody>`;

    /* -------- allocator with TX-loading calc -------- */
    let ssIdx = 0, ssCapKW = ssCapList[0], ssUsedKW = 0;

    const pushRow = (row, qty) => {
      const rowAcTot = row.acPerInv * qty;
      const rowDcTot = row.dcPerInv * qty;
      ssUsedKW += rowAcTot;                                     // update first!
      const loadPct = ssCapKW !== Infinity
            ? ((ssUsedKW / ssCapKW) * 100).toFixed(1)
            : "";
      const ratio   = rowAcTot ? rowDcTot / rowAcTot : 0;

      html += `<tr>
        <td>${useMV ? ssIdx + 1 : ""}</td>
        <td>${useMV ? (ssCapKW === Infinity ? "âˆž" : (ssCapKW / (1000 * pf))) : ""}</td>
        <td>${row.name}</td><td>${qty}</td>
        <td>${row.series}</td><td>${row.strPerInv}</td>
        <td>${row.dcPerInv.toFixed(1)}</td><td>${row.acPerInv}</td>
        <td>${rowDcTot.toFixed(0)}</td><td>${rowAcTot.toFixed(0)}</td>
        <td>${ratio.toFixed(2)}</td>
        <td>${loadPct}</td>
      </tr>`;
    };

    sol.details.forEach(det => {
      const invObj = chosenList.find(x => x.name === det.name) || {};
      const row = {
        name      : det.name,
        series    : det.seriesCount,
        strPerInv : det.parallelStrings,
        dcPerInv  : det.dcPerInverter_kW,
        acPerInv  : invObj.acPower || 0
      };
      let qtyLeft = det.quantity;

      while (qtyLeft > 0) {
        if (!useMV) { pushRow(row, qtyLeft); qtyLeft = 0; continue; }

        while (row.acPerInv > ssCapKW) {                       // inverter bigger than SS
          ssIdx++;
          ssCapKW = ssCapList[Math.min(ssIdx, ssCapList.length - 1)];
          ssUsedKW = 0;
        }

        const freeKW = ssCapKW - ssUsedKW;
        const fitQty = Math.floor(freeKW / row.acPerInv);
        if (fitQty === 0) {                                    // next SS
          ssIdx++;
          ssCapKW = ssCapList[Math.min(ssIdx, ssCapList.length - 1)];
          ssUsedKW = 0;
          continue;
        }
        const assign = Math.min(qtyLeft, fitQty);
        pushRow(row, assign);
        qtyLeft -= assign;
      }
    });

    html += "</tbody></table><br/>";
  });

  /* -------- inject into the modal -------- */
  result.innerHTML = html;
  window.bestSizingSolutions = bestFive;
}





setupPredefinedReplaceButtons();
populateAllPredefinedInverterDropdowns();



function selectSolution(i){
  if(!window.bestSizingSolutions) return;

  const sol = window.bestSizingSolutions[i];
  if(!sol || !window.applyInverterConfiguration) return;

  /* 1. apply the inverter/string/Sub-station assignment               */
  window.applyInverterConfiguration(sol);          // colours meta-data only

  /* 2. repaint the rectangles now they have that meta-data             */
  const useMV = enableMVSystem.checked;            // TRUE = MV mode
  if(window.recolorPVLayout) recolorPVLayout(useMV);

  /* 3. tidy up â€“ close the modal                                       */
  document.getElementById("inverter-sizing-modal").style.display = "none";





  
}








    function showIECCheckDetails(index) {
  const sol = window.bestSizingSolutions[index];
  if (!sol) return;

  /* module + temp inputs */
  const lt   = parseFloat(document.getElementById("lowestTemp").value);
  const ht   = parseFloat(document.getElementById("highestTemp").value);
  const beta = (typeof selectedModuleBetaVoc !== "undefined") ? selectedModuleBetaVoc : -0.3;
  const voc  = selectedModuleVoc;
  const vmp  = selectedModuleVmp;
  const isc  = selectedModuleIsc;
  const mp   = selectedModuleWatt;

  const vocC = voc * (1 + (beta / 100) * (lt - 25));
  const vmpH = vmp * (1 + (beta / 100) * (ht - 25));

  let html = `<h3>IEC / PV-Syst Compliance</h3>
    <p><b>Module:</b> ${mp} W | Voc ${voc} V | Vmp ${vmp} V | Isc ${isc} A | Î²Voc ${beta}%/Â°C</p>
    <p><b>Ambient T:</b> ${lt} Â°C â†’ ${ht} Â°C</p><hr/>
    <table style="width:100%;border-collapse:collapse;font-size:0.83em">
      <thead><tr>
        <th>Inverter</th><th>S</th><th>P</th><th>P<sub>dc</sub></th>
        <th>Voc&nbsp;@T<sub>min</sub></th><th>Vmp window</th>
        <th>IscÃ—1.25</th><th>Start-up</th>
      </tr></thead><tbody>`;

  sol.details.forEach(inv => {
    if (!inv) return;
    const obj = window.inverterLibrary.find(x => x.name === inv.name);
    if (!obj) return;

    const vdcMax   = obj.vdcMax   ?? 1500;
    const vstart   = obj.vstart   ?? 600;
    const vmpptMin = obj.vmpptMin ?? vstart;
    const vmpptMax = obj.vmpptMax ?? vdcMax * 0.9;
    const mpptCnt  = obj.mpptCount?? 1;
    const iscMax   = obj.iscMax   ?? obj.idcMax ?? 15;

    const strVoc   = vocC * inv.seriesCount;
    const strVmp   = vmpH * inv.seriesCount;
    const totIsc   = isc * inv.parallelStrings * 1.25;

    const vocOK   = strVoc < vdcMax                             ? "âœ…" : "âŒ";
    const vmpOK   = (strVmp > vmpptMin && strVmp < vmpptMax)    ? "âœ…" : "âŒ";
    const iscOK   = totIsc <= (iscMax * mpptCnt)                ? "âœ…" : "âŒ";
    const startOK = strVmp >= vstart                            ? "âœ…" : "âš ï¸";

    html += `<tr>
      <td>${inv.name}</td>
      <td>${inv.seriesCount}</td>
      <td>${inv.parallelStrings}</td>
      <td>${(inv.actualPower_W/1000).toFixed(2)} kW</td>
      <td>${vocOK}<br/>${strVoc.toFixed(1)} V &lt; ${vdcMax}</td>
      <td>${vmpOK}<br/>${vmpptMin} V &lt; ${strVmp.toFixed(1)} V &lt; ${vmpptMax}</td>
      <td>${iscOK}<br/>${totIsc.toFixed(1)} A â‰¤ ${iscMax*mpptCnt}</td>
      <td>${startOK}<br/>V<sub>start</sub> ${vstart} V</td>
    </tr>`;
  });

  html += "</tbody></table>";
  showFloatingModal(html);
}
function showFloatingModal(html) {
  let m = document.getElementById("floating-iec-modal");
  if (!m) {
    m = document.createElement("div");
    m.id = "floating-iec-modal";
    Object.assign(m.style, {
      position: "fixed",
      top: "60px",
      left: "50%",
      transform: "translateX(-50%)",
      maxWidth: "800px",
      maxHeight: "70vh",
      overflowY: "auto",
      background: "#fff",
      border: "1px solid #ccc",
      borderRadius: "8px",
      padding: "16px",
      zIndex: 999999,
      boxShadow: "0 4px 12px rgba(0,0,0,0.2)"
    });
    document.body.appendChild(m);
  }

  m.innerHTML = `<div style="text-align:right;"><button onclick="this.parentElement.parentElement.style.display='none'">Close</button></div>${html}`;
  m.style.display = "block";
}


  /* â”€â”€ 0. global inverter-colour cursor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (typeof window.INV_COLOR_SEQ === "undefined") window.INV_COLOR_SEQ = 0;
  
  /* â”€â”€ 1. colour helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function hslToHex(h, s, l) {
    s /= 100; l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => {
      const c = l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
      return Math.round(255 * c).toString(16).padStart(2, "0");
    };
    return `#${f(0)}${f(8)}${f(4)}`;
  }
  function shade(hex, p){
    let n = parseInt(hex.slice(1),16), a = Math.round(2.55*p);
    let r = (n>>16)+a, g=((n>>8)&255)+a, b=(n&255)+a;
    return `#${(0x1000000 + ((Math.min(255,Math.max(0,r))<<16)
          + (Math.min(255,Math.max(0,g))<<8)
          + Math.min(255,Math.max(0,b)))).toString(16).slice(1)}`;
  }
  function strShade(base,k,total){
    const offset=((k/total)-0.5)*35;   // Â±17.5 %
    return shade(base,offset);
  }
  function generateInverterColor(i){            // evenly spaced hues
    return hslToHex((i*57)%360, 70, 50);
  }
  
  /* â”€â”€ 2. orientation helpers (row detection) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function isVerticalLayout(){
    const el=document.getElementById("angle-input");
    if(!el) return false;
    const a=(+el.value)%180;
    return (a>45 && a<135);
  }
  function orderRectanglesByRow(rects,vertical){
    const arr=rects.slice();
    arr.forEach(r=>{
      const b=r.getBounds();
      r._cLat=(b.getNorthEast().lat()+b.getSouthWest().lat())/2;
      r._cLng=(b.getNorthEast().lng()+b.getSouthWest().lng())/2;
    });
    arr.sort((p,q)=>{
      if(vertical){
        const d=q._cLng-p._cLng;
        return Math.abs(d)>1e-7 ? (d>0?1:-1) : (p._cLat-q._cLat);
      }
      const d=q._cLat-p._cLat;
      return Math.abs(d)>1e-7 ? (d>0?1:-1) : (p._cLng-q._cLng);
    });
    return arr;
  }
  function rowsOf(rects,vertical){
    const rows=[],cur=[]; let last=null;
    rects.forEach(r=>{
      const key=vertical?r._cLng:r._cLat;
      if(last===null||Math.abs(key-last)<1e-7){cur.push(r);}
      else{rows.push(cur.slice());cur.length=0;cur.push(r);}
      last=key;
    });
    if(cur.length) rows.push(cur);
    return rows;
  }
  
  /* â”€â”€ 3. util: get sub-station index from a solution line â”€â”€â”€â”€â”€â”€â”€ */
  function getSSIdx(det,fallback){
    const ssRaw = det.ss   ?? det.ssNo
               ?? det.substation ?? det.substationNo;
    const ssNum = (ssRaw!==undefined) ? Number(ssRaw) : (fallback+1);
    return (isFinite(ssNum) && ssNum>0) ? ssNum-1 : fallback; // 0-based
  }
  
  /* â”€â”€ 4. MAIN â€“ apply chosen inverter configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  window.applyInverterConfiguration = function(sol){
    if(!selectedPolygon){alert("No polygon selected!");return;}
    const rawRects = polygonRectanglesMap.get(selectedPolygon)||[];
    if(!rawRects.length){alert("Fill modules first!");return;}
  
    const vertical = isVerticalLayout();
    const rectRows = rowsOf(orderRectanglesByRow(rawRects,vertical),vertical);
  
    /* 4-A. build sub-station capacity list */
    const useMV = enableMVSystem.checked;
    const pf    = parseFloat(powerFactor.value)||1;
    let ssCapList;
  
    if(useMV){
      let caps=(mvSubstationSizes.value||"")
                .split(/[, ]+/).map(x=>parseFloat(x)).filter(x=>x>0);
      if(!caps.length) caps=[99999];          // safety fallback
      let rem=sol.totalAC, idx=0;
      ssCapList=[];
      while(rem>0.001){
        const capKW = caps[idx%caps.length]*1000*pf;
        ssCapList.push(capKW);
        rem -= capKW;
        if(idx++>100){console.warn("MV loop guard");break;}
      }
    }else{
      /* - no MV: just make enough slots full of Infinity */
      const maxSS = Math.max(...sol.details.map(
          (d,i)=>getSSIdx(d,i))) + 1;
      ssCapList = Array(maxSS).fill(Infinity);
    }
  
    /* 4-B. allocation loops */
    let rowPtr=0, colPtr=0;
    sol.details.forEach((det,detIdx)=>{
      if(!det||det.quantity===0) return;
  
      let ssIdx = getSSIdx(det,detIdx);          // <-- fixed source
      if(ssIdx>=ssCapList.length) ssCapList.length = ssIdx+1;
      if(ssCapList[ssIdx]===undefined) ssCapList[ssIdx]=Infinity;
      let ssFree = ssCapList[ssIdx];
  
      /* inverter AC power */
      const m = det.name?.match(/(\d+)\s?kW/i);
      const invAC = m ? parseFloat(m[1]) : (det.acPower||50);
  
      for(let inv=0; inv<det.quantity; inv++){
  
        /* move to next SS bucket if full */
        while(invAC > ssFree+0.001){
          ssIdx++;
          if(ssIdx>=ssCapList.length) ssCapList.push(Infinity);
          ssFree = ssCapList[ssIdx];
        }
  
        const baseColor = generateInverterColor(window.INV_COLOR_SEQ++);
  
        for(let s=1; s<=det.parallelStrings; s++){
          const strColor = strShade(baseColor, s-1, det.parallelStrings);
          let placed=0;
  
          while(placed<det.seriesCount && rowPtr<rectRows.length){
            const row = rectRows[rowPtr];
  
            while(colPtr<row.length && placed<det.seriesCount){
              const r = row[colPtr++];
  
              /* store meta on the rectangle */
              r.substationIdx = ssIdx;
              r.inverterNo    = inv+1;
              r.stringNo      = s;
  
              /* colour it */
              r.setOptions({
                fillColor   : strColor,
                strokeColor : strColor,
                fillOpacity : 0.72,
                zIndex      : 10
              });
  
              /* stable call-out text */
              const lblSS  = ssIdx+1;
              const lblInv = inv+1;
              const lblStr = s;
              const callout = `SS${lblSS} | Inv${lblInv} (${invAC} kW) | Str${lblStr}`;
  
              google.maps.event.clearListeners(r,"mouseover");
              google.maps.event.addListener(r,"mouseover",e=>{
                showCalloutBox(e.domEvent,callout);
              });
              google.maps.event.clearListeners(r,"mouseout");
              google.maps.event.addListener(r,"mouseout",hideCalloutBox);
  
              placed++;
            }
            if(colPtr>=row.length){ rowPtr++; colPtr=0; }
          }
        }
        ssFree -= invAC;        // reduce remaining capacity
      }
    });
  
    /* 4-C. leftover rectangles â†’ black */
    for(;rowPtr<rectRows.length;rowPtr++){
      const row=rectRows[rowPtr];
      for(;colPtr<row.length;colPtr++){
        const r=row[colPtr];
        r.setOptions({fillColor:"#000",strokeColor:"#000",
                      fillOpacity:0.6,zIndex:10});
        r.inverterNo=null;
      }
      colPtr=0;
    }
  
    document.getElementById("inverter-sizing-modal").style.display="none";
  };
  </script>
  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  






  <!-- cableTools, exportTools, databaseModules, Obstacles, etc. -->
  <script src="cableTools.js"></script>
  <script src="exportTools.js"></script>
  <script src="databaseModules.js"></script>
  <script src="InverterLibrary16.js"></script>

  

  <!-- Now load the extracted Electrical Design code -->
  <script src="ElectricalDesign.JS"></script>
  <script src="foundationDesign.js"></script>
  <script src="cableTools.js"></script>
  

  <!-- main.html -->
  


</body>
</html>

 

