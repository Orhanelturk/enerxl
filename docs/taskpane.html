<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>EnerXL Map</title>
<style>
  :root{
    --panel:#fff; --panel-border:#e6e8ee; --shadow:0 6px 20px rgba(0,0,0,.10);
    --icon:#2f3a55; --accent:#3a7afe; --accent-ghost:rgba(58,122,254,.12);
  }
  html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #app{position:relative;height:100vh;width:100vw;overflow:hidden}

  /* Map fills entire pane (no header) */
  #map{position:absolute;inset:0 0 0 0}

  /* Controllers */
  .control-pane{
    position:absolute;top:12px;left:10px;
    width:42px;padding:6px 5px;box-sizing:border-box;background:var(--panel);
    border:1px solid var(--panel-border);border-radius:14px;box-shadow:var(--shadow);
    display:flex;flex-direction:column;align-items:center;gap:6px;z-index:30;user-select:none
  }
  .mini-pane{
    position:absolute;bottom:14px;right:10px;
    width:42px;padding:6px 5px;background:#fff;border:1px solid var(--panel-border);
    border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;gap:6px;z-index:30
  }
  .group-sep{height:1px;width:100%;background:var(--panel-border);margin:6px 0}
  .tool-btn{
    width:28px;height:28px;border-radius:8px;border:1px solid #e9ecf3;display:grid;place-items:center;background:#fff;cursor:pointer;
    transition:transform .05s ease,background .15s ease,border-color .15s ease
  }
  .tool-btn:hover{background:#f0f3fb} .tool-btn:active{transform:scale(.98)}
  .tool-btn.is-primary{border-color:transparent;background:var(--accent-ghost)}
  .tool-btn svg{width:16px;height:16px;stroke:var(--icon)}
  .tool-btn.is-primary svg{stroke:var(--accent)}

  .search-wrap{
    position:absolute;top:12px;left:70px;z-index:25;background:#fff;border:1px solid var(--panel-border);
    border-radius:12px;box-shadow:var(--shadow);padding:6px 10px;display:flex;align-items:center;gap:8px;min-width:260px
  }
  .search-wrap input{width:100%;outline:none;border:none;font-size:14px;padding:6px 2px;background:transparent;color:#1e2433}

  .chip{position:absolute;bottom:70px;left:70px;z-index:25;background:#fff;border:1px solid var(--panel-border);
        border-radius:999px;padding:8px 12px;font-size:12px;color:#263248;box-shadow:var(--shadow)}

  /* ‚ÄúFill-pane‚Äù full-screen toggle (controls remain) */
  body.fs #map{inset:0 0 0 0}
</style>
</head>
<body>
<div id="app">
  <div id="map" role="application" aria-label="Map"></div>

  <!-- Left tools -->
  <div class="control-pane" aria-label="Tools">
    <button class="tool-btn is-primary" data-tool="select" title="Select / Pan" aria-label="Select">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 4l8 8"/><path d="M4 12V4h8"/><path d="M13 13l7 7"/><path d="M15 19l-4-4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="search" title="Search" aria-label="Search">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="draw" title="Draw polygon" aria-label="Draw polygon">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 7l6-3 6 3 0 7-6 3-6-3z"/>
        <circle cx="9" cy="4" r="1.2"/><circle cx="15" cy="7" r="1.2"/><circle cx="15" cy="14" r="1.2"/>
        <circle cx="9" cy="17" r="1.2"/><circle cx="3" cy="7" r="1.2"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="clear" title="Clear" aria-label="Clear">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 6h18"/><path d="M8 6l1-2h6l1 2"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/>
      </svg>
    </button>
    <div class="group-sep"></div>
    <button class="tool-btn" data-tool="layers" title="Layers" aria-label="Layers">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2l9 5-9 5-9-5 9-5z"/><path d="M3 12l9 5 9-5"/><path d="M3 17l9 5 9-5"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="measure" title="Measure" aria-label="Measure">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 18l12-12 6 6-12 12H3v-6z"/><path d="M14 6l4 4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="export" title="Export" aria-label="Export">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3v12"/><path d="M8 9l4 4 4-4"/><path d="M20 21H4"/>
      </svg>
    </button>
    <button class="tool-btn" data-tool="settings" title="Settings" aria-label="Settings">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.26-.39 1.51-1z"/>
      </svg>
    </button>
  </div>

  <!-- Right: zoom + full screen + pop-out -->
  <div class="mini-pane" aria-label="Map controls">
    <button class="tool-btn" data-tool="zoom-in" title="Zoom in" aria-label="Zoom in">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
    </button>
    <button class="tool-btn" data-tool="zoom-out" title="Zoom out" aria-label="Zoom out">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
    </button>
    <div class="group-sep"></div>
    <button class="tool-btn" data-tool="fullscreen" title="Fill task pane" aria-label="Fill task pane">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 3H3v6M15 3h6v6M9 21H3v-6M21 15v6h-6"/>
      </svg>
    </button>
    <!-- Pop-out to real full-screen capable window -->
    <button class="tool-btn" data-tool="popout" title="Open in new window" aria-label="Open in new window">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 3h7v7"/><path d="M21 3l-9 9"/><rect x="3" y="7" width="10" height="14" rx="2" ry="2"/>
      </svg>
    </button>
  </div>

  <div class="search-wrap">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7f8aa3" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/>
    </svg>
    <input id="search-input" type="text" placeholder="Search location‚Ä¶" aria-label="Search location" />
  </div>

  <div id="chip" class="chip" style="display:none;"></div>
</div>

<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS8L-j2sIfptPCLDUIMP3314KPrKq4394&libraries=places,drawing,geometry&callback=initMap"></script>
<script>
  // If Office.js is present, it will be available under window.Office
  window.initMap = function(){
    const center = { lat: 23.5859, lng: 58.4059 }; // Muscat
    const map = new google.maps.Map(document.getElementById('map'), {
      center, zoom: 5,
      mapTypeId: 'satellite',
      mapTypeControl: false, fullscreenControl: false, streetViewControl: false
    });

    let searchMarker = null;

    // Places autocomplete
    const input = document.getElementById('search-input');
    const ac = new google.maps.places.Autocomplete(input, { fields: ['geometry','name'] });
    ac.bindTo('bounds', map);
    ac.addListener('place_changed', () => {
      const p = ac.getPlace();
      if (!p.geometry || !p.geometry.location) return;
      map.panTo(p.geometry.location); map.setZoom(12);
      if (!searchMarker) searchMarker = new google.maps.Marker({ map, position: p.geometry.location });
      else searchMarker.setPosition(p.geometry.location);
      showChip(`üìç ${p.name || 'Location'}`);
    });

    const byTool = (t)=>document.querySelector(`[data-tool="${t}"]`);
    ['select','search','draw','clear','layers','measure','export','settings','zoom-in','zoom-out','fullscreen','popout']
    .forEach(t=>{
      const el = byTool(t); if(!el) return;
      el.addEventListener('click', async ()=>{
        switch(t){
          case 'search': input.focus(); input.select(); break;
          case 'zoom-in': map.setZoom(map.getZoom()+1); break;
          case 'zoom-out': map.setZoom(map.getZoom()-1); break;
          case 'fullscreen': fillTaskPane(); break;
          case 'popout': openExternal(); break;
          default: flashPrimary(el); showChip(`Tool: ${t}`);
        }
      });
    });

    function flashPrimary(el){
      const was=el.classList.contains('is-primary');
      document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('is-primary'));
      if(!was) el.classList.add('is-primary');
    }
    function showChip(text){
      const c=document.getElementById('chip'); c.textContent=text; c.style.display='inline-flex';
      clearTimeout(showChip._t); showChip._t=setTimeout(()=>c.style.display='none', 2000);
    }

    // Fills the task pane area (controls remain)
    function fillTaskPane(){
      document.body.classList.toggle('fs');
      google.maps.event.trigger(map,'resize');
    }

    // Open external window where real full-screen is possible
    function openExternal(){
      const url = makeStandaloneUrl();
      // Prefer Office dialog to avoid popup blockers & stay associated with Office
      if (window.Office && Office.context && Office.context.ui && Office.context.ui.displayDialogAsync){
        // For desktop Excel, displayInIframe:false opens system browser window (real OS-level window)
        Office.context.ui.displayDialogAsync(url, { height: 90, width: 90, displayInIframe: false }, function (asyncResult) {
          // No-op; user can use the external window's fullscreen
        });
      } else {
        // Fallback to normal popup/new tab
        const w = window.open(url, '_blank', 'noopener,noreferrer');
        if (!w) showChip('Popup blocked‚Äîallow popups for full screen');
      }
    }

    // Build a lightweight standalone view of this page (same file) with ?standalone=1
    function makeStandaloneUrl(){
      const u = new URL(window.location.href);
      u.searchParams.set('standalone','1');
      return u.href;
    }

    // If opened in standalone mode, auto-request browser fullscreen (best effort)
    (function tryStandaloneFS(){
      const params = new URLSearchParams(window.location.search);
      if (params.get('standalone') === '1'){
        // Try to request fullscreen after a user gesture (first click)
        const arm = () => {
          document.removeEventListener('click', arm, true);
          if (document.documentElement.requestFullscreen){
            document.documentElement.requestFullscreen().catch(()=>{});
          }
        };
        document.addEventListener('click', arm, true);
      }
    })();

    window.addEventListener('resize', ()=>google.maps.event.trigger(map,'resize'));
  };
</script>
</body>
</html>
