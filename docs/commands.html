<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />
  <title>EnerXL Commands (No-Log)</title>

  <!-- Office runtime MUST load before the command handlers -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
  (function () {
    // ---------------- Settings ----------------
    var v = (new URLSearchParams(location.search).get("v") || "").trim();
    var TEMPLATE_URL = "https://orhanelturk.github.io/enerxl/Book1.xlsx" + (v ? ("?v=" + encodeURIComponent(v)) : "");
    var TARGET_SHEET_NAME = "System Summary";   // preferred sheet inside template
    var RENAMED_SHEET_NAME = "Solar Template";  // desired final name
    var SHOW_DIALOGS = true;                    // set false to be completely silent
    var HIDE_LEGACY_LOG_SHEET = true;          // auto-hide an existing "_EnerXL_Log" if present

    // ---------------- Lightweight notify (no sheet logging) ----------------
    function notify(message) {
      try { console.log("[EnerXL]", message); } catch (_) {}
      if (!SHOW_DIALOGS) return;

      try {
        var html =
          '<!doctype html><html><body style="font:14px system-ui;padding:16px;line-height:1.4">' +
          '<div>' + String(message || "").replace(/</g, "&lt;") + "</div>" +
          '<div style="margin-top:12px">' +
          '<button onclick="window.close()" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f6f6f6">Close</button>' +
          "</div></body></html>";

        // Fire-and-forget so the command never stalls
        void OfficeRuntime.displayWebDialog("data:text/html," + encodeURIComponent(html), {
          height: 30,
          width: 40,
          displayInIframe: false
        });
      } catch (_) { /* dialogs may be blocked; console log is enough */ }
    }

    function ensureSupportOrThrow() {
      var ok = Office && Office.context && Office.context.requirements &&
               Office.context.requirements.isSetSupported &&
               Office.context.requirements.isSetSupported("ExcelApi", "1.13");
      if (!ok) {
        throw new Error("ExcelApi 1.13+ is required (insertWorksheetsFromBase64). Use Excel on the web or update Desktop.");
      }
    }

    // ---------------- Helpers ----------------
    function arrayBufferToBase64(buffer) {
      var binary = "", bytes = new Uint8Array(buffer), chunk = 0x8000;
      for (var i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    async function fetchTemplateBase64(url) {
      var resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error("Template fetch failed: " + resp.status + " " + resp.statusText + " @ " + url);
      var buf = await resp.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    async function getUniqueSheetName(context, desired) {
      var sheets = context.workbook.worksheets;
      sheets.load("items/name");
      await context.sync();
      var existing = new Set(sheets.items.map(function (s) { return s.name; }));
      if (!existing.has(desired)) return desired;
      var i = 2;
      while (existing.has(desired + " (" + i + ")")) i++;
      return desired + " (" + i + ")";
    }

    // Hide (don’t delete) an old log sheet if it exists, so no tab shows up.
    async function maybeHideLegacyLogSheet() {
      if (!HIDE_LEGACY_LOG_SHEET) return;
      try {
        await Excel.run(async function (context) {
          var ws = context.workbook.worksheets.getItemOrNullObject("_EnerXL_Log");
          ws.load("name");
          await context.sync();
          if (!ws.isNullObject) {
            ws.visibility = "VeryHidden"; // hide from UI without removing data
            await context.sync();
          }
        });
      } catch (_) { /* ignore */ }
    }

    async function insertNamedSheetFromBase64(base64, sheetName, renameTo) {
      return await Excel.run(async function (context) {
        var wb = context.workbook;

        wb.insertWorksheetsFromBase64(base64, {
          sheetNamesToInsert: [sheetName],
          positionType: Excel.WorksheetPositionType.end
        });
        await context.sync();

        var ws = wb.worksheets.getItem(sheetName);
        var finalName = renameTo ? await getUniqueSheetName(context, renameTo) : sheetName;
        if (renameTo) ws.name = finalName;

        wb.worksheets.getItem(finalName).activate();
        await context.sync();
        return finalName;
      });
    }

    async function insertAllSheetsFromBase64(base64, renameTo) {
      return await Excel.run(async function (context) {
        var wb = context.workbook;

        var before = wb.worksheets;
        before.load("items/name");
        await context.sync();
        var countBefore = before.items.length;

        wb.insertWorksheetsFromBase64(base64, { positionType: Excel.WorksheetPositionType.end });
        await context.sync();

        var after = wb.worksheets;
        after.load("items/name");
        await context.sync();

        if (after.items.length <= countBefore) throw new Error("No sheets were inserted (unexpected).");

        var newFirst = after.items[countBefore];
        var finalName = newFirst.name;
        if (renameTo) {
          finalName = await getUniqueSheetName(context, renameTo);
          newFirst.name = finalName;
        }

        after.getItem(finalName).activate();
        await context.sync();
        return finalName;
      });
    }

    // ---------------- Commands ----------------
    async function createSolarTemplate(event) {
      try {
        ensureSupportOrThrow();
        await maybeHideLegacyLogSheet();
        notify("⏳ Fetching template…");
        var base64 = await fetchTemplateBase64(TEMPLATE_URL);

        try {
          var finalName1 = await insertNamedSheetFromBase64(base64, TARGET_SHEET_NAME, RENAMED_SHEET_NAME);
          notify("✅ Inserted “" + TARGET_SHEET_NAME + "” as “" + finalName1 + "”.");
        } catch (namedErr) {
          notify("ℹ️ Couldn't insert only “" + TARGET_SHEET_NAME + "”. Inserting all sheets…\nReason: " +
                 (namedErr && namedErr.message ? namedErr.message : String(namedErr)));
          var finalName2 = await insertAllSheetsFromBase64(base64, RENAMED_SHEET_NAME);
          notify("✅ Inserted all sheets. Activated “" + finalName2 + "”.");
        }
      } catch (err) {
        console.error(err);
        notify("❌ Create Template failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        try { event.completed(); } catch (_) {}
      }
    }

    async function createSolarTemplateAll(event) {
      try {
        ensureSupportOrThrow();
        await maybeHideLegacyLogSheet();
        notify("⏳ Fetching template (all sheets) …");
        var base64 = await fetchTemplateBase64(TEMPLATE_URL);
        var finalName = await insertAllSheetsFromBase64(base64, RENAMED_SHEET_NAME);
        notify("✅ Inserted all sheets. Activated “" + finalName + "”.");
      } catch (err) {
        console.error(err);
        notify("❌ Create Template (All) failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        try { event.completed(); } catch (_) {}
      }
    }

    // Optional sanity command
    async function addBlankSheet(event) {
      try {
        await Excel.run(async function (context) {
          var name = "EnerXL_Test";
          var ws = context.workbook.worksheets.add(name);
          ws.getRange("A1").values = [["✅ Command fired."]];
          ws.activate();
          await context.sync();
        });
        notify("✅ Added a blank sheet named “EnerXL_Test”.");
      } catch (err) {
        notify("❌ addBlankSheet failed: " + (err && err.message ? err.message : String(err)));
      } finally { try { event.completed(); } catch (_) {} }
    }

    // ---------------- Registration ----------------
    Office.onReady(function () {
      Office.actions.associate("createSolarTemplate", createSolarTemplate);
      Office.actions.associate("createSolarTemplateAll", createSolarTemplateAll);
      Office.actions.associate("addBlankSheet", addBlankSheet);
    });
  })();
  </script>
</head>
<body>
  <!-- Hidden host page for ExecuteFunction commands. Intentionally empty. -->
  <noscript>EnerXL requires JavaScript to run.</noscript>
</body>
</html>
