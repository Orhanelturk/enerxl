<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />
  <title>EnerXL Commands (FunctionFile)</title>

  <!-- Office runtime MUST load before the command handlers -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
  (function () {
    // ---------------- Configuration ----------------
    // Forward the version from the manifest's URL (e.g., commands.html?v=2025.10.31-005)
    var v = (new URLSearchParams(location.search).get("v") || "").trim();
    var TEMPLATE_URL = "https://orhanelturk.github.io/enerxl/Book1.xlsx" + (v ? ("?v=" + encodeURIComponent(v)) : "");
    var TARGET_SHEET_NAME = "System Summary";   // preferred sheet inside template
    var RENAMED_SHEET_NAME = "Solar Template";  // desired final name
    var LOG_SHEET = "_EnerXL_Log";

    // ---------------- Utilities ----------------
    function arrayBufferToBase64(buffer) {
      var binary = "", bytes = new Uint8Array(buffer), chunk = 0x8000;
      for (var i = 0; i < bytes.length; i += chunk) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    async function logToSheet(lines) {
      try {
        await Excel.run(async (context) => {
          var sheets = context.workbook.worksheets;
          var ws = sheets.getItemOrNullObject(LOG_SHEET);
          ws.load("name");
          await context.sync();
          if (ws.isNullObject) {
            ws = sheets.add(LOG_SHEET);
          }

          // Read existing text from A1, append with timestamp, write back.
          var rng = ws.getRange("A1");
          rng.load("values");
          await context.sync();

          var existing = (rng.values && rng.values[0] && rng.values[0][0]) ? String(rng.values[0][0]) : "";
          var stamp = new Date().toISOString();
          var add = Array.isArray(lines) ? lines.join("\n") : String(lines);
          var combined = (existing ? existing + "\n" : "") + "[" + stamp + "] " + add;

          ws.getRange("A1").values = [[combined]];
          await context.sync();
        });
      } catch (e) {
        // Logging must never break the command.
        try { console.warn("EnerXL logToSheet failed:", e); } catch (_) {}
      }
    }

    // Non-blocking toast: we await ONLY the sheet log (safe), but NOT the dialog.
    async function notify(message) {
      try { await logToSheet(message); } catch (_) {}
      try {
        var html =
          '<!doctype html><html><body style="font:14px system-ui;padding:16px;line-height:1.4">' +
          '<div>' + String(message || "").replace(/</g, "&lt;") + "</div>" +
          '<div style="margin-top:12px">' +
          '<button onclick="window.close()" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#f6f6f6">Close</button>' +
          "</div></body></html>";

        // Fire-and-forget: do NOT await (avoids stalling ExecuteFunction)
        void OfficeRuntime.displayWebDialog(
          "data:text/html," + encodeURIComponent(html),
          { height: 30, width: 40, displayInIframe: false }
        );
      } catch (_) {
        // Dialogs can be blocked by policy; the in-sheet log is enough.
      }
    }

    function ensureSupportOrThrow() {
      var ok = Office && Office.context && Office.context.requirements &&
               Office.context.requirements.isSetSupported &&
               Office.context.requirements.isSetSupported("ExcelApi", "1.13");
      if (!ok) {
        throw new Error("ExcelApi 1.13+ is required (insertWorksheetsFromBase64). Try Excel on the web or update Desktop.");
      }
    }

    async function fetchTemplateBase64(url) {
      var resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error("Template fetch failed: " + resp.status + " " + resp.statusText + " @ " + url);
      var buf = await resp.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    async function getUniqueSheetName(context, desired) {
      var sheets = context.workbook.worksheets;
      sheets.load("items/name");
      await context.sync();
      var existing = new Set(sheets.items.map(function (s) { return s.name; }));
      if (!existing.has(desired)) return desired;
      var i = 2;
      while (existing.has(desired + " (" + i + ")")) i++;
      return desired + " (" + i + ")";
    }

    async function insertNamedSheetFromBase64(base64, sheetName, renameTo) {
      return await Excel.run(async (context) => {
        var wb = context.workbook;

        wb.insertWorksheetsFromBase64(base64, {
          sheetNamesToInsert: [sheetName],
          positionType: Excel.WorksheetPositionType.end
        });
        await context.sync();

        var ws = wb.worksheets.getItem(sheetName);
        var finalName = renameTo ? await getUniqueSheetName(context, renameTo) : sheetName;
        if (renameTo) ws.name = finalName;

        // Activate the sheet we just inserted/renamed
        ws.activate();
        await context.sync();
        return finalName;
      });
    }

    async function insertAllSheetsFromBase64(base64, renameTo) {
      return await Excel.run(async (context) => {
        var wb = context.workbook;

        var before = wb.worksheets;
        before.load("items/name");
        await context.sync();
        var beforeNames = new Set(before.items.map(function (s) { return s.name; }));

        wb.insertWorksheetsFromBase64(base64, { positionType: Excel.WorksheetPositionType.end });
        await context.sync();

        var after = wb.worksheets;
        after.load("items/name");
        await context.sync();

        // Find the first newly inserted sheet by name difference
        var newSheets = after.items.filter(function (s) { return !beforeNames.has(s.name); });
        if (!newSheets.length) throw new Error("No sheets were inserted (unexpected).");

        var newFirst = newSheets[0];
        var finalName = newFirst.name;
        if (renameTo) {
          finalName = await getUniqueSheetName(context, renameTo);
          newFirst.name = finalName;
        }

        wb.worksheets.getItem(finalName).activate();
        await context.sync();
        return finalName;
      });
    }

    // ---------------- Commands ----------------
    async function createSolarTemplate(event) {
      try {
        ensureSupportOrThrow();
        await notify("⏳ Fetching template…");
        var base64 = await fetchTemplateBase64(TEMPLATE_URL);

        try {
          var finalName1 = await insertNamedSheetFromBase64(base64, TARGET_SHEET_NAME, RENAMED_SHEET_NAME);
          await notify("✅ Inserted “" + TARGET_SHEET_NAME + "” as “" + finalName1 + "”.");
        } catch (namedErr) {
          await notify("ℹ️ Named sheet insert failed (“" + TARGET_SHEET_NAME + "”). Falling back to all sheets…\nReason: " +
                       (namedErr && namedErr.message ? namedErr.message : String(namedErr)));
          var finalName2 = await insertAllSheetsFromBase64(base64, RENAMED_SHEET_NAME);
          await notify("✅ Inserted all sheets. Activated “" + finalName2 + "”.");
        }
      } catch (err) {
        console.error(err);
        await notify("❌ Create Template failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        try { event.completed(); } catch (_) {}
      }
    }

    async function createSolarTemplateAll(event) {
      try {
        ensureSupportOrThrow();
        await notify("⏳ Fetching template (all sheets) …");
        var base64 = await fetchTemplateBase64(TEMPLATE_URL);
        var finalName = await insertAllSheetsFromBase64(base64, RENAMED_SHEET_NAME);
        await notify("✅ Inserted all sheets. Activated “" + finalName + "”.");
      } catch (err) {
        console.error(err);
        await notify("❌ Create Template (All) failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        try { event.completed(); } catch (_) {}
      }
    }

    // Simple sanity check command
    async function addBlankSheet(event) {
      try {
        await Excel.run(async (context) => {
          var name = "EnerXL_Test";
          var ws = context.workbook.worksheets.add(name);
          ws.getRange("A1").values = [["✅ Command fired."]];
          ws.activate();
          await context.sync();
        });
        await notify("✅ Added a blank sheet named “EnerXL_Test”.");
      } catch (err) {
        await notify("❌ addBlankSheet failed: " + (err && err.message ? err.message : String(err)));
      } finally {
        try { event.completed(); } catch (_) {}
      }
    }

    // ---------------- Registration ----------------
    Office.onReady(function () {
      Office.actions.associate("createSolarTemplate", createSolarTemplate);
      Office.actions.associate("createSolarTemplateAll", createSolarTemplateAll);
      Office.actions.associate("addBlankSheet", addBlankSheet);
    });
  })();
  </script>
</head>
<body>
  <!-- Hidden host page for ExecuteFunction commands. Intentionally empty. -->
  <noscript>EnerXL requires JavaScript to run.</noscript>
</body>
</html>
